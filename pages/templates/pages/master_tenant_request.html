{% extends 'pages/base.html' %}
{% load static %}
{% block title %}{% if type == "tenant" %}ê¸°ì—… ë“±ë¡ ìš”ì²­{% else %}ê¸°ì—… ë“±ë¡{% endif %}{% endblock %}
{% block content %}
<style>
  .request-label{
    width: 180px;
  }
  .request-value{
    width: 200px !important;
    flex: none !important;
    /* text-align: right !important; */
  }
  .form-group-left{
    margin-bottom: 13px;
  }
</style>


<div class="page-title">
  <div style="display: flex; align-items: center;">
    <div class="gradient-bar"></div>
    <div>ê¸°ì—… ë“±ë¡ {% if type == "tenant" %}ìš”ì²­{% else %}{% endif %}</div>
  </div>

</div>


<div>
  <div class="info">
    <h3>í™”ë©´ ì„¤ëª…</h3>
    {% if type == "tenant" %}
      <p>Enterpriseì˜ ê²½ìš°ëŠ” ì§€ì • ì„œë²„ ì‘ì—…ì´ ì™„ë£Œëœ í›„ ì•ˆë‚´ì— ë”°ë¼ ì‚¬ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
      <p>EnterpriseëŠ” 20ì¸ ì´ìƒì¸ ê²½ìš°ì— ì„ íƒí•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    {% else %}
      <p>Teams ëŠ” ê¸°ì—…ì„ ë“±ë¡ í›„ ì‚¬ìš©ì ë“±ë¡í•˜ì—¬ ì‚¬ìš©í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
    {% endif %}
  </div>

  <!-- ìƒì„¸ì •ë³´ í¼ -->
  <div style="flex:40%;">
    <h3>LLM ìƒì„¸</h3>

    <form id="request-detail-form" enctype="multipart/form-data">
      <input name="type" value="{{ type }}" hidden>

      <div class="form-group-left">
        <label class="request-label">ì‚¬ìš© ëª¨ë¸:</label>
        <label class="request-value" id="usemodel" name="usermodel">{% if type == "tenant" %}Enterprise{% else %}Teams{% endif %}</label>
      </div>

      <div class="form-group-left"> 
        <label class="request-label">ì‚¬ìš©ììˆ˜:</label>
        <input class="request-value" style="text-align: right;" type="number" id="billingusercnt" name="billingusercnt" placeholder="ì˜ˆ: 10">
        <p style="margin-left: 10px;">ï¼Š ì‚¬ìš©ììˆ˜ëŠ” ì›” ë™ì•ˆ ì‚¬ìš© ê°€ëŠ¥í–ˆë˜ ì „ì²´ ì‚¬ìš©ìë¥¼ ì˜ë¯¸í•©ë‹ˆë‹¤.</p>
      </div>

      <div class="form-group-left">
        <label class="request-label">ìš”ê¸ˆ(ì›) / ì›”:</label>
        <input class="request-value" style="text-align: right;" type="text" id="price" name="price" value="{% if type == 'tenant' %}100,000{% else %}50,000{% endif %}" disabled>
      </div>

      <div class="form-group-left">
        <label class="request-label">LLM ì¶”ê°€ ì‚¬ìš© ì œí•œ ì—¬ë¶€:</label>
        <div class="request-value">
          <label><input type="radio" name="llmlimityn" value="false" checked> ë¯¸ì œí•œ</label>
          <label><input type="radio" name="llmlimityn" value="true"> ì œí•œ</label>
        </div>
      </div>

      <div class="form-group">
        <p style="margin-left:  80px;">ï¼Š ì œí•œ: ì›” ì¸ë‹¹ 100ë§Œ ì…ë ¥ í† í° ì´ˆê³¼ì‹œ LLM í”„ë¡¬í”„íŠ¸ ìˆ˜í–‰ì„ ì§„í–‰í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤.</p>
        <p style="margin-left:  80px;">ï¼Š ë¯¸ì œí•œ: ì´ˆê³¼ ì…ë ¥ í† í° ì‚¬ìš© ì‹œ 100ë§Œ í† í°ë‹¹ 5,000ì›/ì›” ì¶”ê°€ ë¹„ìš©ì„ ì²­êµ¬í•©ë‹ˆë‹¤.</p>
      </div>

      
      <div class="form-group-left">
        <div class="info-left" style="align-self: flex-start;">
          <h3>ê¸°ì—… ì •ë³´</h3>
          <!-- ê¸°ì—… ì •ë³´ ì‹œì‘ -->
          <div class="tenant-info">
            <div class="form-group-left">
              <label class="request-label">íšŒì‚¬(ë²•ì¸) ëª…ì¹­:</label>
              <div class="request-value">
                <input class="request-value" style="text-align: right;" type="text" id="tenantnm" name="tenantnm">
              </div>
            </div>

            {% if type == "tenant" %}
            <div class="form-group-left">
              <label class="request-label">ë²•ì¸(ì‚¬ì—…ì) ë“±ë¡ë²ˆí˜¸:</label>
              <div class="request-value">
                <input class="request-value" style="text-align: right;" type="text" id="bizregno" name="bizregno">
              </div>
            </div>

            <div style="margin-top: 10px;">
              <input type="file" id="bizregfile" name="bizregfile" style="display:none">

              <!-- í˜„ì¬ íŒŒì¼ ë° ì—…ë¡œë“œ ë²„íŠ¼ -->
              <div style="display:none; align-items:center; gap:10px;">
                <button type="button" id="upload-btn" class="icon-btn">
                <img src="{% static 'icons/upload.svg' %}" title="ì—…ë¡œë“œ" class="icon-img new-icon">
                </button>
                <span id="current-bizregfile">ì‚¬ì—…ì ë“±ë¡ì¦ ì‚¬ë³¸ íŒŒì¼ ì—†ìŒ</span>
              </div>
            </div>
            {% else %}
            {% endif %}
            {% if type != "tenant" %}
            <div class="form-group-left">
              <label>ê¸°ì—… ì´ë¯¸ì§€:</label>
              <!-- ìˆ¨ê²¨ì§„ ì‹¤ì œ íŒŒì¼ input -->
              <input type="file" name="iconfile" id="iconfile" style="display:none;">
              
              <!-- í˜„ì¬ í…œí”Œë¦¿ ë° ì—…ë¡œë“œ ë²„íŠ¼ -->
              <div style="display:flex; align-items:center; gap:10px;">
                <button type="button" id="icon-upload-btn" class="icon-btn">
                  <img src="{% static 'icons/upload.svg' %}" title="ì—…ë¡œë“œ" class="icon-img new-icon">
                </button>
                <span id="current-iconfile-name">ì´ë¯¸ì§€ íŒŒì¼ ì—†ìŒ</span>
              </div>
            </div>
            {% else %}
            {% endif %}
          </div>
        </div>
        <!-- ê¸°ì—… ì •ë³´ ì¢…ë£Œ -->

        <div class="info-right" style="align-self: flex-start; margin-left: 200px;">
          <h3>ì„œë¹„ìŠ¤ ë‹´ë‹¹ì ì •ë³´</h3>
          <!-- ì„œë¹„ìŠ¤ ë‹´ë‹¹ì ì •ë³´ ì‹œì‘ -->
          <div class="manager-info" >
            <div class="form-group-left">
              <label class="request-label">ì„±ëª…:</label>
              <div class="request-value">
                <input class="request-value" style="text-align: right;" type="text" id="managernm" name="managernm">
              </div>
            </div>

            {% if type == "tenant" %}
            <div class="form-group-left">
              <label class="request-label">ë¶€ì„œ:</label>
              <div class="request-value">
                <input class="request-value" style="text-align: right;" type="text" id="managerdepart" name="managerdepart">
              </div>
            </div>

            <div class="form-group-left">
              <label class="request-label">ì§ì±…:</label>
              <div class="request-value">
                <input class="request-value" style="text-align: right;" type="text" id="managerposition" name="managerposition">
              </div>
            </div>
            {% else %}
            {% endif %}

            <div class="form-group-left">
              <label class="request-label">ì´ë©”ì¼ì£¼ì†Œ:</label>
              <div class="request-value">
                <input class="request-value" style="text-align: right;" type="email" id="email" name="email">
              </div>
            </div>

            <div class="form-group-left">
              <label class="request-label">ì „í™”ë²ˆí˜¸:</label>
              <div class="request-value">
                <input class="request-value" style="text-align: right;" type="tel" id="telno" name="telno" placeholder="ìˆ«ìë§Œì…ë ¥">
              </div>
            </div>
            
          </div>
        </div>
        <!-- ì„œë¹„ìŠ¤ ë‹´ë‹¹ì ì •ë³´ ì¢…ë£Œ -->
      </div>

      
      <div class="button-group">
        <!-- ì €ì¥ ë²„íŠ¼ -->
        <button id="save-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/save.svg' %}" class="icon-img save-icon" title="ì €ì¥">
            <span class="icon-label">ì €ì¥</span>
          </div>  
        </button>
      </div>
      
    </form>
  </div>
</div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="formatLoading">
  <div class="loading-content">
    <div class="spinner"></div>
    <div id="loading-text" style="text-align: center;"></div>
    <div >ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>
  </div>
</div>

<script>
// ë¡œë”© ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜ë“¤
function showLoading() {
  const overlay = document.getElementById('formatLoading');
  const text = document.getElementById('loading-text');
  
  // ì˜¤ë²„ë ˆì´ í‘œì‹œ
  overlay.style.display = 'flex';
  text.textContent = 'ê¸°ì—… ìƒì„± ì¤‘'
}

function hideLoading() {
  const overlay = document.getElementById('formatLoading');
  const text = document.getElementById('loading-text');
  
  // ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
  overlay.style.display = 'none';
  text.textContent = '';
}

// =============================
// ê¸°ì—… ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
// =============================
const iconFileInput = document.getElementById("iconfile");
const iconUploadBtn = document.getElementById("icon-upload-btn");
const currentIconFileName = document.getElementById("current-iconfile-name");

if (iconUploadBtn && iconFileInput) {
  iconUploadBtn.addEventListener("click", () => {
    iconFileInput.click();
  });

  iconFileInput.addEventListener("change", () => {
    if (iconFileInput.files.length > 0) {
      currentIconFileName.textContent = iconFileInput.files[0].name;
    } else {
      currentIconFileName.textContent = "ì´ë¯¸ì§€ íŒŒì¼ ì—†ìŒ";
    }
  });
}

// ì‚¬ì—…ìë“±ë¡ë²ˆí˜¸ ìˆ«ìë§Œ ê°€ëŠ¥
const bizregno = document.getElementById('bizregno')

const tp = "{{type}}"

// ê¸°ì—…ì¼ ë•Œë§Œ ë™ì‘
if (tp == "tenant") {
  bizregno.addEventListener('change', function(e) {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
  });

  // ì‚¬ì—…ì ë“±ë¡ì¦ ì‚¬ë³¸ ì²¨ë¶€
    // ğŸ”¹ íŒŒì¼ ì—…ë¡œë“œ ë²„íŠ¼ ì»¤ìŠ¤í…€
  const fileInput = document.getElementById('bizregfile');
  const uploadBtn = document.getElementById('upload-btn');
  const currentBizregfile = document.getElementById('current-bizregfile');

  uploadBtn.addEventListener('click', () => fileInput.click());

  fileInput.addEventListener('change', () => {
    if (fileInput.files.length > 0) {
      currentBizregfile.textContent = fileInput.files[0].name;
    } else {
      currentBizregfile.textContent = "ì„ íƒëœ ë¬¸ì„œ ì—†ìŒ";
    }
  });

  // ì „í™”ë²ˆí˜¸ ì„¤ì •
  const telnoInput = document.getElementById("telno");

  telnoInput.addEventListener("input", (e) => {
      let value = e.target.value.replace(/[^0-9]/g, ""); // ìˆ«ìë§Œ í•„í„°

      // ì„œìš¸ 02 ì§€ì—­ë²ˆí˜¸
      if (value.startsWith("02")) {
          if (value.length <= 2) {
              e.target.value = value;
          } else if (value.length <= 6) {
              e.target.value = value.replace(/(\d{2})(\d{1,3})/, "$1-$2");
          } else if (value.length <= 10) {
              e.target.value = value.replace(/(\d{2})(\d{3})(\d{1,4})/, "$1-$2-$3");
          } else {
              e.target.value = value.replace(/(\d{2})(\d{4})(\d{4})/, "$1-$2-$3");
          }
      } else {
          // ì¼ë°˜ íœ´ëŒ€í° 010, 011, 016~019
          if (value.length <= 3) {
              e.target.value = value;
          } else if (value.length <= 6) {
              e.target.value = value.replace(/(\d{3})(\d{1,3})/, "$1-$2");
          } else if (value.length <= 10) {
              e.target.value = value.replace(/(\d{3})(\d{3})(\d{1,4})/, "$1-$2-$3");
          } else {
              e.target.value = value.replace(/(\d{3})(\d{4})(\d{1,4})/, "$1-$2-$3");
          }
      }
  });

}


// ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
const saveBtn = document.getElementById("save-btn");
if (saveBtn) {
  saveBtn.addEventListener("click", () => { 
    showLoading()
    const form = document.getElementById("request-detail-form");
    const formData = new FormData(form);

    fetch("{% url 'master_tenant_request_save' %}", {
      method: "POST",
      body: formData,
      headers: {
        "X-CSRFToken": getCookie("csrftoken")
      }
    })
    .then(res => res.json())
    .then(data => {
      if (data.result === "success") {
        if (data.type === "tenant"){
          alert("ê¸°ì—… ë“±ë¡ ìš”ì²­ì„ ì™„ë£Œ í•˜ì˜€ìŠµë‹ˆë‹¤..");
          hideLoading()
        } else if (data.type === "teams"){
          alert("ê¸°ì—… ë“±ë¡ í•˜ì˜€ìŠµë‹ˆë‹¤.")
          hideLoading()
        }
        // location.reload();
        window.location.href = "/";
      } else {
        alert("ê¸°ì—… ë“±ë¡ ìš”ì²­: " + (data.message || "ì„œë²„ ì˜¤ë¥˜"));
        hideLoading()
      }
    })
    .catch(err => {
      alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message);
      hideLoading()
    });
  });
}


function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>

{% endblock %}
