{% extends 'pages/base.html' %}
{% load static %}
{% load humanize %}
{% block title %}í™ˆ{% endblock %}

{% block content %}

<style>
.myinfo-label{ width: 200px; }
.tab-menu {
  display: flex;
  gap: 20px;
  border-bottom: 1px solid #ddd;
  margin-bottom: 20px;
}
.tab-menu button {
  background: none;
  border: none;
  padding: 10px 5px;
  font-size: 16px;
  cursor: pointer;
  border-bottom: 3px solid transparent;
}
.tab-menu button.active {
  border-bottom: 3px solid #163E64;
  font-weight: bold;
}
.tab-content { display: none; }
.tab-content.active { display: block; }

.edit-input {
  padding: 4px 8px;
  font-size: 14px;
  border: 1px solid #ccc;
  border-radius: 4px;
  width: 200px;
}

.save-btn {
  background-color: #163E64;
  color: #ffffff;
  border: none;
  padding: 6px 12px;
  font-size: 13px;
  font-weight: bold;
  border-radius: 4px;
  cursor: pointer;
  margin-left: 10px;
}
.save-btn:hover {
  background-color: #0f2c4a;
}
</style>

<div class="page-title">
  <div style="display: flex; align-items: center;">
    <div class="gradient-bar"></div>
    <div>My Page</div>
  </div>
</div>


{# --- íƒ­ ë©”ë‰´: ìœ ë£Œ ì‚¬ìš©ìë§Œ --- #}
{% if payment == "Y" %}
<div class="tab-menu">
  <button id="btn-my-tab" class="tab-btn active" onclick="openTab('my-tab')">My</button>
  <button id="btn-payment-tab" class="tab-btn" onclick="openTab('payment-tab')">ê²°ì œ</button> 
</div>
{% endif %}

{# --- My íƒ­ / ì¼ë°˜ í™”ë©´ ë‚´ìš© --- #}
<div id="my-tab" class="tab-content {% if payment == "Y" %}active{% else %}active{% endif %}">
    <h3>ê°œì¸ ì •ë³´</h3>
    <div style="margin-left: 50px; margin-bottom: 30px;">
        <div class = "form-group-left"> 
            <label class="myinfo-label">Email: </label>
            <span>{{ user_info.email }}</span>
        </div>
<!-- 
        <div class = "form-group-left"> 
            <label class="myinfo-label">ì‚¬ìš©ìëª…: </label>
            <span>{{ user_info.usernm }}</span>
        </div> -->

        <div class="form-group-left" style="display: flex; align-items: center; gap: 10px;">
            <label class="myinfo-label">ì‚¬ìš©ìëª…: </label>
            <form method="POST" action="{% url 'myinfo_update_username' %}">
                {% csrf_token %}
                <input type="text" name="usernm" value="{{ user_info.usernm }}" 
                    class="edit-input" style="width: 160px; flex: none;">
                <button type="submit" class="save-btn">ì €ì¥</button>
            </form>
        </div>

        <div class="form-group-left" style="display: flex; align-items: center; gap: 10px;">
            <label class="myinfo-label">ìš”ê¸ˆì œ: </label>
            <span class="fixed-width-text" style="width: 150px; display: inline-block;">
                {% if user_info.billingmodelcd == "Fr" %}Free{% elif user_info.billingmodelcd == "Pr" %}Pro{% elif user_info.billingmodelcd == "Te" %}Teams{% elif user_info.billingmodelcd == "En" %}Enterprise{% endif %}
            </span>
            {% if user_info.billingmodelcd == "Fr" %}
            <button class="save-btn" onclick="showPreparingMessage(event)">ì—…ê·¸ë ˆì´ë“œ</button>
            {% endif %}
        </div>

   
    </div>

    <h3>ì•½ê´€ ë™ì˜ ì—¬ë¶€</h3>
    <div style="margin-left: 50px; margin-bottom: 30px;">
        <div class = "form-group-left"> 
            <label class="myinfo-label">ì´ìš©ì•½ê´€ë™ì˜ (í•„ìˆ˜): </label>
            <span>{{ user_info.termsofuseyn|yesno:'âˆš,-' }}</span>
        </div>

        <div class = "form-group-left"> 
            <label class="myinfo-label">ê°œì¸ì •ë³´ìˆ˜ì§‘ë™ì˜ (í•„ìˆ˜): </label>
            <span>{{ user_info.userinfoyn|yesno:'âˆš,-' }}</span>
        </div>

        <div class = "form-group-left"> 
            <label class="myinfo-label">ë§ˆì¼€íŒ…ë™ì˜ (ì„ íƒ): </label>
            <span>{{ user_info.marketingyn|yesno:'âˆš,-' }}</span>
        </div>  
    </div>

    <h3>ì†Œì† ê¸°ì—…</h3>
    <div style="margin-left: 50px; margin-bottom: 10px; display: flex;">
        <div>
            <h4>í˜„ì¬</h4>
            <div style="margin-left: 50px; margin-bottom: 30px;">
                <div class = "form-group-left"> 
                    <label class="myinfo-label">ê¸°ì—…:</label>
                    <span>{{ tenants.tenantnm }}</span>
                </div>

                <div class = "form-group-left"> 
                    <label class="myinfo-label">ê¶Œí•œ:</label>
                    <span>{% if user_info.roleid == 1 %}ì¼ë°˜ìœ ì €{% elif user_info.roleid == 7 %}ê´€ë¦¬ì{% endif %}</span>
                </div>

                <div class = "form-group-left"> 
                    <label class="myinfo-label">ë“±ë¡ì¼:</label>
                    <span>{{ tenants.createdts|date:"Y-m-d H:i:s" }}</span>
                </div>

                <h4>ì°¸ì—¬ í”„ë¡œì íŠ¸</h4>
                    <table style = "width: 400px; margin-left: 20px;">
                        <thead>
                            <tr>
                                <th>í”„ë¡œì íŠ¸ëª…</th>
                                <th>ê¶Œí•œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for pu in projectusers %}
                            <tr>
                                <td>{{ pu.projectnm }}</td>
                                <td style="text-align: center;">{% if pu.rolecd == "M" %}Manager{% elif pu.rolecd == "U" %}User{% endif %}</td> 
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
            </div>
        </div>

        <div style="margin-left: 200px;">
            <h4>ì´ë ¥</h4>
            <div style="margin-left: 20px;">
                <div class = "form-group-left"> 
                    <label class="myinfo-label">{% if tenantnewusers %}ê¸°ì—… ë³€ê²½ ìš”ì²­{% else %}ë³€ê²½ ì‚¬í•­ ì—†ìŒ{% endif %}</label>
                </div>

                {% if tenantnewusers %}
                    <div class = "form-group-left"> 
                        <label class="myinfo-label">ê¸°ì—…:</label>
                        <span>{{ newtenants.tenantnm }}</span>
                    </div>

                    <div class = "form-group-left"> 
                        <label class="myinfo-label">ì§„í–‰ìƒíƒœ:</label>
                        <span>{% if tenantnewusers.approvecd == "A" %}ëŒ€ê¸°ì¤‘{% elif tenantnewusers.approvecd == "D" %}ìŠ¹ì¸ ê±°ì ˆ{% endif %}</span>
                    </div>

                    <div class = "form-group-left"> 
                        <label class="myinfo-label">ë¹„ê³ :</label>
                        <span>{% if tenantnewusers.approvecd == "A" %}-{% elif tenantnewusers.approvecd == "D" %}{{ tenantnewusers.approvenote }}{% endif %}</span>
                    </div>
                {% endif %}
            </div>
        </div>
    </div>
</div>

{# --- ê²°ì œ íƒ­: ìœ ë£Œ ì‚¬ìš©ìë§Œ --- #}
{% if payment == "Y" %}
<div id="payment-tab" class="tab-content">
  <!-- <h3>ê²°ì œ</h3> -->
    <div class="form-group-left" style="display: flex; align-items: center; gap: 10px;">
        <label class="myinfo-label">ìš”ê¸ˆì œ: </label>
        <span class="fixed-width-text" style="width: 150px; display: inline-block;">
            {% if user_info.billingmodelcd == "Pr" %}Pro{% elif user_info.billingmodelcd == "Te" %}Teams{% elif user_info.billingmodelcd == "En" %}Enterprise{% endif %}
        </span>
    </div>

    {% if user_info.billingmodelcd != "Pr" %}
    <div class="form-group-left" style="display: flex; align-items: center; gap: 10px;">
        <label class="myinfo-label">ê¸°ì—…ëª…: </label>
        <span class="fixed-width-text" style="width: 150px; display: inline-block;">
            {{ tenants.tenantnm }}
        </span>
    </div>

    <div class="form-group-left" style="display: flex; align-items: center; gap: 10px;">
        <label class="myinfo-label">ê³¼ê¸ˆ ì‚¬ìš©ììˆ˜: </label>
        <span class="fixed-width-text" style="width: 150px; display: inline-block;">
            {% if tenants.defaultyn|default:False %}
            -
            {% else %}
            {{ tenants.billingusercnt }}ëª…
            {% endif %}
        </span>
    </div>
    {% endif %}

    <div class="form-group-left" style="display: flex; align-items: center; gap: 10px;">
        <label class="myinfo-label">ê³¼ê¸ˆìµœì´ˆì‹œì‘ì¼: </label>
        <span class="fixed-width-text" style="width: 150px; display: inline-block;">
            {{ billmasters.billingfirstdt }}
        </span>
    </div>

    {% if user_info.billingmodelcd != "Pr" %}
    <form method="POST"
        action="{% url 'myinfo_update_contact' %}"
        enctype="multipart/form-data">

    {% csrf_token %}
    <input type="hidden" name="tenantid" value="{{ tenants.tenantid }}">

    <div class="form-group-left" style="display:flex; align-items:center; gap:10px;">
        <label class="myinfo-label">ë‹´ë‹¹ì ì´ë©”ì¼ / ì „í™”ë²ˆí˜¸: </label>

        {% if tenants.defaultyn|default:False %}
        <span>-</span>
        {% else %}
        <input type="email"
            name="decemail"
            value="{{ billmasters.decemail }}"
            class="edit-input"
            style="width: 150px; flex: none;"
            placeholder="ì´ë©”ì¼">

        <input type="text"
            name="dectelno"
            value="{{ billmasters.dectelno }}"
            class="edit-input"
            style="width: 150px; flex: none;"
            placeholder="ì „í™”ë²ˆí˜¸">

        {% endif %}
    </div>
    {% if not tenants.defaultyn|default:False %}
    <div class="form-group-left">
        <label>ê¸°ì—… ì´ë¯¸ì§€:</label>

        <input type="file" name="iconfile" id="iconfile" style="display:none;">

        <div style="display:flex; align-items:center; gap:10px;">
        <button type="button" id="icon-upload-btn" class="icon-btn">
            <img src="{% static 'icons/upload.svg' %}"
                title="ì—…ë¡œë“œ"
                class="icon-img new-icon">
        </button>

        <span id="current-iconfile-name">ì´ë¯¸ì§€ íŒŒì¼ ì—†ìŒ</span>
        </div>
    </div>
    
    <!-- ğŸ”¥ ë°˜ë“œì‹œ ì´ form ì•ˆ -->
    <button type="submit" class="save-btn">ì €ì¥</button>
    {% endif %}
    </form>
    {% endif %}


    <div style="margin-top: 20px;">
        <h4>ê³¼ê¸ˆì •ë³´</h4>
        <div style="margin-left: 50px;">
            <div class="form-group-left" style="display: flex; align-items: center; gap: 10px;">
                <label class="myinfo-label">ì´ìš©ê¸°ê°„: </label>
            {% if tenants.defaultyn|default:False %}
            -
            {% else %}
            {{ billdts.billstartdt }} ~ {{ billdts.billenddt }}
            {% endif %}
            </div>

            <div class="form-group-left" style="display: flex; align-items: center; gap: 10px;">
                <label class="myinfo-label">ì´ìš©ê°€ëŠ¥ í† í°: </label>
            {% if tenants.defaultyn|default:False %}
            -
            {% elif user_info.billingmodelcd != "Pr"  %}
            {{ billdts.inputtokencapa|intcomma }} ( {{ configs.inputtokencapa|intcomma }} * {{ tenants.billingusercnt }})
            {% else %}
            {{ billdts.inputtokencapa|intcomma }}
            {% endif %}
            </div>

            <div class="form-group-left" style="display: flex; align-items: center; gap: 10px;">
                <label class="myinfo-label">ì‹¤ì‚¬ìš© í† í°: </label>
            {% if tenants.defaultyn|default:False %}
            -
            {% else %}
            {{ billdts.inputtoken|intcomma }}
            {% endif %}
            </div>

            <div class="form-group-left" style="display: flex; align-items: center; gap: 10px;">
                <label class="myinfo-label">ì¶”ê°€ í† í°: </label>
            {% if tenants.defaultyn|default:False %}
            -
            {% else %}
            {{ billdts.overtokenm|intcomma }}
            {% endif %}
            </div>

            <div class="form-group-left" style="display: flex; align-items: center; gap: 10px;">
                <label class="myinfo-label">ì„œë¹„ìŠ¤ ê¸ˆì•¡: </label>
            {% if tenants.defaultyn|default:False %}
            -
            {% else %}
            {{ billdts.serviceamt|intcomma }}
            {% endif %}
            </div>

            <div class="form-group-left" style="display: flex; align-items: center; gap: 10px;">
                <label class="myinfo-label">ì¶”ê°€ ê¸ˆì•¡: </label>
            {% if tenants.defaultyn|default:False %}
            -
            {% else %}
            {{ billdts.addamt|intcomma }}
            {% endif %}
            </div>
        </div>
    </div>
</div>
{% endif %}

{% if messages %}
<div id="message-container"  style="margin-left:50px; margin-bottom:20px;">
  {% for message in messages %}
    <div style="padding:10px; border-radius:4px; 
                {% if message.tags == 'success' %}background-color:#d4edda; color:#155724;
                {% elif message.tags == 'error' %}background-color:#f8d7da; color:#721c24;{% endif %}">
      {{ message }}
    </div>
  {% endfor %}
</div>
{% endif %}


<script>
const iconFileInput = document.getElementById("iconfile");
const iconUploadBtn = document.getElementById("icon-upload-btn");
const currentIconFileName = document.getElementById("current-iconfile-name");

// ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ -> íŒŒì¼ ì„ íƒ
iconUploadBtn.addEventListener("click", () => {
  iconFileInput.click();
});

// íŒŒì¼ ì„ íƒ ì‹œ íŒŒì¼ëª… ë°”ë¡œ í‘œì‹œ
iconFileInput.addEventListener("change", () => {
  if (iconFileInput.files.length > 0) {
    currentIconFileName.textContent = iconFileInput.files[0].name;
    currentIconFileName.style.color = "black";
    currentIconFileName.style.textDecoration = "none";
    currentIconFileName.onclick = null; // ìƒˆ ì—…ë¡œë“œ íŒŒì¼ì´ë¯€ë¡œ ë‹¤ìš´ë¡œë“œëŠ” ì•„ì§ ì—†ìŒ
  } else {
    currentIconFileName.textContent = "ì´ë¯¸ì§€ íŒŒì¼ ì—†ìŒ";
    currentIconFileName.style.color = "black";
    currentIconFileName.style.textDecoration = "none";
    currentIconFileName.onclick = null;
  }
});

// í˜ì´ì§€ ë¡œë”© ì‹œ ê¸°ì¡´ ì´ë¯¸ì§€ í‘œì‹œ
document.addEventListener("DOMContentLoaded", () => {
  const iconFileName = "{{ tenants.iconfilenm|default:'' }}";
  const iconFileUrl = "{{ tenants.iconfileurl|default:'' }}";

  if (iconFileName && iconFileUrl) {
    currentIconFileName.textContent = iconFileName;
    currentIconFileName.style.color = "blue";
    currentIconFileName.style.textDecoration = "underline";
    currentIconFileName.style.cursor = "pointer";

    currentIconFileName.onclick = async (e) => {
      e.preventDefault();
      try {
        const res = await fetch(iconFileUrl);
        if (!res.ok) throw new Error("íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

        const blob = await res.blob();
        const url = window.URL.createObjectURL(blob);

        const a = document.createElement("a");
        a.href = url;
        a.download = iconFileName;
        document.body.appendChild(a);
        a.click();
        document.body.removeChild(a);
        window.URL.revokeObjectURL(url);
      } catch (err) {
        alert("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: " + err.message);
      }
    };
  } else {
    currentIconFileName.textContent = "ì´ë¯¸ì§€ íŒŒì¼ ì—†ìŒ";
    currentIconFileName.style.color = "black";
    currentIconFileName.style.textDecoration = "none";
    currentIconFileName.style.cursor = "default";
  }
});


  function openTab(tabId) {
    document.querySelectorAll(".tab-content").forEach(t => t.classList.remove("active"));
    document.querySelectorAll(".tab-btn").forEach(b => b.classList.remove("active"));

    document.getElementById(tabId).classList.add("active");
    document.getElementById("btn-" + tabId).classList.add("active");
  }

  // 10ì´ˆ í›„ ë©”ì‹œì§€ ì œê±°
  setTimeout(function() {
    const container = document.getElementById('message-container');
    if (container) {
      container.style.transition = "opacity 0.5s ease";
      container.style.opacity = 0;
      setTimeout(() => container.remove(), 500); // fade out í›„ ì œê±°
    }
  }, 3000); // 10000ms = 10ì´ˆ

function showPreparingMessage(event) {
    event.preventDefault(); // ë§í¬ ì´ë™ ë§‰ê¸°
    alert("í˜„ì¬ ê¸°ëŠ¥ì„ ì¤€ë¹„ ì¤‘ì…ë‹ˆë‹¤.\nì¡°ê¸ˆë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”");
}
</script>
{% endblock %}
