<style>
/* ë¡œê·¸ì¸ */
.login_base_modal_content {
    background: var(--white);
    padding: 30px 25px;
    border-radius: 12px;
    width: 360px;
    height: 410px;
    box-shadow: 0 8px 24px var(--black-shadow);
    text-align: center;
}

.alert {
  background: var(--white);
  padding: 30px 25px;
  border-radius: 12px;
  width: 200px;
  height: 22px;
  box-shadow: 0 8px 24px var(--black-shadow);
  text-align: center;
  background: var(--white);
  transition: opacity 0.5s;
}

.hidden {
  display: none;
}

.fadeout {
  opacity: 0;
}
</style>

<!-- ë¡œê·¸ì¸ -->
<div id="login_base_modal" class="base_modal_overlay" style="display: none;">
    <div class="login_base_modal_content" style="position: relative">
        <!-- âœ… ë‹«ê¸° ë²„íŠ¼ -->
        <button id="login_base_modal_close" style="
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            font-size: 20px;
            cursor: pointer;
        ">&times;</button>

        <h2 style="font-weight: bold;">GenQuery ë¡œê·¸ì¸</h2>

        <label class="modal_label">
            <span class="modal_span">ì´ë©”ì¼</span>
            <input type="email" id="login_email" placeholder="ì´ë©”ì¼" class="base_modal_input" style="width: 70%;" required/>
        </label>

        <label class="modal_label">
            <span class="modal_span">ë¹„ë°€ë²ˆí˜¸</span>
            <input type="password" id="login_password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="base_modal_input" style="width: 70%;" required/>
        </label>
   
        <!-- ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • í† ê¸€ ë²„íŠ¼ -->
        <button id="toggle-reset" class="btn btn-save" style="margin-right: 20px;">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •</button>

        <button id="login_submit" class="btn btn-primary" style="margin-top: 8%" disabled>ë¡œê·¸ì¸</button>
              
        <!-- ì²˜ìŒì—ëŠ” ìˆ¨ê²¨ì§„ ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • í¼ -->
        <div id="reset-form" style="display:none; margin-top: 20px;">
          <form id="resetForm">
            {% csrf_token %}
            <label>ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼</label>
            <input type="email" id="reset_email" name="reset_email" required placeholder="ì´ë©”ì¼ ì…ë ¥">
            <button type="submit" class="btn btn-secondary" style="margin-top: 10px;">ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ì´ë©”ì¼ ì „ì†¡</button>
          </form>
          <div id="resetAlert" class="alert" style="display:none; margin-top:10px;"></div>
        </div>

        {% if messages %}
          <ul class="form-error" style="margin-top: 20px; padding-left: 20px;">
            {% for message in messages %}
              <li>{{ message }}</li>
            {% endfor %}
          </ul>
        {% endif %}      
    </div>
</div>

<div id="loginAlert" class="base_modal_overlay" style="display: none;">
  <div id="loginAlertContent" class="alert" style="position: relative;">
  </div>
</div>

<script>
// ë¡œê·¸ì¸ ëª¨ë‹¬
function show_login_base_modal(page){
    flag = page
    // console.log(flag)
    document.getElementById("login_base_modal").style.display = "flex";
}
// ë¡œê·¸ì¸ ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
document.getElementById('login_submit').addEventListener('click', async () => {
    const email = document.getElementById('login_email').value.trim();
    const password = document.getElementById('login_password').value;

    if (!email) {
      alert('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    if (!password) {
      alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }

    const formData = new FormData();
    formData.append('email', email);
    formData.append('password', password);

    const btn = document.getElementById('login_submit');
    btn.disabled = true;
    btn.textContent = 'ë¡œê·¸ì¸ ì¤‘...';

    try {
      const response = await fetch('/login/', {
        method: 'POST',
        credentials: "include",   // ğŸ‘ˆ ì—¬ê¸°
        headers: { 'X-CSRFToken': csrftoken },
        body: formData
      });
      const data = await response.json();
      
      // console.log(data)

      if (data.result === 'success') {
        // alert(data.message || 'ë¡œê·¸ì¸ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        
        const alertBox = document.getElementById("loginAlert");
        const alertContent = document.getElementById("loginAlertContent");

        // í‘œì‹œ
        // alertBox.classList.remove("hidden");
        alertBox.style.display = "flex";
        alertContent.textContent = "ë¡œê·¸ì¸ì´ ì™„ë£Œ ë˜ì—ˆìŠµë‹ˆë‹¤!"
        document.getElementById("login_base_modal").style.display = "none";

        // 1ì´ˆ í›„ ì„œì„œíˆ ì‚¬ë¼ì§
        setTimeout(() => {
          alertBox.classList.add("fadeout");

          // ì• ë‹ˆë©”ì´ì…˜ í›„ ì™„ì „íˆ ìˆ¨ê¹€ ì²˜ë¦¬
          setTimeout(() => {
            alertBox.style.display = "none";
            alertBox.classList.remove("fadeout");
            alertContent.textContent = "";
            location.reload();
          }, 500);

        }, 1000);
        
      } else {
        alert(data.message || 'ë¡œê·¸ì¸ ì‹¤íŒ¨');
      }
    } catch (error) {
        alert('ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
        // console.log(error)
    } finally {
      btn.disabled = false;
      btn.textContent = 'ë¡œê·¸ì¸';
    }
  });

// ëª¨ë‹¬ ê´€ë ¨ ì´ë²¤íŠ¸
document.addEventListener("DOMContentLoaded", function () {
  ////////// Login ì˜ì—­ ì‹œì‘
  // login ëª¨ë‹¬ ë‹«ê¸°
  const login_base_closeBtn = document.getElementById("login_base_modal_close");
  const login_base_modal = document.getElementById("login_base_modal");
  login_base_closeBtn.addEventListener("click", function () {
      login_base_modal.style.display = "none";
      document.getElementById("login_email").value = '';
      document.getElementById("login_password").value = '';
      document.getElementById("login_submit").disabled = true;
  });

  // ë¡œê·¸ì¸ ì˜ì—­
  const login_emailInput = document.getElementById('login_email');
  const login_passwordInput = document.getElementById('login_password');
  const loginBtn = document.getElementById('login_submit');

  // ë¡œê·¸ì¸ ì˜ì—­ -> ì´ë©”ì¼ ì…ë ¥ í›„ ì—”í„° â†’ ë¹„ë°€ë²ˆí˜¸ë¡œ í¬ì»¤ìŠ¤ ì´ë™
  login_emailInput.addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      login_passwordInput.focus();
    }
  });

  // ë¡œê·¸ì¸ ì˜ì—­ -> ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í›„ ì—”í„° â†’ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
  login_passwordInput.addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      if (!loginBtn.disabled) {
        loginBtn.click();
      }
    }
  });

  // ë¡œê·¸ì¸ ë²„íŠ¼ í™œì„±í™”
  const login_submitBtn = document.getElementById("login_submit");
  const login_email = document.getElementById("login_email");
  const login_password = document.getElementById("login_password");

  function login_validateForm() {
      const email_fill = login_email.value.trim().length > 0;
      const password_fill = login_password.value.trim().length > 0;

      const allValid = email_fill && password_fill

      login_submitBtn.disabled = !allValid;
  }
  // ë¡œê·¸ì¸ ì´ë²¤íŠ¸ ì—°ê²°
  login_email.addEventListener("input", login_validateForm);
  login_password.addEventListener("input", login_validateForm);
  
  function more_info_validateForm() {
    const nameFilled = nameInput.value.trim().length > 0;
    const phoneFilled = phoneInput.value.trim().length > 0;
    const ageChecked = ageCheck.checked;
    const termsChecked = termsCheck.checked;
    
    const allValid = nameFilled && phoneFilled && ageChecked && termsChecked;

    info_submit.disabled = !allValid;
  }
  ////////// Login ì˜ì—­ ì¢…ë£Œ



  document.getElementById('toggle-reset').addEventListener('click', function () {
    const form = document.getElementById('reset-form');
    if (form.style.display === 'none') {
      form.style.display = 'block';
      this.textContent = 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì • ë‹«ê¸°';
    } else {
      form.style.display = 'none';
      this.textContent = 'ë¹„ë°€ë²ˆí˜¸ ì¬ì„¤ì •';
    }
  });
const resetForm = document.getElementById('resetForm');
const resetEmail = document.getElementById('reset_email');
const resetAlert = document.getElementById('resetAlert');

resetForm.addEventListener("submit", async function(e){
    e.preventDefault();
    const email = resetEmail.value.trim();
    if(!email) {
        resetAlert.textContent = "ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.";
        resetAlert.style.display = "block";
        return;
    }

    try {
        const res = await fetch("{% url 'send_reset_email' %}", {
            method: "POST",
            credentials: "include",   // ğŸ‘ˆ ì—¬ê¸°
            headers: {
                "Content-Type": "application/json",
                "X-CSRFToken": csrftoken
            },
            body: JSON.stringify({email: email})
        });
        const data = await res.json();

        resetAlert.textContent = data.messages;
        resetAlert.style.display = "block";

        setTimeout(() => {
            resetAlert.style.display = "none";
            document.getElementById("login_base_modal").style.display = "none"; // ëª¨ë‹¬ ë‹«ê¸°
        }, 2000); // 2ì´ˆ í›„ ìë™ ë‹«ê¸°

    } catch(err) {
        resetAlert.textContent = "ì„œë²„ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.";
        resetAlert.style.display = "block";
        console.error(err);
    }
});


});

</script>