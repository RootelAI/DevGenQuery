{% extends 'pages/base.html' %}
{% load static %}
{% block title %}RAG 파일{% endblock %}

{% block content %}

<div class="page-title">
  <div style="display: flex; align-items: center;">
    <div class="gradient-bar"></div>
    <div>RAG 파일</div>
  </div>
</div>

<div style="display: flex; gap: 20px; min-height: 80%;">
  <!-- 왼쪽 -->
  <div style="flex: 2;" >
    <h3>파일 목록</h3>
    <div class="table-container">
      <table class="table table-bordered table-sm">
        <thead>
          <tr>
            <th style="width:  8%;">마스터 명</th>
            <th style="width:  8%;">버전</th>
            <th style="width:  8%;">파일 명</th>
            <th style="width:  8%;">파일 상태</th>
            <th style="width:  8%;">리비전타입</th>
            <th style="width:  8%;">대체파일</th>
            <th style="width:  8%;">승인일</th>
            <th style="width:  8%;">유효일</th>
            <th style="width:  8%;">폐기일</th>
            <th style="width:  8%;">변경사유</th>
            <th style="width:  8%;">처리구분</th>
            <th style="width:  8%;">처리일시</th>
          </tr>
        </thead>
        <tbody>
          {% for file in files %}
          <tr data-filecd="{{ file.filecd }}"
              data-filemastercd="{{ file.filemastercd }}"
              data-filemasternm="{{ file.filemasternm }}"              
              data-version="{{ file.version }}"
              data-filenm="{{ file.filenm }}"
              data-fileextension="{{ file.fileextension }}"
              data-filestatus="{{ file.filestatus }}"
              data-filestatusnm="{{ file.filestatusnm }}"
              data-revisiontype="{{ file.revisiontype }}"
              data-revisiontypenm="{{ file.revisiontypenm }}"
              data-supersedes_filecd="{{ file.supersedes_filecd }}"
              data-supersedes_filenm="{{ file.supersedes_filenm }}"
              data-approval_date="{{ file.approval_date }}"
              data-effective_date="{{ file.effective_date }}"
              data-obsolete_date="{{ file.obsolete_date }}"
              data-change_reason="{{ file.change_reason }}"
              data-processcd="{{ file.processcd }}"
              data-processdts="{{ file.processdts }}"
              data-creator="{{ file.creator }}"
              data-creatornm="{{ file.creatornm }}"
              data-createdts="{{ file.createdts }}"
              >
              <td class="info" style="text-align: center;"><span>{{file.filemasternm}}</span></td>
              <td class="info" style="text-align: center;"><span>{{file.version}}</span></td>
              <td class="info" style="text-align: center;"><span>{{file.filenm}}</span></td>
              <td class="info" style="text-align: center;"><span>{{file.filestatusnm}}</span></td>
              <td class="info" style="text-align: center;"><span>{{file.revisiontypenm}}</span></td>
              <td class="info" style="text-align: center;"><span>{{file.supersedes_filenm}}</span></td>
              <td class="info" style="text-align: center;"><span>{{file.approval_date|default_if_none:''}}</span></td>
              <td class="info" style="text-align: center;"><span>{{file.effective_date|default_if_none:''}}</span></td>
              <td class="info" style="text-align: center;"><span>{{file.obsolete_date|default_if_none:''}}</span></td>
              <td class="info" style="text-align: center;"><span>{{file.change_reason}}</span></td>
              <td class="info" style="text-align: center;"><span>
                {% if file.processcd == 'Y' %}
                    처리
                {% elif file.processcd == 'D' %}
                    삭제
                {% else %}
                    미처리
                {% endif %}
              </span></td>
              <td class="info"><span>{{file.processdts|default_if_none:''}}</span></td>
          </tr>
          {% empty %}
          <tr>
              <td colspan="12" class="text-center text-muted py-4">등록된 파일이 없습니다.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- 오른쪽 -->
  <div style="flex: 0.5; padding-left: 20px;">
    <h3>파일 상세</h3>
    <form id="files-detail-form" enctype="multipart/form-data">
      <input id="filecd" name="filecd" type="text" hidden>
      
      <div class="form-group-left">
        <label>마스터 명:</label>
        <select id="filemasternm" name="filemasternm" required>
          <option value="" selected disabled>마스터 를 선택하세요</option>
          {% for filemaster in filemasters %}
            <option value="{{ filemaster.filemastercd }}">{{ filemaster.filemasternm }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group-left">
        <label>버전명:</label>
        <input id="version" name="version" type="text" placeholder="v1.0">
      </div>

      <div class="form-group-left">
        <label>파일명:</label>
        <input id="filenm" name="filenm" type="text" disabled>
      </div>
      
      <div class="form-group-left">
        <label>파일상태:</label>
        <select id="filestatus" name="filestatus" required>
          <option value="" selected disabled>파일상태 를 선택하세요</option>
          {% for filestat in filestatus %}
            <option value="{{ filestat.valuecd }}">{{ filestat.valuenm }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="form-group-left">
        <label>리비전타입:</label>
        <select id="revisiontype" name="revisiontype" required>
          <option value="" selected disabled>리비전타입 을 선택하세요</option>
          {% for revisiontype in revisiontypes %}
            <option value="{{ revisiontype.valuecd }}">{{ revisiontype.valuenm }}</option>
          {% endfor %}
        </select>
      </div>
      
      <div class="form-group-left">
        <label>이전 파일:</label>
        <select id="supersedes_filecd" name="supersedes_filecd" required>
          <option value="" selected disabled>이전 파일 을 선택하세요</option>
        </select>
      </div>

      <div class="form-group-left">
        <label>승인일:</label>
        <input id="approval_date" name="approval_date" type="date">
      </div>

      <div class="form-group-left">
        <label>유효일:</label>
        <input id="effective_date" name="effective_date" type="date">
      </div>

      <div class="form-group-left">
        <label>폐기일:</label>
        <input id="obsolete_date" name="obsolete_date" type="date">
      </div>

      <div class="form-group-left">
        <label>변경사유:</label>
        <input id="change_reason" name="change_reason" type="text">
      </div>

      <div class="form-group-left">
        <label>작성자:</label>
        <input id="creatornm" name="creatornm" type="text" disabled>
      </div>

      <!-- 파일 첨부 필드 추가 -->
      <div class="form-group-left">
        <label>파일 첨부:</label>
        <input id="file-upload" name="file" type="file" accept=".pdf,.docx,.txt,.xlsx,.pptx">
        <small style="display: block; margin-top: 5px; color: #666;">
          선택된 파일: <span id="file-name">없음</span>
        </small>
      </div>

      <div class="button-group">
        <button id="reset-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/new.svg' %}" class="icon-img new-icon" title="신규">
            <span class="icon-label">신규</span>
          </div> 
        </button>

        <button id="save-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/save.svg' %}" class="icon-img save-icon" title="저장">
            <span class="icon-label">저장</span>
          </div>  
        </button>

        <button id="delete-btn" type="button" class="icon-btn" disabled>
          <div class="icon-wrapper">
            <img src="{% static 'icons/delete.svg' %}" class="icon-img del-icon" title="삭제">
            <span class="icon-label">삭제</span>
          </div>   
        </button>
      </div>
      
    </form>
  </div>
</div>

<script>
// 전체 파일 목록을 JavaScript 변수로 저장
const allFiles = [
  {% for file in files %}
  {
    filecd: "{{ file.filecd }}",
    filenm: "{{ file.filenm }}",
    filemastercd: "{{ file.filemastercd }}",
    fileextension: "{{ file.fileextension }}"
  }{% if not forloop.last %},{% endif %}
  {% endfor %}
];

// 이전 파일 드롭다운 업데이트 함수
function updateSupersedesDropdown(filemastercd = null, excludeFilecd = null) {
  const select = document.getElementById('supersedes_filecd');
  
  // 기존 옵션 모두 제거 (첫 번째 placeholder 옵션 제외)
  while (select.options.length > 1) {
    select.remove(1);
  }
  
  // 필터링된 파일 목록으로 옵션 추가
  allFiles.forEach(file => {
    // filemastercd 필터링 (선택된 마스터의 파일만)
    const matchesMaster = !filemastercd || file.filemastercd === filemastercd;
    // excludeFilecd가 있으면 해당 파일은 제외
    const notExcluded = !excludeFilecd || file.filecd !== excludeFilecd;
    
    if (matchesMaster && notExcluded) {
      const option = document.createElement('option');
      option.value = file.filecd;
      option.textContent = file.filenm;
      select.appendChild(option);
    }
  });
}


// 페이지 로드 시 초기화
window.addEventListener('load', function() {
  document.getElementById("files-detail-form").reset();
  updateSupersedesDropdown(); // 전체 목록 표시
});

// 마스터 명 선택 변경 시 이전 파일 드롭다운 업데이트
document.getElementById('filemasternm').addEventListener('change', function() {
  const selectedMasterCd = this.value;
  const currentFilecd = document.getElementById('filecd').value;
  
  // 선택된 마스터에 해당하는 파일만 표시 (현재 파일 제외)
  updateSupersedesDropdown(selectedMasterCd, currentFilecd);
  
  // 이전에 선택된 값이 필터링된 목록에 없으면 초기화
  const supersedesSelect = document.getElementById('supersedes_filecd');
  const currentValue = supersedesSelect.value;
  const isValueInList = Array.from(supersedesSelect.options).some(opt => opt.value === currentValue);
  
  if (!isValueInList) {
    supersedesSelect.value = '';
  }
});

// 테이블 행 클릭 시
document.querySelectorAll("tbody tr[data-filecd]").forEach(row => {
  row.addEventListener("click", function () {
    const currentFilecd = row.dataset.filecd;
    const currentMastercd = row.dataset.filemastercd;
    
    // 폼 필드 채우기
    document.getElementById('filecd').value = row.dataset.filecd;
    document.getElementById("filemasternm").value = row.dataset.filemastercd;
    document.getElementById("version").value = row.dataset.version;
    document.getElementById("filenm").value = row.dataset.filenm;
    document.getElementById("filestatus").value = row.dataset.filestatus;
    document.getElementById("revisiontype").value = row.dataset.revisiontype;
    document.getElementById("supersedes_filecd").value = row.dataset.supersedes_filecd;
    document.getElementById("approval_date").value = row.dataset.approval_date;
    document.getElementById("effective_date").value = row.dataset.effective_date;
    document.getElementById("obsolete_date").value = row.dataset.obsolete_date;
    document.getElementById("change_reason").value = row.dataset.change_reason;
    document.getElementById("creatornm").value = row.dataset.creatornm;

    // 이전 파일 드롭다운 업데이트 (같은 마스터의 파일만, 현재 파일 제외)
    updateSupersedesDropdown(currentMastercd, currentFilecd);
    
    // 기존 이전 파일 값 설정
    document.getElementById("supersedes_filecd").value = row.dataset.supersedes_filecd;

    // 선택된 행 강조
    document.querySelectorAll("tbody tr").forEach(r => r.classList.remove('selected-row'));
    row.classList.add('selected-row');
  });
});

// 파일 선택 시 파일명 표시
document.getElementById('file-upload').addEventListener('change', function(e) {
  const fileName = e.target.files[0] ? e.target.files[0].name : '없음';
  document.getElementById('file-name').textContent = fileName;
});

// 초기화 버튼
document.getElementById("reset-btn").addEventListener("click", () => {
  document.getElementById("files-detail-form").reset();
  document.getElementById("file-name").textContent = "없음";
  
  // 이전 파일 드롭다운 전체 목록으로 복원
  updateSupersedesDropdown();
  
  document.querySelectorAll("tbody tr").forEach(r => r.classList.remove("selected-row"));
});

// 저장 버튼
document.getElementById("save-btn").addEventListener("click", () => {
  const form = document.getElementById("files-detail-form");
  const formData = new FormData(form);
  
  // 파일이 선택되었는지 확인
  const fileInput = document.getElementById('file-upload');
  if (fileInput.files.length > 0) {
    formData.append('file', fileInput.files[0]);
  }

  // 로딩 표시 (선택사항)
  const saveBtn = document.getElementById("save-btn");
  const originalText = saveBtn.querySelector('.icon-label').textContent;
  saveBtn.querySelector('.icon-label').textContent = '저장중...';
  saveBtn.disabled = true;

  fetch("{% url 'master_rag_files_save' %}", {
    method: "POST",
    credentials: "include", 
    body: formData,
    headers: {
      "X-CSRFToken": getCookie("csrftoken")
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === "success") {
      alert(data.message);
      location.reload();
    } else {
      alert("저장 실패: " + (data.message || "서버 오류"));
      saveBtn.querySelector('.icon-label').textContent = originalText;
      saveBtn.disabled = false;
    }
  })
  .catch(err => {
    alert("오류 발생: " + err.message);
    saveBtn.querySelector('.icon-label').textContent = originalText;
    saveBtn.disabled = false;
  });
});

// 삭제 버튼
document.getElementById("delete-btn").addEventListener("click", () => {
  const filecd = document.getElementById("filecd").value;
  const filenm = document.getElementById("filenm").value;
  
  if (!filecd) {
    alert("삭제할 파일을 선택하세요.");
    return;
  }

  if (!confirm(`"${filenm}" 파일을 정말 삭제하시겠습니까?\n(Azure Blob Storage의 파일도 함께 삭제됩니다)`)) {
    return;
  }

  // 로딩 표시
  const deleteBtn = document.getElementById("delete-btn");
  const originalText = deleteBtn.querySelector('.icon-label').textContent;
  deleteBtn.querySelector('.icon-label').textContent = '삭제중...';
  deleteBtn.disabled = true;

  fetch("{% url 'master_rag_files_delete' %}", {
    method: "POST",
    credentials: "include", 
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify({ filecd: filecd })
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === "success") {
      alert(data.message);
      location.reload();
    } else {
      alert("삭제 실패: " + (data.message || "서버 오류"));
      deleteBtn.querySelector('.icon-label').textContent = originalText;
      deleteBtn.disabled = false;
    }
  })
  .catch(error => {
    alert("오류 발생: " + error.message);
    deleteBtn.querySelector('.icon-label').textContent = originalText;
    deleteBtn.disabled = false;
  });
});

// 쿠키 정보
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

</script>

{% endblock %}