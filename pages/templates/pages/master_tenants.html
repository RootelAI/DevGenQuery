{% extends 'pages/base.html' %}
{% load static %}
{% block title %}ê¸°ì—… ê´€ë¦¬{% endblock %}

{% block content %}
<div class="page-title">
  <div style="display: flex; align-items: center;">
    <div class="gradient-bar"></div>
    <div>ê¸°ì—… ê´€ë¦¬</div>
  </div>

</div>


<div style="display: flex; gap: 20px; min-height: 80%;">
  <!-- ì™¼ìª½ -->
  <div style="flex: 1.5;" >
    <h3>ê¸°ì—… ëª©ë¡</h3>
    <div class="table-container">
      <table class="table table-bordered table-sm" id="tenants-table">
        <thead>
          <tr>
            <th style="width: 50%;">ê¸°ì—…ëª…</th>
            <th style="width: 20%;">ìš”ê¸ˆì œ</th>
            <th class="info"  style="width: 10%;">ì‚¬ìš©</th>
            <th class="info"  style="width:20%;">ìƒì„±ì¼ì‹œ</th>
            <!-- <th class="info"  style="width:10%"></th> -->
          </tr>
        </thead>
        <tbody>
          {% for tenant in tenants %}
          <tr data-tenantid="{{ tenant.tenantid }}"
              data-tenantnm="{{ tenant.tenantnm }}"
              data-useyn="{{ tenant.useyn }}"
              data-creator="{{ tenant.creator }}"
              data-creatornm="{{ tenant.creatornm}}"
              data-createdts="{{ tenant.createdts }}"  
              data-billingmodelcd="{{ tenant.billingmodelcd }}"        
              data-billingusercnt="{{ tenant.billingusercnt|default:'' }}"
              data-email="{{ tenant.decemail }}"
              data-telno="{{ tenant.dectelno }}"
              data-llmlimityn="{% if tenant.llmlimityn %}True{% else %}False{% endif %}"
              data-iconfilenm="{{ tenant.iconfilenm|default:'' }}"
              data-iconfileurl="{{ tenant.iconfileurl|default:'' }}"
              >
              <td>{{ tenant.tenantnm }}
              </td>
              <td class="info">
                  {% if tenant.billingmodelcd == "Pr" %}<span>Pro</span>
                  {% elif tenant.billingmodelcd == "Te" %}<span>Teams</span>
                  {% elif tenant.billingmodelcd == "En" %}<span>Enterprise</span>
                  {% else %}<span>Free</span>
                  {% endif %}
              </td>
              <td class="info" style="text-align: center;">
                  {% if tenant.useyn %}<span>âœ”</span>
                  {% endif %}
              </td>
              <td class="info"><span>{{tenant.createdts}}</span></td>
              <!-- <td class="info"><button class="btn-tbl btn-primary tenants-select-btn" type="button">ì„ íƒ</button></td> -->
          </tr>
          {% empty %}
          <tr>
              <td colspan="4" class="text-center text-muted py-4">ë“±ë¡ëœ ê¸°ì—…ì´ ì—†ìŠµë‹ˆë‹¤.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>

  </div>

  <!-- ì˜¤ë¥¸ìª½ -->
  <div style="flex: 1.5; padding-left: 20px;">
    <h3>ê¸°ì—… ìƒì„¸</h3>
    <form id="tenants-detail-form" enctype="multipart/form-data">
      <input id="tenantid" name="tenantid" type="text" hidden>
      
      <div class="form-group-left">
        <label>ê¸°ì—…ëª…:</label>
        <input id="tenantnm" name="tenantnm" type="text">
      </div>

      <div class="form-group-left" style = "display: block;">
        <label>ì‚¬ìš©:</label>
        <input id="useyn" name="useyn" type="checkbox" style="margin-left: 50px;">
      </div>

      <div class="form-group-left">
        <label>ìš”ê¸ˆì œ:</label>
        <label><input type="radio" name="billingmodelcd" value="Fe" id="billingmodelcd-Fr">Free</label>
        <label><input type="radio" name="billingmodelcd" value="Pr" id="billingmodelcd-Pr">Pro</label>
        <label><input type="radio" name="billingmodelcd" value="Te" id="billingmodelcd-Te">Teams</label>
        <label><input type="radio" name="billingmodelcd" value="En" id="billingmodelcd-En">Enterprise</label>
      </div>
      
      <div class = "form-group-left"> 
        <label>ì‚¬ìš©ììˆ˜:</label>
        <input type="number" name="billingusercnt" id="billingusercnt">
      </div>

      <div class = "form-group"> 
        <label>LLMì‚¬ìš©ì œí•œì—¬ë¶€:</label>
        <input type="checkbox" name="llmlimityn" id="llmlimityn">
      </div>

      <div class="form-group-left">
        <label>ì´ë©”ì¼ì£¼ì†Œ:</label>
        <input id="email" name="email" type="text">
      </div>

      <div class="form-group-left">
        <label>ì „í™”ë²ˆí˜¸:</label>
        <input id="telno" name="telno" type="text">
      </div>

      <div class="form-group-left">
        <label>ê¸°ì—… ì´ë¯¸ì§€:</label>
        <!-- ìˆ¨ê²¨ì§„ ì‹¤ì œ íŒŒì¼ input -->
        <input type="file" name="iconfile" id="iconfile" style="display:none;">
        
        <!-- í˜„ì¬ í…œí”Œë¦¿ ë° ì—…ë¡œë“œ ë²„íŠ¼ -->
        <div style="display:flex; align-items:center; gap:10px;">
          <button type="button" id="icon-upload-btn" class="icon-btn">
            <img src="{% static 'icons/upload.svg' %}" title="ì—…ë¡œë“œ" class="icon-img new-icon">
          </button>
          <!-- íŒŒì¼ëª… í‘œì‹œ + ë‹¤ìš´ë¡œë“œ ê°€ëŠ¥ -->
          <span id="current-iconfile-name" style="cursor:pointer; text-decoration: underline; color: blue;">
            ì´ë¯¸ì§€ íŒŒì¼ ì—†ìŒ
          </span>
        </div>
      </div>
      
      <div class="form-group-left">
        <label>ìƒì„±ì:</label>
        <input id="creator" name="creator" type="text" disabled>
      </div>

      <div class="form-group-left">
        <label>ìƒì„±ì¼ì‹œ:</label>
        <input id="createdts" name="createdts" type="text" disabled>
      </div>

      <div class="button-group">
        <button id="reset-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/new.svg' %}" class="icon-img new-icon" title="ì‹ ê·œ">
            <span class="icon-label">ì‹ ê·œ</span>
          </div>   
        </button>

        <!-- ì €ì¥ ë²„íŠ¼ -->
        <button id="save-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/save.svg' %}" class="icon-img save-icon" title="ì €ì¥">
            <span class="icon-label">ì €ì¥</span>
          </div>  
        </button>

        <!-- ì‚­ì œ ë²„íŠ¼ -->
        <button id="delete-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/delete.svg' %}" class="icon-img del-icon" title="ì‚­ì œ">
            <span class="icon-label">ì‚­ì œ</span>
          </div>
        </button>
      </div>

      <div id="nav-buttons" class="button-group"  style="display: none;">
        <button id="btn-tenant-projects" class="btn btn-link">í”„ë¡œì íŠ¸ ì„¤ì • &#x279C;</button>
        <button id="btn-tenant-users" class="btn btn-link">ê¸°ì—… ì‚¬ìš©ì ì„¤ì • &#x279C;</button>           
      </div>


    </form>
  </div>
</div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="formatLoading">
  <div class="loading-content">
    <div class="spinner"></div>
    <div id="loading-text" style="text-align: center;"></div>
    <div >ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>
  </div>
</div>

<script>
// =============================
// ê¸°ì—… ì´ë¯¸ì§€ ì—…ë¡œë“œ ì²˜ë¦¬
// =============================
const iconFileInput = document.getElementById("iconfile");
const iconUploadBtn = document.getElementById("icon-upload-btn");
const currentIconFileName = document.getElementById("current-iconfile-name");

// ì—…ë¡œë“œ ë²„íŠ¼ í´ë¦­ -> íŒŒì¼ ì„ íƒ
iconUploadBtn.addEventListener("click", () => {
  iconFileInput.click();
});

// íŒŒì¼ ì„ íƒ ì‹œ íŒŒì¼ëª… ë°”ë¡œ í‘œì‹œ
iconFileInput.addEventListener("change", () => {
  if (iconFileInput.files.length > 0) {
    currentIconFileName.textContent = iconFileInput.files[0].name;
    currentIconFileName.onclick = null; // ìƒˆ ì—…ë¡œë“œ íŒŒì¼ì´ë¯€ë¡œ ë‹¤ìš´ë¡œë“œëŠ” ì•„ì§ ì—†ìŒ
  } else {
    currentIconFileName.textContent = "ì´ë¯¸ì§€ íŒŒì¼ ì—†ìŒ";
    currentIconFileName.onclick = null;
  }
});

// === ì„ íƒ í–‰ í‘œì‹œìš© ë³€ìˆ˜ ===
let selectedRow = null;

// === í–‰ í´ë¦­ ì´ë²¤íŠ¸ ===
document.querySelectorAll("#tenants-table tbody tr").forEach(row => {
  row.addEventListener("click", function () {
    // ì´ì „ ì„ íƒ í•´ì œ
    if (selectedRow) selectedRow.classList.remove("selected-row");
    selectedRow = this;
    selectedRow.classList.add("selected-row");

    // ë°ì´í„° ì±„ìš°ê¸°
    document.getElementById("tenantid").value = this.dataset.tenantid;
    document.getElementById("tenantnm").value = this.dataset.tenantnm;
    document.getElementById("useyn").checked = this.dataset.useyn === "True";
    document.getElementById("creator").value = this.dataset.creatornm;
    document.getElementById("createdts").value = this.dataset.createdts;
    // document.getElementById("billingmodelcd").value = this.dataset.billingmodelcd;
    document.getElementById("billingusercnt").value = this.dataset.billingusercnt;
    document.getElementById("llmlimityn").checked = this.dataset.llmlimityn === "True";
    document.getElementById("email").value = this.dataset.email;
    document.getElementById("telno").value = this.dataset.telno;
    

    document.getElementById("billingmodelcd-Fr").checked = this.dataset.billingmodelcd === "Fr";
    document.getElementById("billingmodelcd-Pr").checked = this.dataset.billingmodelcd === "Pr";
    document.getElementById("billingmodelcd-Te").checked = this.dataset.billingmodelcd === "Te";
    document.getElementById("billingmodelcd-En").checked = this.dataset.billingmodelcd === "En";

    showActionButtons(this.dataset.tenantid);

    // ================================
    // ì•„ì´ì½˜ íŒŒì¼ í‘œì‹œ ë° ë‹¤ìš´ë¡œë“œ ì²˜ë¦¬
    // ================================
    // ê¸°ì¡´ ì„ íƒ í–‰ í´ë¦­ ì‹œ
    const iconFileName = this.dataset.iconfilenm;
    const iconFileUrl = this.dataset.iconfileurl;

    if (iconFileName && iconFileUrl) {
      currentIconFileName.textContent = iconFileName;
      currentIconFileName.style.color = "blue";
      currentIconFileName.style.textDecoration = "underline";
      currentIconFileName.style.cursor = "pointer";

      currentIconFileName.onclick = async (e) => {
        e.preventDefault(); // í˜¹ì‹œ ê¸°ë³¸ ë™ì‘ ë°©ì§€
        try {
          const res = await fetch(iconFileUrl);
          if (!res.ok) throw new Error("íŒŒì¼ì„ ë¶ˆëŸ¬ì˜¬ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.");

          const blob = await res.blob();
          const url = window.URL.createObjectURL(blob);

          const a = document.createElement("a");
          a.href = url;
          a.download = iconFileName; // í™”ë©´ì— ë³´ì´ëŠ” ì´ë¦„
          document.body.appendChild(a);
          a.click();
          document.body.removeChild(a);
          window.URL.revokeObjectURL(url);
        } catch (err) {
          alert("ë‹¤ìš´ë¡œë“œ ì‹¤íŒ¨: " + err.message);
        }
      };
    } else {
      currentIconFileName.textContent = "ì´ë¯¸ì§€ íŒŒì¼ ì—†ìŒ";
      currentIconFileName.style.color = "black";
      currentIconFileName.style.textDecoration = "none";
      currentIconFileName.style.cursor = "default";
      currentIconFileName.onclick = null;
    }
  });
});


// ================================
// í™”ë©´ ì²˜ìŒ ë¡œë”© ì‹œ ê¸°ë³¸ê°’
// ================================
currentIconFileName.textContent = "ì´ë¯¸ì§€ íŒŒì¼ ì—†ìŒ";
currentIconFileName.onclick = null;
currentIconFileName.style.cursor = "default";
currentIconFileName.style.textDecoration = "none";
currentIconFileName.style.color = "black";


// ì´ˆê¸°í™” ë²„íŠ¼
document.getElementById("reset-btn").addEventListener("click", () => {
  const form = document.getElementById("tenants-detail-form");
  form.reset();

  document.getElementById("tenantid").value = "";

  // ë„¤ë¹„ ë²„íŠ¼ ìˆ¨ê¹€
  const navButtons = document.getElementById("nav-buttons");
  navButtons.style.display = "none";

  // ================================
  // ğŸ”¥ ê¸°ì—… ì´ë¯¸ì§€ ì˜ì—­ ì´ˆê¸°í™” (ì¤‘ìš”)
  // ================================
  iconFileInput.value = ""; // file input ì´ˆê¸°í™”

  currentIconFileName.textContent = "ì´ë¯¸ì§€ íŒŒì¼ ì—†ìŒ";
  currentIconFileName.style.color = "black";
  currentIconFileName.style.textDecoration = "none";
  currentIconFileName.style.cursor = "default";
  currentIconFileName.onclick = null;

  // ì„ íƒ í–‰ í•´ì œ
  if (selectedRow) {
    selectedRow.classList.remove("selected-row");
    selectedRow = null;
  }
});


// ì €ì¥ ë²„íŠ¼
document.getElementById("save-btn").addEventListener("click", () => {
  const form = document.getElementById("tenants-detail-form");
  const formData = new FormData(form);

  // showLoading('save')

  fetch("{% url 'master_tenants_save' %}", {
    method: "POST",
    credentials: "include",   // ğŸ‘ˆ ì—¬ê¸°
    body: formData,
    headers: {
      "X-CSRFToken": getCookie("csrftoken")
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === "success") {
      alert(data.message);
      // hideLoading('save')
      location.reload();
    } else {
      alert("ì €ì¥ ì‹¤íŒ¨: " + (data.message || "ì„œë²„ ì˜¤ë¥˜"));
      // hideLoading('save')
    }
  })
  .catch(err => {
    alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message);
    // hideLoading('save')
  });
});

// ì‚­ì œ ë²„íŠ¼
document.getElementById("delete-btn").addEventListener("click", () => {
  const tenantid = document.getElementById("tenantid").value;
  
  if (!tenantid) {
    alert("ì‚­ì œí•  ê¸°ì—…ì„ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  // showLoading('delete')

  fetch("{% url 'master_tenants_delete' %}", {
    method: "POST",
    credentials: "include",   // ğŸ‘ˆ ì—¬ê¸°
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify({ tenantid })
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === "success") {
      alert(data.message);
      // hideLoading('delete')
      location.reload();
    } else {
      alert("ì‚­ì œ ì‹¤íŒ¨: " + (data.message || "ì„œë²„ ì˜¤ë¥˜"));
      // hideLoading('delete')
    }
  })
  .catch(error => {
    alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message)
    // hideLoading('delete')
  });
});

// í•˜ë‹¨ í•­ëª© í‘œì‹œ
function showActionButtons(chapteruid) {
  const navButtons = document.getElementById("nav-buttons");
  navButtons.style.display = "flex";

  const tenantid = document.getElementById("tenantid").value;

  // í”„ë¡œì íŠ¸ ì„¤ì • ë²„íŠ¼
  const btnProjects = document.getElementById("btn-tenant-projects");
  btnProjects.onclick = (e) => {
    e.preventDefault(); // âœ… form submit ë°©ì§€
    const url = "{% url 'master_projects' %}?tenantid=" + tenantid;
    window.location.href = url; // í˜„ì¬ ì°½ ì´ë™
  };

  // ê¸°ì—… ì‚¬ìš©ì ì„¤ì • ë²„íŠ¼
  const btnUsers = document.getElementById("btn-tenant-users");
  btnUsers.onclick = (e) => {
    e.preventDefault(); // âœ… form submit ë°©ì§€
    const url = "{% url 'master_tenant_users' %}?tenantid=" + tenantid;
    window.location.href = url; // í˜„ì¬ ì°½ ì´ë™   
  };
}


// ì¿ í‚¤ ì •ë³´
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}
</script>

{% endblock %}
