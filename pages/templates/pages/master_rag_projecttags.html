{% extends 'pages/base.html' %}
{% load static %}
{% block title %}RAG Tag{% endblock %}

{% block content %}

<div class="page-title">
  <div style="display: flex; align-items: center;">
    <div class="gradient-bar"></div>
    <div>RAG Tag</div>
  </div>
</div>

<div style="display: flex; gap: 20px; min-height: 80%;">
  <!-- 왼쪽: 프로젝트 Tag 목록 -->
  <div style="flex: 1.5;">
    <h3>프로젝트 Tag 목록</h3>
    <div class="table-container">
      <table class="table table-bordered table-sm">
        <thead>
          <tr>
            <th style="width: 20%;">프로젝트명</th>
            <th style="width: 30%;">TagCD</th>
            <th style="width: 30%;">Tag명</th>
            <th style="width: 30%;">사용여부</th>
          </tr>
        </thead>
        <tbody>
          {% for projecttag in projecttags %}
          <tr data-projectid="{{ projecttag.projectid }}"
              data-projectnm="{{ projecttag.projectnm }}"
              data-tagcd="{{ projecttag.tagcd }}"
              data-tagnm="{{ projecttag.tagnm }}"
              data-uicomponent="{{ projecttag.uicomponent }}"
              data-useyn="{{ projecttag.useyn }}"
              data-orderno="{{ projecttag.orderno }}"
              data-creator="{{ projecttag.creator }}"
              data-createdts="{{ projecttag.createdts }}">
              <td>{{ projecttag.projectnm }}</td>
              <td>
                {% if projecttag.tagcd == 'tag1' %}Tag1
                {% elif projecttag.tagcd == 'tag2' %}Tag2
                {% elif projecttag.tagcd == 'tag3' %}Tag3
                {% else %}{{ projecttag.tagcd }}
                {% endif %}
              </td>
              <td>{{ projecttag.tagnm }}</td>
              <td class="info" style="text-align: center;">
                  {% if projecttag.useyn %}<span>✔</span>{% endif %}
              </td>
          </tr>
          {% empty %}
          <tr>
              <td colspan="4" class="text-center text-muted py-4">등록된 프로젝트가 없습니다.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- 오른쪽: 프로젝트 Tag 상세 -->
  <div style="flex: 1.5; padding-left: 20px;">
    <h3>프로젝트 Tag 상세</h3>
    <form id="projecttags-detail-form">
      <input id="projectid" name="projectid" type="text" hidden>

      <div class="form-group-left">
        <label>프로젝트명:</label>
        <select id="projectid-select" name="projectid">
          <option value="">선택</option>
          {% for project in projects %}
            <option value="{{ project.projectid }}">{{ project.projectnm }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group-left">
        <label>TagCD:</label>
        <select id="tagcd" name="tagcd">
          <option value="">선택</option>
          <option value="tag1">Tag1</option>
          <option value="tag2">Tag2</option>
          <option value="tag3">Tag3</option>
        </select>
      </div>

      <div class="form-group-left">
        <label>Tag명:</label>
        <input id="tagnm" name="tagnm" type="text">
      </div>

      <div class="form-group-left">
        <label>UI 표현:</label>
        <select id="uicomponent" name="uicomponent">
          <option value="">선택</option>
          <option value="R">Radio</option>
          <option value="C">Checkbox</option>
          <option value="DS">Dropdown Single Select</option>
          <option value="DM">Dropdown Multi Select</option>
        </select>
      </div>

      <div class="form-group-left">
        <label>정렬:</label>
        <input id="orderno" name="orderno" type="number" min="0">
      </div>
      
      <div class="form-group-left" style="display: block;">
        <label>사용:</label>
        <input id="useyn" name="useyn" type="checkbox" style="margin-left: 50px;">
      </div>

      <div class="button-group">
        <button id="reset-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/new.svg' %}" class="icon-img new-icon" title="신규">
            <span class="icon-label">신규</span>
          </div> 
        </button>

        <button id="save-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/save.svg' %}" class="icon-img save-icon" title="저장">
            <span class="icon-label">저장</span>
          </div>  
        </button>

        <button id="delete-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/delete.svg' %}" class="icon-img del-icon" title="삭제">
            <span class="icon-label">삭제</span>
          </div>   
        </button>
      </div>
      
    </form>
  </div>

  <!-- 오른쪽: 값 정보 패널 -->
  <div style="flex:1.5; padding-left:20px;" id="value-panel">
    <h3 style="display:flex; justify-content:space-between; align-items:center;">
      값 정보
      <button id="add-value-btn" type="button" class="icon-btn">
        <div class="icon-wrapper"><img src="{% static 'icons/new.svg' %}" class="icon-img new-icon" title="신규"></div>
      </button>
    </h3>

    <table class="basic-table" id="value-table">
      <thead>
        <tr>
          <!-- <th style="width:20%;">ValueCD</th> -->
          <th style="width:40%;">Value명</th>
          <th style="width:20%;">사용</th>
          <th style="width:20%;">순서</th>
          <th style="width:20%;">액션</th>
        </tr>
      </thead>
      <tbody>
        <tr>
          <td colspan="4" style="text-align:center;color:#888;">
            태그를 선택하세요.
          </td>
        </tr>
      </tbody>
    </table>
  </div>

</div>

<!-- JSON 데이터 안전하게 전달 -->
{{ projecttagvalues|json_script:"projecttagvalues" }}

<script>
let selectedRow = null;
let selectedTag = null;

// JSON 로드
const projecttagvalues = JSON.parse(document.getElementById('projecttagvalues').textContent);

// 페이지 로드 시 초기화
window.addEventListener('load', function() {
  document.getElementById("projecttags-detail-form").reset();
  document.getElementById("projectid-select").value = "";
  document.getElementById("useyn").checked = false;
});

// 좌측 목록 클릭 → form 및 값 테이블 채우기
document.querySelectorAll("tbody tr[data-projectid]").forEach(row => {
  row.addEventListener("click", function () {
    // form 채우기
    document.getElementById("projectid").value = row.dataset.projectid;
    document.getElementById("projectid-select").value = row.dataset.projectid;
    document.getElementById("tagcd").value = row.dataset.tagcd;
    document.getElementById("tagnm").value = row.dataset.tagnm;
    document.getElementById("uicomponent").value = row.dataset.uicomponent;
    document.getElementById("orderno").value = row.dataset.orderno;
    document.getElementById("useyn").checked = row.dataset.useyn === "True" || row.dataset.useyn === "✔";

    if (selectedRow) selectedRow.classList.remove("selected-row");
    row.classList.add('selected-row');
    selectedRow = row;

    // 값 정보 테이블 채우기
    selectedTag = {projectid: row.dataset.projectid, tagcd: row.dataset.tagcd};
    const tagValues = projecttagvalues.filter(v =>
      v.projectid == selectedTag.projectid && v.tagcd == selectedTag.tagcd
    );

    const tbody = document.querySelector("#value-table tbody");
    tbody.innerHTML = "";

    if (!tagValues.length) {
      tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#888;">값 없음</td></tr>`;
      return;
    }

    tagValues.forEach(v => {
      const tr = document.createElement("tr");
      tr.className = "new-value-row";
      tr.innerHTML = `
        <td><input value="${v.valuenm}"></td>
        <td style="text-align:center;"><input type="checkbox" ${v.useyn ? 'checked' : ''}></td>
        <td><input type="number" min="0" value="${v.orderno != null ? v.orderno : ''}"></td>
        <td><button class="btn-tbl btn-danger" onclick="this.closest('tr').remove()">삭제</button></td>
      `;
      tbody.appendChild(tr);
    });
  });
});

// 초기화 버튼
document.getElementById("reset-btn").addEventListener("click", () => {
  document.getElementById("projecttags-detail-form").reset();
  document.getElementById("projectid").value = "";
  document.getElementById("projectid-select").value = "";
  document.getElementById("useyn").checked = false;
  const tbody = document.querySelector("#value-table tbody");
  tbody.innerHTML = `<tr><td colspan="5" style="text-align:center;color:#888;">태그를 선택하세요.</td></tr>`;
  if (selectedRow) selectedRow.classList.remove("selected-row");
  selectedRow = null;
  selectedTag = null;
});

// 값 신규 버튼
document.getElementById("add-value-btn").addEventListener("click", () => {
  if (!selectedTag) return alert("태그를 선택하세요.");
  const tbody = document.querySelector("#value-table tbody");
  const tr = document.createElement("tr");
  tr.className = "new-value-row";
  tr.innerHTML = `
    <td><input placeholder="Value명"></td>
    <td style="text-align:center;"><input type="checkbox"></td>
    <td><input type="number" min="0" placeholder="순서"></td>
    <td><button class="btn-tbl btn-danger" onclick="this.closest('tr').remove()">삭제</button></td>
  `;
  tbody.appendChild(tr);
});

// 저장 버튼 (projecttags + projecttagvalues)
document.getElementById("save-btn").addEventListener("click", () => {
  const form = document.getElementById("projecttags-detail-form");
  const formData = new FormData(form);
  formData.set("useyn", document.getElementById("useyn").checked ? "True" : "False");

  // 값 정보 테이블 데이터 수집
  let values = [];
  if (selectedTag) {
    const rows = document.querySelectorAll("#value-table tbody tr.new-value-row");
    values = Array.from(rows).map(r => {
      const inputs = r.querySelectorAll("input");
      return {
        projectid: selectedTag.projectid,
        tagcd: selectedTag.tagcd,
        valuecd: inputs[0].value,
        valuenm: inputs[0].value,
        useyn: inputs[1].checked,
        orderno: inputs[2].value || 0
      };
    });
    formData.append("values_json", JSON.stringify(values));
  }

  fetch("{% url 'master_rag_projecttags_save' %}", {
    method: "POST",
    credentials: "include",
    body: formData,
    headers: { "X-CSRFToken": getCookie("csrftoken") }
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === "success") {
      alert(data.message);
      location.reload();
    } else {
      alert("저장 실패: " + (data.message || "서버 오류"));
    }
  })
  .catch(err => { alert("오류 발생: " + err.message) });
});

// 삭제 버튼 (projecttags + 관련 values)
document.getElementById("delete-btn").addEventListener("click", () => {
  const projectid = document.getElementById("projectid").value;
  const tagcd = document.getElementById("tagcd").value;
  if (!projectid || !tagcd) { alert("삭제할 프로젝트를 선택하세요."); return; }
  if (!confirm("정말 삭제하시겠습니까?")) return;

  fetch("{% url 'master_rag_projecttags_delete' %}", {
    method: "POST",
    credentials: "include",
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify({ projectid, tagcd })
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === "success") {
      alert(data.message);
      location.reload();
    } else {
      alert("삭제 실패: " + (data.message || "서버 오류"));
    }
  })
  .catch(err => { alert("오류 발생: " + err.message) });
});

// 쿠키 가져오기
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

</script>

{% endblock %}
