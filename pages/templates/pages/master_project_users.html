{% extends 'pages/base.html' %}
{% load custom_filters %}
{% load static %}
{% block title %}
í”„ë¡œì íŠ¸ ì‚¬ìš©ì ê´€ë¦¬
{% endblock %}

{% block content %}

<div class="page-title">
  <div style="display: flex; align-items: center;">
    <div class="gradient-bar"></div>
    <div>í”„ë¡œì íŠ¸ ì‚¬ìš©ì ê´€ë¦¬</div>
  </div>
  {% if request.session.user.roleid == 7 or request.session.user.tenantmanager == 'Y' %}
  <button type="button" class="icon-btn" id="back-btn">
    <img src="{% static 'icons/back.svg' %}" alt="ë’¤ë¡œê°€ê¸°" class="icon-img config-icon">
  </button>
  {% endif %}
</div>

<form method="get" action="" class="form-filter-group">
  <div class="filter-item">
    <label for="projectid" style="width: 100px;">í”„ë¡œì íŠ¸ ëª©ë¡:</label>
    <select name="projects" id="projects" onchange="this.form.submit()">
      <option value="">-- í”„ë¡œì íŠ¸ ì„ íƒ --</option>
      {% for project in projects %}
        <option value="{{ project.projectid }}"
          {% if projectid|stringformat:"s" == project.projectid|stringformat:"s" %}
            selected
          {% elif projects|length == 1 %}
            selected
          {% endif %}
        >
          {{ project.projectnm }}
        </option>
      {% endfor %}
    </select>
  </div>
</form>

<div style="display: flex; gap: 20px; min-height: 80%;">
  <!-- ì™¼ìª½ -->
  <div style="flex: 1.5;">
    <h3>ì‚¬ìš©ì ëª©ë¡</h3>
    <div class="table-container">
      <table class="table table-bordered table-sm">
        <thead>
          <tr>
            <th style="width: 30%;">ì´ë©”ì¼</th>
            <th style="width: 20%;">ì‚¬ìš©ìëª…</th>
            <th style="width: 10%;">ì—­í• </th>
            <th style="width: 10%;">ì‚¬ìš©</th>
            <th class="info"  style="width:20%;">ìƒì„±ì¼ì‹œ</th>
            <!-- <th class="info"  style="width:10%"></th> -->
          </tr>
        </thead>
        <tbody>
          {% for user in projectusers %}
          <tr data-projectid="{{ user.projectid }}"
              data-useruid="{{ user.useruid }}"
              data-usernm="{{ user.usernm }}"
              data-email="{{ user.email }}"
              data-rolecd="{{ user.rolecd }}"
              data-useyn="{{ user.useyn }}"
              data-creator="{{ user.creator }}"
              data-creatornm="{{ user.creatornm}}"
              data-createdts="{{ user.createdts }}">
              <td>{{ user.email }}
                  <!-- {% if not user.useyn %}<small class="text-muted">(ë¹„í™œì„±)</small>{% endif %} -->
              </td>
              <td>
                  {{ user.usernm }}
                  <!-- {% if not user.useyn %}<small class="text-muted">(ë¹„í™œì„±)</small>{% endif %} -->
              </td>
              <td class="info">
                  {% if user.rolecd == "M" %}<span>Manager</span>
                  {% else %}<span>User</span>
                  {% endif %}
                  <!-- {% if not user.useyn %}<small class="text-muted">(ë¹„í™œì„±)</small>{% endif %} -->
              </td>
              <td class="info"style="text-align: center;">
                  {% if user.useyn %}<span>âœ”</span>
                  {% endif %}
              </td>
              <td class="info"><span class="text-muted">{{user.createdts}}</span></td>
              <!-- <td class="info"><button class="btn-tbl btn-primary projects-select-btn" type="button">ì„ íƒ</button></td> -->
          </tr>
          {% empty %}
          <tr>
              <td colspan="6" class="text-center text-muted py-4">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
    
  </div>

  <!-- ì˜¤ë¥¸ìª½ -->
  <div style="flex: 1.5; padding-left: 20px;">
    <h3>ì‚¬ìš©ì ìƒì„¸</h3>
    <input id="projectid" name="projectid" type="text" value="{{ projectid}}" hidden>
    <form id="projects-detail-form" enctype="multipart/form-data">
      <input id="useruid" name="useruid" type="text" hidden>
      
      <div class="form-group-left">
        <label>ì´ë©”ì¼:</label>
  
        <!-- ìˆ˜ë™ ì…ë ¥ -->
        <input id="email" name="email" type="text" placeholder="ì§ì ‘ ì…ë ¥ ë˜ëŠ” ì¡°íšŒ">
        <button type="button" class="icon-btn" style="margin-left:5px;" onclick="openUserModal()">
          ì¡°íšŒ
        </button>
      </div>
   
      <div class="form-group-left">
        <label>ì‚¬ìš©ìëª…:</label>
        <input id="usernm" name="usernm" type="text" disabled>
      </div>

      <!-- âœ… ì—­í•  ë“œë¡­ë°•ìŠ¤ ì¶”ê°€ -->
      <div class="form-group-left">
        <label>ì—­í• :</label>
        <div>
          <label>
            <input type="radio" name="rolecd" value="M" id="role-m">
            Manager
          </label>
          <label style="margin-left: 10px;">
            <input type="radio" name="rolecd" value="U" id="role-u">
            User
          </label>
        </div>
      </div>

      <div class="form-group-left"style = "display: block;">
        <label>ì‚¬ìš©:</label>
        <input id="useyn" name="useyn" type="checkbox" style="margin-left: 50px;">
      </div>

      <div class="form-group-left">
        <label>ìƒì„±ì:</label>
        <input id="creator" name="creator" type="text" disabled>
      </div>

      <div class="form-group-left">
        <label>ìƒì„±ì¼ì‹œ:</label>
        <input id="createdts" name="createdts" type="text" disabled>
      </div>

      <div class="button-group">
        <button id="reset-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/new.svg' %}" class="icon-img new-icon" title="ì‹ ê·œ">
            <span class="icon-label">ì‹ ê·œ</span>
          </div> 
        </button>

        <!-- ì €ì¥ ë²„íŠ¼ -->
        <button id="save-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/save.svg' %}" class="icon-img save-icon" title="ì €ì¥">
            <span class="icon-label">ì €ì¥</span>
          </div>  
        </button>

        <!-- ì‚­ì œ ë²„íŠ¼ -->
        <button id="delete-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/delete.svg' %}" class="icon-img del-icon" title="ì‚­ì œ">
            <span class="icon-label">ì‚­ì œ</span>
          </div>  
        </button>
      </div>
    </form>
  </div>
</div>


<!-- ì‚¬ìš©ì ê²€ìƒ‰ Modal -->
<!-- ì‚¬ìš©ì ê²€ìƒ‰ Modal -->
<div id="user-modal" style="
    display:none; 
    position:fixed; 
    top:0; left:0; 
    width:100%; height:100%;
    background: rgba(0,0,0,0.5); 
    justify-content:center; 
    align-items:center;
    z-index: 1050; /* overlay ì „ì²´ ìœ„ */
">
  <div style="
      background:#fff; 
      padding:20px; 
      width:500px; 
      max-height:80%; 
      overflow:auto; 
      border-radius:8px;
      position: relative;  /* z-index ì ìš© ìœ„í•´ í•„ìš” */
      z-index: 1060;       /* ë‚´ë¶€ ì»¨í…ì¸ ê°€ overlay ìœ„ */
  ">
    <h4>ì‚¬ìš©ì ì„ íƒ</h4>
    <table style="width:100%; border-collapse: collapse;">
      <thead>
        <tr style="background:#f0f0f0;">
          <th style="padding:8px; border:1px solid #ccc;">ì´ë¦„</th>
          <th style="padding:8px; border:1px solid #ccc;">ì´ë©”ì¼</th>
        </tr>
      </thead>
      <tbody>
        {% for u in tenantusers %}
        <tr class="user-item" style="cursor:pointer;" 
            data-email="{{ u.email }}" data-usernm="{{ u.usernm }}">
          <td style="padding:6px; border:1px solid #ccc;">{{ u.usernm }}</td>
          <td style="padding:6px; border:1px solid #ccc;">{{ u.email }}</td>
        </tr>
        {% endfor %}
      </tbody>
    </table>
    <div style="text-align:right; margin-top:10px;">
      <button type="button" onclick="closeUserModal()">ë‹«ê¸°</button>
    </div>
  </div>
</div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="formatLoading">
  <div class="loading-content">
    <div class="spinner"></div>
    <div id="loading-text" style="text-align: center;"></div>
    <div >ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>
  </div>
</div>

<script>
// Modal ì—´ê¸°/ë‹«ê¸°
function openUserModal() {
  document.getElementById('user-modal').style.display = 'flex';
}
function closeUserModal() {
  document.getElementById('user-modal').style.display = 'none';
}

// ì‚¬ìš©ì ì„ íƒ ì‹œ í¼ì— ê°’ ì±„ìš°ê¸°
document.querySelectorAll('#user-modal .user-item').forEach(item => {
  item.addEventListener('click', () => {
    document.getElementById('email').value = item.dataset.email;
    document.getElementById('usernm').value = item.dataset.usernm;
    closeUserModal();
  });
});

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ì§„í–‰
window.addEventListener('load', function() {
  document.getElementById("projects-detail-form").reset();
});

function handleEmailSelect(selectedEmail) {
  const emailInput = document.getElementById('email');
  if (selectedEmail) {
    emailInput.value = selectedEmail;
  }
}

// í–‰ í´ë¦­ ì´ë²¤íŠ¸ë¡œ ë³€ê²½
document.querySelectorAll("table tbody tr[data-useruid]").forEach(row => {
  row.addEventListener("click", function () {
    // ê¸°ì¡´ ì„ íƒëœ í–‰ ìˆìœ¼ë©´ ì œê±°
    const prevSelected = document.querySelector("tr.selected-row");
    if (prevSelected) prevSelected.classList.remove("selected-row");

    // í´ë¦­í•œ í–‰ ì„ íƒ ì²˜ë¦¬
    row.classList.add("selected-row");

    // ìš°ì¸¡ í¼ì— ê°’ ì±„ìš°ê¸°
    document.getElementById("useruid").value = row.dataset.useruid;
    document.getElementById("usernm").value = row.dataset.usernm;
    document.getElementById("email").value = row.dataset.email;
    // document.getElementById("rolecd").value = row.dataset.rolecd;
    if(row.dataset.rolecd === "M") {
      document.getElementById("role-m").checked = true;
    } else {
      document.getElementById("role-u").checked = true;
    }
    document.getElementById("useyn").checked = row.dataset.useyn === "True";
    document.getElementById("creator").value = row.dataset.creatornm;
    document.getElementById("createdts").value = row.dataset.createdts;
  });
});

// ì´ˆê¸°í™” ë²„íŠ¼
document.getElementById("reset-btn").addEventListener("click", () => {
  document.getElementById("projects-detail-form").reset();
  // ë¼ë””ì˜¤ ë²„íŠ¼ ì²´í¬ í•´ì œ
  document.getElementById("role-m").checked = false;
  document.getElementById("role-u").checked = false;

  document.getElementById("useruid").value = "";
  if (selectedRow) selectedRow.classList.remove("selected-row");
  selectedRow = null;
});

// ì €ì¥ ë²„íŠ¼
document.getElementById("save-btn").addEventListener("click", () => {
  const form = document.getElementById("projects-detail-form");
  const formData = new FormData(form);
  const projectid = document.getElementById('projectid').value;

  // projectid ì¶”ê°€
  formData.append('projectid', projectid);

  // showLoading('save')

  fetch("{% url 'master_project_users_save' %}", {
    method: "POST",
    credentials: "include",   // ğŸ‘ˆ ì—¬ê¸°
    body: formData,
    headers: {
      "X-CSRFToken": getCookie("csrftoken")
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === "success") {
      alert(data.message);
      // hideLoading('save')
      location.reload();
    } else {
      alert("ì €ì¥ ì‹¤íŒ¨: " + (data.message || "ì„œë²„ ì˜¤ë¥˜"));
      // hideLoading('save')
    }
  })
  .catch(err => {
    alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message);
    // hideLoading('save')
  });
});

// ì‚­ì œ ë²„íŠ¼
document.getElementById("delete-btn").addEventListener("click", () => {
  const projectid = document.getElementById("projectid").value;
  const useruid = document.getElementById("useruid").value;
  
  if (!useruid) {
    alert("ì‚­ì œí•  ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  // showLoading('delete')

  fetch("{% url 'master_project_users_delete' %}", {
    method: "POST",
    credentials: "include",   // ğŸ‘ˆ ì—¬ê¸°
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify({ projectid, useruid })
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === "success") {
      alert(data.message);
      // hideLoading('delete')
      location.reload();
    } else {
      alert("ì‚­ì œ ì‹¤íŒ¨: " + (data.message || "ì„œë²„ ì˜¤ë¥˜"));
      // hideLoading('delete')
    }
  })
  .catch(error => {
    alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message)
    // hideLoading('delete')
  });
});

// ì¿ í‚¤ ì •ë³´
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}


document.getElementById("back-btn").addEventListener("click", () => {
  // í•­ìƒ object ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™
  const backUrl = `/master/projects/`;
  window.location.href = backUrl; // ìƒˆë¡œê³ ì¹¨ í¬í•¨í•œ ì™„ì „í•œ ì´ë™

});
</script>

{% endblock %}
