{% extends "pages/base.html" %}
{% block title %}테스트{% endblock %}

{% block content %}
<style>
  .object_label {
    width: 100px; 
    display: block;
    margin-block-start: 1em;
    margin-block-end: 1em;
    margin-inline-start: 0px;
    margin-inline-end: 0px;
    unicode-bidi: isolate;
  }

  .object_value {
    width: 350px; 
    display: block;
    margin-block-start: 1em;
    margin-block-end: 1em;
    margin-inline-start: 0px;
    margin-inline-end: 0px;
    unicode-bidi: isolate;
    margin-left: 5px;
  }

  .info{
    text-align: center;
  }
</style>

<div class="page-title">
  <div class="gradient-bar"></div>
  테스트
</div>

<div style="display: none /*flex*/; gap: 20px; min-height: 80%;">
  <!-- 좌측 패널 -->
  <div style="flex: 1.5; border-right: 1px solid #ddd; padding-right: 20px;">
    <h3>목록</h3>
    <div class="table-container">
      <table class="table table-bordered table-sm">
        <thead>
          <tr>
            <th style="width: 30%;">ci</th>
            <th style="width: 10%;">name</th>
            <th style="width: 10%;">birth</th>
            <th style="width: 10%;">phone</th>
            <th style="width: 30%;">userid</th>
            <th style="width: 10%;"></th>
          </tr>
        </thead>
        <tbody id="object-table-body">
          <!-- JavaScript로 동적으로 채워짐 -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- 우측 패널 -->
  <div style="flex: 1; padding-left: 20px;">
    <h3>항목 상세 보기</h3>
    <form id="item-detail-form" style="width: 70%;">
      <input type="hidden" id="objectuid" name="objectuid" />

      <div class="form-group-left">
        <label class="object_label" for="veri_ci"><strong>ci</strong></label>
        <input class="object_value" id="veri_ci" name="veri_ci" disabled></input>
      </div>

      <div class="form-group-left">
        <label class="object_label" for="veri_name"><strong>이름</strong></label>
        <input class="object_value" id="veri_name" name="veri_name"></input>
      </div>

      <div class="form-group-left">
        <label class="object_label" for="veri_birth"><strong>birth</strong></label>
        <input class="object_value" id="veri_birth" name="veri_birth"></input>
      </div>

      <div class="form-group-left">
        <label class="object_label" for="veri_phone"><strong>phone</strong></label>
        <input class="object_value" id="veri_phone" name="veri_phone"></input>
      </div>

      <div class="form-group-left">
        <label class="object_label" for="veri_userid"><strong>userid</strong></label>
        <input class="object_value" id="veri_userid" name="veri_userid" disabled></input>
      </div>

      <div class="form-group-left" style="justify-content: center;">
        <button class="btn btn-primary"   id="save-btn"   type="button">저장</button>
        <button class="btn btn-danger"    id="delete-btn" type="button">삭제</button>
        <button class="btn btn-secondary" id="config-btn" type="button">내용 설정</button>
      </div>
    </form>
  </div>
</div>



<script>
// Django에서 전달받은 데이터를 JavaScript 변수로 저장
const allDatas = {{ datas|safe }};
let currentDatas = [];
// 챕터 선택 시 datas 로딩 (예시 구조)
updateDataTable(allDatas);

// datas 테이블 업데이트
function updateDataTable(datas) {
  const tbody = document.getElementById('object-table-body');
  tbody.innerHTML = '';
  
  datas.forEach(item => {
    const row = document.createElement('tr');
    row.setAttribute('data-ci', item.ci);
    row.setAttribute('data-dec_ci', item.dec_ci);
    row.setAttribute('data-user_id', item.userid);
    row.setAttribute('data-name', item.name);
    row.setAttribute('data-birth', item.birth);
    row.setAttribute('data-phone', item.phone);
    
    row.innerHTML = `
      <td style="word-break: break-all;" >${item.dec_ci}</td>
      <td class="info">${item.name || ""}</td>
      <td>${item.birth || ""}</td>
      <td class="info">${item.phone || ""}</td>
      <td class="info">${item.userid || ""}</td>
      <td class="info"><button class="btn-tbl btn-primary data-select-btn" type="button">선택</button></td>
    `;
    
    tbody.appendChild(row);
  });
  
  // 선택 버튼에 이벤트 리스너 다시 추가
  addSelectButtonListeners();
}

// 선택 버튼 이벤트 리스너 추가
function addSelectButtonListeners() {
  document.querySelectorAll(".data-select-btn").forEach(button => {
    button.addEventListener("click", function () {
      const row = this.closest("tr");
      
      document.getElementById("veri_ci").value = row.dataset.dec_ci;
      document.getElementById("veri_name").value = row.dataset.name;
      document.getElementById("veri_birth").value = row.dataset.birth;
      document.getElementById("veri_phone").value = row.dataset.phone;
      document.getElementById("veri_userid").value = row.dataset.user_id;
    });
  });
}

// 저장 버튼
document.getElementById("save-btn").addEventListener("click", async () => {
  const data = {
    ci: document.getElementById("veri_ci").value,
    name: document.getElementById("veri_name").value,
    birth: document.getElementById("veri_birth").value,
    phone: document.getElementById("veri_phone").value,
    user_id: document.getElementById("veri_userid").value
  };
  
  fetch("{% url 'test_save' %}", {
    method: "POST",
    body: JSON.stringify(data),
    headers: {
      "X-CSRFToken": getCookie("csrftoken")
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === "success") {
      alert("저장되었습니다.");
      location.reload();
    } else {
      alert("저장 실패: " + (data.message || "서버 오류"));
    }
  })
  .catch(err => {
    alert("오류 발생: " + err.message);
  });
});
</script>

{% endblock %}