{% extends 'pages/base.html' %} 
{% load static %}
{% block title %}
ê¸°ì—… ì‚¬ìš©ì ê´€ë¦¬
{% endblock %}

{% block content %}
<style>
/* ì´ í˜ì´ì§€ ì „ìš©: ë¼ë””ì˜¤ ë²„íŠ¼ê³¼ ë¼ë²¨ ê°„ê²© ì¡°ì • */
.form-filter-group .filter-item label {
    width: auto;       /* ê¸°ì¡´ 80px ê³ ì • ì œê±° */
    margin-right: 5px; /* ë¼ë²¨ê³¼ ì²« ë¼ë””ì˜¤ ë²„íŠ¼ ì‚¬ì´ ê°„ê²© */
}

.form-filter-group .filter-item input[type="radio"] + .radio-label {
    margin-left: 3px;  /* ë¼ë””ì˜¤ ë²„íŠ¼ê³¼ í…ìŠ¤íŠ¸ ì‚¬ì´ ê°„ê²© */
    margin-right: 10px; /* ë‹¤ìŒ ì˜µì…˜ê³¼ ê°„ê²© */
}
</style>

<div class="page-title">
  <div style="display: flex; align-items: center;">
    <div class="gradient-bar"></div>
    {% if request.session.user.roleid == 7 %}
      <div>ê¸°ì—… ì‚¬ìš©ì ê´€ë¦¬: {{ tenantnm }}</div>
    {% else %}
      <div>ê¸°ì—… ì‚¬ìš©ì ê´€ë¦¬</div>
    {% endif %}
  </div>
  {% if request.session.user.roleid == 7 %}
  <button type="button" class="icon-btn" id="back-btn">
    <img src="{% static 'icons/back.svg' %}" alt="ë’¤ë¡œê°€ê¸°" class="icon-img config-icon">
  </button>
  {% endif %}
</div>

<!-- í•„í„° ê·¸ë£¹: radio ë²„íŠ¼ìœ¼ë¡œ ë³€ê²½ -->
<form class="form-filter-group">
  <!-- ì‹ ê·œ í•„í„° -->
  <div class="filter-item">
    <label>ì‹ ê·œ:</label>
    <input type="radio" id="sep_all" name="sepFilter" value="all" checked>
    <label class="radio-label" for="sep_all">ì „ì²´</label>
    
    <input type="radio" id="sep_new" name="sepFilter" value="newusers">
    <label class="radio-label" for="sep_new">ì‹ ê·œ</label>
  </div>

  <!-- ìƒíƒœ í•„í„° -->
  <div class="filter-item">
    <label>ìƒíƒœ:</label>
    <input type="radio" id="status_all" name="statusFilter" value="all" checked>
    <label class="radio-label" for="status_all">ì „ì²´</label>

    <input type="radio" id="status_active" name="statusFilter" value="active">
    <label class="radio-label" for="status_active">í™œì„±</label>

    <input type="radio" id="status_inactive" name="statusFilter" value="inactive">
    <label class="radio-label" for="status_inactive">ë¹„í™œì„±</label>
  </div>
  
  <!-- ì—­í•  í•„í„° -->
  <div class="filter-item">
    <label>ì—­í• :</label>
    <input type="radio" id="role_all" name="roleFilter" value="all" checked>
    <label class="radio-label" for="role_all">ì „ì²´</label>

    <input type="radio" id="role_m" name="roleFilter" value="M">
    <label class="radio-label" for="role_m">Manager</label>

    <input type="radio" id="role_u" name="roleFilter" value="U">
    <label class="radio-label" for="role_u">User</label>
  </div>
</form>


<div style="display: flex; gap: 20px; min-height: 80%;">
  <!-- ì™¼ìª½: ì‚¬ìš©ì ëª©ë¡ -->
  <div style="flex: 1.5; padding-right: 20px;">
    <h3>ì‚¬ìš©ì ëª©ë¡</h3>
    <div class="table-container">
      <table class="table table-bordered table-sm" id="tenant-users-table">
        <thead>
          <tr>
            <th style="width: 30%;">ì´ë©”ì¼</th>
            <th style="width: 20%;">ì‚¬ìš©ìëª…</th>
            <th style="width: 10%;">ì—­í• </th>
            <th style="width: 10%;">ì‚¬ìš©</th>
            <th style="width: 10%;">ì‹ ê·œ</th>
            <th class="info"  style="width:20%;">ìƒì„±ì¼ì‹œ</th>
          </tr>
        </thead>
        <tbody>
          {% for user in tenantusers %}
          <tr data-sep="{{ user.sep }}"
              data-tenantnewuid="{{ user.tenantnewuid }}"
              data-tenantid="{{ user.tenantid }}"
              data-useruid="{{ user.useruid }}"
              data-usernm="{{ user.usernm }}"
              data-email="{{ user.email }}"
              data-rolecd="{{ user.rolecd }}"
              data-useyn="{{ user.useyn }}"
              data-creator="{{ user.creator }}"
              data-creatornm="{{ user.creatornm}}"
              data-createdts="{{ user.createdts }}">
              <td>{{ user.email }}</td>
              <td>{{ user.usernm }}</td>
              <td class="info">
                  {% if user.rolecd == "M" %}<span>Manager</span>
                  {% else %}<span>User</span>
                  {% endif %}
              </td>
              <td class="info" style="text-align: center;">
                  {% if user.useyn %}<span>âœ”</span>
                  {% endif %}
              </td>
              <td class="info">
                  {% if user.sep  == "newusers" %}<span>ì‹ ê·œ</span>{% endif %}
              </td>
              <td class="info"><span class="text-muted">{{user.createdts}}</span></td>
          </tr>
          {% empty %}
          <tr>
              <td colspan="6" class="text-center text-muted py-4">ë“±ë¡ëœ ì‚¬ìš©ìê°€ ì—†ìŠµë‹ˆë‹¤.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ì˜¤ë¥¸ìª½: ì‚¬ìš©ì ìƒì„¸ -->
  <div style="flex: 1.5; padding-left: 20px;">
    <h3>ì‚¬ìš©ì ìƒì„¸</h3>
    <form id="tenants-detail-form" enctype="multipart/form-data">
      <input id="sep" name="sep" type="text" hidden>
      <input id="tenantnewuid" name="tenantnewuid" type="text" hidden>
      <input id="tenantid" name="tenantid" type="text" hidden>
      <input id="useruid" name="useruid" type="text" hidden>
      
      <div class="form-group-left">
        <label>ì´ë©”ì¼:</label>
        <input id="email" name="email" type="text">
      </div>

      <div class="form-group-left">
        <label>ì‚¬ìš©ìëª…:</label>
        <input id="usernm" name="usernm" type="text" disabled>
      </div>

      <!-- ì—­í•  radio ë²„íŠ¼ -->
      <div class="form-group-left">
        <label>ì—­í• :</label>
        <label><input type="radio" name="rolecd" value="M" id="rolecd-M"> Manager</label>
        <label><input type="radio" name="rolecd" value="U" id="rolecd-U"> User</label>
      </div>

      <div class="form-group-left" style = "display: block;">
        <label>ì‚¬ìš©:</label>
        <input id="useyn" name="useyn" type="checkbox" style="margin-left: 50px;">
      </div>

      <div class="form-group-left">
        <label>ìƒì„±ì:</label>
        <input id="creator" name="creator" type="text" disabled>
      </div>

      <div class="form-group-left">
        <label>ìƒì„±ì¼ì‹œ:</label>
        <input id="createdts" name="createdts" type="text" disabled>
      </div>

      <div class="button-group">
        <button id="reset-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/new.svg' %}" class="icon-img new-icon" title="ì‹ ê·œ">
            <span class="icon-label">ì‹ ê·œ</span>
          </div>  
        </button>

        <button id="save-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/save.svg' %}" class="icon-img save-icon" title="ì €ì¥">
            <span class="icon-label">ì €ì¥</span>
          </div>   
        </button>

        <button id="delete-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/delete.svg' %}" class="icon-img del-icon" title="ì‚­ì œ">
            <span class="icon-label">ì‚­ì œ</span>
          </div>   
        </button>
      </div>

    </form>
  </div>
</div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="formatLoading">
  <div class="loading-content">
    <div class="spinner"></div>
    <div id="loading-text" style="text-align: center;"></div>
    <div>ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>
  </div>
</div>

<script>
window.addEventListener('load', function() {
  document.getElementById("tenants-detail-form").reset();
  document.getElementById("tenantid").value = {{ tenantid|safe }};
});

// ===== í•„í„° ê¸°ëŠ¥ (radio) =====
function filterTable() {
  const statusValue = document.querySelector('input[name="statusFilter"]:checked').value;
  const roleValue = document.querySelector('input[name="roleFilter"]:checked').value;
  const sepValue = document.querySelector('input[name="sepFilter"]:checked').value;

  const tableRows = document.querySelectorAll(".table-container tbody tr");

  tableRows.forEach(row => {
    const useyn = row.dataset.useyn === "True";
    const rolecd = row.dataset.rolecd;
    const sep = row.dataset.sep;

    let show = true;

    if (statusValue === "active" && !useyn) show = false;
    if (statusValue === "inactive" && useyn) show = false;
    if (roleValue !== "all" && rolecd !== roleValue) show = false;
    if (sepValue !== "all" && sep !== sepValue) show = false;

    row.style.display = show ? "" : "none";
  });
}

// ===== ì„ íƒ í–‰ í‘œì‹œ =====
let selectedRow = null;

document.querySelectorAll("#tenant-users-table tbody tr").forEach(row => {
  row.addEventListener("click", function () {
    if (selectedRow) selectedRow.classList.remove("selected-row");
    selectedRow = this;
    selectedRow.classList.add("selected-row");

    document.getElementById("sep").value = this.dataset.sep;
    document.getElementById("tenantnewuid").value = this.dataset.tenantnewuid;
    document.getElementById("tenantid").value = this.dataset.tenantid;
    document.getElementById("useruid").value = this.dataset.useruid;
    document.getElementById("usernm").value = this.dataset.usernm;
    document.getElementById("email").value = this.dataset.email;
    document.getElementById("useyn").checked = this.dataset.useyn === "True";
    document.getElementById("creator").value = this.dataset.creatornm;
    document.getElementById("createdts").value = this.dataset.createdts;

    // ìƒì„¸ ì—­í•  radio ì²´í¬
    document.getElementById("rolecd-M").checked = this.dataset.rolecd === "M";
    document.getElementById("rolecd-U").checked = this.dataset.rolecd === "U";
  });
});

// ===== ì´ˆê¸°í™” ë²„íŠ¼ =====
document.getElementById("reset-btn").addEventListener("click", () => {
  document.getElementById("tenants-detail-form").reset();
  document.getElementById("useruid").value = "";
  document.getElementById("sep").value = "";
  document.getElementById("tenantnewuid").value = "";
  if (selectedRow) selectedRow.classList.remove("selected-row");
  selectedRow = null;
});

// ===== ì €ì¥ ë²„íŠ¼ =====
document.getElementById("save-btn").addEventListener("click", () => {
  const form = document.getElementById("tenants-detail-form");
  const formData = new FormData(form);
  const roleSelected = document.querySelector('input[name="rolecd"]:checked');
  if (roleSelected) formData.set('rolecd', roleSelected.value);

  fetch("{% url 'master_tenant_users_save' %}", {
    method: "POST",
    credentials: "include",   // ğŸ‘ˆ ì—¬ê¸°
    body: formData,
    headers: {
      "X-CSRFToken": getCookie("csrftoken")
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === "success") {
      alert(data.message);
      location.reload();
    } else {
      alert("ì €ì¥ ì‹¤íŒ¨: " + (data.message || "ì„œë²„ ì˜¤ë¥˜"));
    }
  })
  .catch(err => {
    alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message);
  });
});

// ===== ì‚­ì œ ë²„íŠ¼ =====
document.getElementById("delete-btn").addEventListener("click", () => {
  const sep = document.getElementById("sep").value;
  const tenantnewuid = document.getElementById("tenantnewuid").value;
  const tenantid = document.getElementById("tenantid").value;
  const useruid = document.getElementById("useruid").value;

  if (!useruid) {
    alert("ì‚­ì œí•  ì‚¬ìš©ìë¥¼ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  // ì‹ ê·œ ì‚¬ìš©ìì¸ì§€ í™•ì¸
  if (sep === "newusers") {
    const approvenote = prompt("ê°€ì… ê±°ì ˆ ì‚¬ìœ ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš” :");
    if (!approvenote) {
      alert("ì‚­ì œ ì´ìœ ë¥¼ ì…ë ¥í•´ì•¼ í•©ë‹ˆë‹¤.");
      return;
    }

    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    // ì‹ ê·œ ì‚¬ìš©ì ì‚­ì œ ìš”ì²­
    fetch("{% url 'master_tenant_users_delete' %}", {
      method: "POST",
      credentials: "include",   // ğŸ‘ˆ ì—¬ê¸°
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: JSON.stringify({ sep, tenantnewuid, tenantid, useruid, approvenote })
    })
    .then(res => res.json())
    .then(data => {
      if (data.result === "success") {
        alert(data.message);
        location.reload();
      } else {
        alert("ì‚­ì œ ì‹¤íŒ¨: " + (data.message || "ì„œë²„ ì˜¤ë¥˜"));
      }
    })
    .catch(error => {
      alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message)
    });
  } else {
    // ì‹ ê·œê°€ ì•„ë‹Œ ê²½ìš° ê¸°ì¡´ ì‚­ì œ ë¡œì§
    if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

    fetch("{% url 'master_tenant_users_delete' %}", {
      method: "POST",
      credentials: "include",   // ğŸ‘ˆ ì—¬ê¸°
      headers: {
        "Content-Type": "application/json",
        "X-CSRFToken": getCookie("csrftoken")
      },
      body: JSON.stringify({ sep, tenantnewuid, tenantid, useruid })
    })
    .then(res => res.json())
    .then(data => {
      if (data.result === "success") {
        alert(data.message);
        location.reload();
      } else {
        alert("ì‚­ì œ ì‹¤íŒ¨: " + (data.message || "ì„œë²„ ì˜¤ë¥˜"));
      }
    })
    .catch(error => {
      alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message)
    });
  }
});

// ===== ì¿ í‚¤ ê°€ì ¸ì˜¤ê¸° =====
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

// ===== í•„í„° ì´ë²¤íŠ¸ ë“±ë¡ =====
document.addEventListener("DOMContentLoaded", function() {
  document.querySelectorAll('input[name="statusFilter"]').forEach(r => r.addEventListener('change', filterTable));
  document.querySelectorAll('input[name="roleFilter"]').forEach(r => r.addEventListener('change', filterTable));
  document.querySelectorAll('input[name="sepFilter"]').forEach(r => r.addEventListener('change', filterTable));
  filterTable(); // ê¸°ë³¸ í•„í„° ì ìš©

  const tbody = document.querySelector(".table-container tbody");
  const rows = Array.from(tbody.querySelectorAll("tr"));

  rows.sort((a, b) => a.dataset.email.toLowerCase().localeCompare(b.dataset.email.toLowerCase()));
  rows.forEach(row => tbody.appendChild(row));
});

// ===== ë’¤ë¡œê°€ê¸° ë²„íŠ¼ =====
document.getElementById("back-btn").addEventListener("click", () => {
  window.location.href = `/master/tenants/`;
});
</script>

{% endblock %}
