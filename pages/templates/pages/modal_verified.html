<style>
 /* ë³¸ì¸ ì¸ì¦ */
.verification_base_modal_content {
    background: var(--white);
    padding: 30px 25px;
    border-radius: 12px;
    width: 360px;
    height: 350px;
    box-shadow: 0 8px 24px var(--black-shadow);
    text-align: center;
}
</style>

<!-- ë³¸ì¸ì¸ì¦ -->
<div id="verification_base_modal" class="base_modal_overlay" style="display: none;">
  <div class="verification_base_modal_content" style="position: relative">
    <!-- âœ… ë‹«ê¸° ë²„íŠ¼ -->
    <button id="verification_base_modal_close" style="
        position: absolute;
        top: 10px;
        right: 10px;
        background: transparent;
        border: none;
        font-size: 20px;
        cursor: pointer;
    ">&times;</button>

    <h2 style="font-weight: bold;">ë³¸ì¸ ì¸ì¦</h2>

    <!-- ë©”ì‹œì§€ í‘œì‹œ ì˜ì—­ -->
    <div id="messageArea"></div>
    <!-- SMS ë°œì†¡ ì„¹ì…˜ -->
    <div class="section">
        <h3 class="sub_header" style="margin-bottom: 0%;">íœ´ëŒ€í° ë²ˆí˜¸</h3>
        
        <label class="modal_label" style="margin-top: 0%;">
            <input type="tel" id="phoneNumber" name="phone_number" placeholder="01012345678" maxlength="13" class="base_modal_input" style="width: 48%;" >
            <button type="button" class="btn btn-primary modal_span btn-verified" id="sendSmsBtn" onclick="sendVerificationSMS()"><span id="sendBtnText">ì¸ì¦ë²ˆí˜¸ ë°›ê¸°</span></button>
        </label>
    </div>
        
    <!-- ì¸ì¦ë²ˆí˜¸ ì…ë ¥ ì„¹ì…˜ -->
    <div class="section" {% if sms_sent %}style="display: block;"{% endif %}>
        <h3 class="sub_header" style="margin-bottom: 0%;">ì¸ì¦ë²ˆí˜¸(6ìë¦¬)</h3>
        
        <label class="modal_label"  style="margin-top: 0%;">
            <input type="text" id="verificationCode" name="verification_code" placeholder="123456" maxlength="6" class="base_modal_input" style="width: 48%;">
            <button type="button" class="btn btn-primary modal_span btn-verified" id="verifyBtn" onclick="verifyCode()"><span id="verifyBtnText">ì¸ì¦í•˜ê¸°</span></button>
        </label>
        
        <div class="timer" id="timer"></div>
    </div>

    <button type="button" class="btn btn-primary btn-verified" id="resendBtn" onclick="sendVerificationSMS()" style="margin-top: 10px;">ì¸ì¦ë²ˆí˜¸ ì¬ë°œì†¡</button>

  </div>
</div>

<script>
// ì¸ì¦ ëª¨ë‹¬ ë³´ì—¬ì£¼ê¸°
function show_verification_base_modal(){
  document.getElementById("verification_base_modal").style.display = "flex";
}

////////// ë³¸ì¸ ì¸ì¦ ê´€ë ¨
let timerInterval;
let remainingTime = 300; // 5ë¶„ = 300ì´ˆ

function showMessage(message, type = 'info') {
    const messageArea = document.getElementById('messageArea');
    const alertClass = type === 'error' ? 'alert-error' : 
                      type === 'success' ? 'alert-success' : 'alert-info';
    
    messageArea.innerHTML = `<div class="alert ${alertClass}">${message}</div>`;
    
    // 3ì´ˆ í›„ ë©”ì‹œì§€ ìë™ ì œê±° (ì—ëŸ¬ ë©”ì‹œì§€ëŠ” ì œì™¸)
    if (type !== 'error') {
        setTimeout(() => {
            messageArea.innerHTML = '';
        }, 3000);
    }
}

function formatPhoneNumber(value) {
    // ìˆ«ìë§Œ ì¶”ì¶œ
    const numbers = value.replace(/[^0-9]/g, '');
    
    // 010-XXXX-XXXX í˜•ì‹ìœ¼ë¡œ í¬ë§·íŒ…
    if (numbers.length <= 3) return numbers;
    if (numbers.length <= 7) return numbers.replace(/(\d{3})(\d{1,4})/, '$1-$2');
    return numbers.replace(/(\d{3})(\d{4})(\d{1,4})/, '$1-$2-$3');
}
// íœ´ëŒ€í° ë²ˆí˜¸ ìë™ í¬ë§·íŒ…
document.getElementById('phoneNumber').addEventListener('input', function(e) {
    e.target.value = formatPhoneNumber(e.target.value);
});

// ì¸ì¦ë²ˆí˜¸ëŠ” ìˆ«ìë§Œ ì…ë ¥ ê°€ëŠ¥
document.getElementById('verificationCode').addEventListener('input', function(e) {
    e.target.value = e.target.value.replace(/[^0-9]/g, '');
});
function startTimer() {
    remainingTime = 300; // 5ë¶„ ë¦¬ì…‹
    const timerElement = document.getElementById('timer');
    
    timerInterval = setInterval(() => {
        const minutes = Math.floor(remainingTime / 60);
        const seconds = remainingTime % 60;
        timerElement.textContent = `ë‚¨ì€ ì‹œê°„: ${minutes}:${seconds.toString().padStart(2, '0')}`;
        
        remainingTime--;
        
        if (remainingTime < 0) {
            clearInterval(timerInterval);
            timerElement.textContent = 'ì¸ì¦ì‹œê°„ì´ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤.';
            showMessage('ì¸ì¦ë²ˆí˜¸ê°€ ë§Œë£Œë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ì‹œ ìš”ì²­í•´ì£¼ì„¸ìš”.', 'error');
        }
    }, 1000);
}
// ì¸ì¦ë²ˆí˜¸ ë°œì†¡
async function sendVerificationSMS() {
  const phoneNumber = document.getElementById('phoneNumber').value.trim();
  const sendBtn = document.getElementById('sendSmsBtn');
  const sendBtnText = document.getElementById('sendBtnText');
  
  if (!phoneNumber) {
      showMessage('íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
      return;
  }
  
  // íœ´ëŒ€í° ë²ˆí˜¸ ìœ íš¨ì„± ê²€ì‚¬
  const cleanPhone = phoneNumber.replace(/[^0-9]/g, '');
  if (!/^01[016789]\d{7,8}$/.test(cleanPhone)) {
      showMessage('ì˜¬ë°”ë¥¸ íœ´ëŒ€í° ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
      return;
  }
  
  // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
  sendBtn.disabled = true;
  sendBtnText.innerHTML = '<span class="loading"></span> ë°œì†¡ ì¤‘...';
  
  try {
      const response = await fetch('/api/send_verification_sms/', {
          method: 'POST',
          credentials: "include",   // ğŸ‘ˆ ì—¬ê¸°
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
              phone_number: cleanPhone
          })
      });
      
      const result = await response.json();
      // result = {"success": true}
      
      if (result.success) {
          showMessage('ì¸ì¦ë²ˆí˜¸ê°€ ë°œì†¡ë˜ì—ˆìŠµë‹ˆë‹¤.', 'success');
        //   document.getElementById('verificationSection').style.display = 'block';
          startTimer();
          
          // í¬ì»¤ìŠ¤ë¥¼ ì¸ì¦ë²ˆí˜¸ ì…ë ¥ í•„ë“œë¡œ ì´ë™
          document.getElementById('verificationCode').focus();
      } else {
          showMessage(result.message, 'error');
      }
      
  } catch (error) {
      showMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
  } finally {
      // ë²„íŠ¼ í™œì„±í™”
      sendBtn.disabled = false;
      sendBtnText.textContent = 'ì¸ì¦ë²ˆí˜¸ ì¬ë°œì†¡';
  }
}

async function verifyCode() {
  const phoneNumber = document.getElementById('phoneNumber').value.trim();
  const verificationCode = document.getElementById('verificationCode').value.trim();
  const verifyBtn = document.getElementById('verifyBtn');
  const verifyBtnText = document.getElementById('verifyBtnText');
  
  if (!verificationCode) {
      showMessage('ì¸ì¦ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.', 'error');
      return;
  }
  
  if (verificationCode.length !== 6) {
      showMessage('ì¸ì¦ë²ˆí˜¸ëŠ” 6ìë¦¬ì…ë‹ˆë‹¤.', 'error');
      return;
  }
  
  // ë²„íŠ¼ ë¹„í™œì„±í™” ë° ë¡œë”© í‘œì‹œ
  verifyBtn.disabled = true;
  verifyBtnText.innerHTML = '<span class="loading"></span> ì¸ì¦ ì¤‘...';
  
  try {
      const cleanPhone = phoneNumber.replace(/[^0-9]/g, '');
      const response = await fetch('/api/verify_sms_code/', {
          method: 'POST',
          credentials: "include",   // ğŸ‘ˆ ì—¬ê¸°
          headers: {
              'Content-Type': 'application/json',
              'X-CSRFToken': getCookie('csrftoken')
          },
          body: JSON.stringify({
              phone_number: cleanPhone,
              verification_code: verificationCode
          })
      });
      
      const result = await response.json();
      // const result = {"success": true}
      
      if (result.success) {
          clearInterval(timerInterval);
          showMessage('âœ… ì¸ì¦ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤!', 'success');
          
          // ì¸ì¦ ì™„ë£Œ ì²˜ë¦¬ (ì˜ˆ: í˜ì´ì§€ ì´ë™, í¼ ì œì¶œ ë“±)
          setTimeout(() => {
              // ì›í•˜ëŠ” í˜ì´ì§€ë¡œ ë¦¬ë‹¤ì´ë ‰íŠ¸ ë˜ëŠ” ë‹¤ìŒ ë‹¨ê³„ ì²˜ë¦¬
              // window.location.href = '/next-step/';
              
              // ë˜ëŠ” ìƒìœ„ ì»´í¬ë„ŒíŠ¸ì— ì¸ì¦ ì™„ë£Œ ì•Œë¦¼
              if (window.parent && window.parent.onSMSVerified) {
                  window.parent.onSMSVerified(cleanPhone);
              }

              show_signup_base_modal()
              document.getElementById("verification_base_modal").style.display = "none";
              document.getElementById("phoneNumber").value = '';
              document.getElementById("verificationCode").value = '';
              document.getElementById('timer').textContent = "";


          }, 1500);
          
      } else {
          showMessage(result.message, 'error');
          
          // ì¸ì¦ë²ˆí˜¸ ì…ë ¥ í•„ë“œ í´ë¦¬ì–´
          document.getElementById('verificationCode').value = '';
          document.getElementById('verificationCode').focus();
      }
      
  } catch (error) {
      showMessage('ë„¤íŠ¸ì›Œí¬ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.', 'error');
  } finally {
      // ë²„íŠ¼ í™œì„±í™”
      verifyBtn.disabled = false;
      verifyBtnText.textContent = 'ì¸ì¦í•˜ê¸°';
  }
}

// Enter í‚¤ ì²˜ë¦¬
document.getElementById('phoneNumber').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        sendVerificationSMS();
    }
});

document.getElementById('verificationCode').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        verifyCode();
    }
});


// ëª¨ë‹¬ ê´€ë ¨ ì´ë²¤íŠ¸
document.addEventListener("DOMContentLoaded", function () {
  ////////// ë²ˆí˜¸ì¸ì¦ ì˜ì—­ ì‹œì‘
  // ë²ˆí˜¸ì¸ì¦ ëª¨ë‹¬ ë‹«ê¸°
  const verification_base_closeBtn = document.getElementById("verification_base_modal_close");
  const verification_base_modal = document.getElementById("verification_base_modal");
  verification_base_closeBtn.addEventListener("click", function () {
      verification_base_modal.style.display = "none";
      document.getElementById("phoneNumber").value = '';
      document.getElementById("verificationCode").value = '';
  });
  
  ////////// ë²ˆí˜¸ì¸ì¦ ì˜ì—­ ì¢…ë£Œ
  
});
</script>