{% extends 'pages/base.html' %}
{% load static %}
{% block title %}í”„ë¡œì íŠ¸ ê´€ë¦¬{% endblock %}

{% block content %}

<div class="page-title">
  <div style="display: flex; align-items: center;">
    <div class="gradient-bar"></div>
    <div>í”„ë¡œì íŠ¸ ê´€ë¦¬{% if tenantnm %}: {{ tenantnm }}{% endif %}</div>
  </div>
  {% if request.session.user.roleid == 7 %}
  <button type="button" class="icon-btn" id="back-btn">
    <img src="{% static 'icons/back.svg' %}" alt="ë’¤ë¡œê°€ê¸°" class="icon-img config-icon">
  </button>
  {% endif %}
</div>

<div style="display: flex; gap: 20px; min-height: 80%;">
  <!-- ì™¼ìª½ -->
  <div style="flex: 1.5; " >
    <h3>í”„ë¡œì íŠ¸ ëª©ë¡</h3>
    <div class="table-container">
      <table class="table table-bordered table-sm">
        <thead>
          <tr>
            <th style="width: 30%;">í”„ë¡œì íŠ¸ëª…</th>
            <th style="width: 30%;">ì„¤ëª…</th>
            <th class="info"  style="width: 10%;">ì‚¬ìš©</th>
            <th class="info"  style="width:20%;">ìƒì„±ì¼ì‹œ</th>
            <!-- <th class="info"  style="width:10%"></th> -->
          </tr>
        </thead>
        <tbody>
          {% for project in projects %}
          <tr data-projectid="{{ project.projectid }}"
              data-projectnm="{{ project.projectnm }}"
              data-projectdesc="{{ project.projectdesc|default_if_none:""}}"
              data-useyn="{{ project.useyn }}"
              data-creator="{{ project.creator }}"
              data-creatornm="{{ project.creatornm}}"
              data-createdts="{{ project.createdts }}"
              data-access_key_uid="{{ project.access_key_uid }}">
              <td>{{ project.projectnm }}
                  <!-- {% if not project.useyn %}<small class="text-muted">(ë¹„í™œì„±)</small>{% endif %} -->
              </td>
              <!-- <td class="multiline">
                  {{ project.projectdesc|default_if_none:""|linebreaks}} -->
                  <!-- {% if not project.useyn %}<small class="text-muted">(ë¹„í™œì„±)</small>{% endif %} -->
              <!-- </td> -->
              <td class="multiline">
                <span class="cell-center">
                  {{ project.projectdesc|default_if_none:""|linebreaksbr }}
                </span>
              </td>
              <td class="info"style="text-align: center;">
                  {% if project.useyn %}<span>âœ”</span>
                  {% endif %}
              </td>
              <td class="info"><span>{{project.createdts}}</span></td>
              <!-- <td class="info"><button class="btn-tbl btn-primary projects-select-btn" type="button">ì„ íƒ</button></td> -->
          </tr>
          {% empty %}
          <tr>
              <td colspan="4" class="text-center text-muted py-4">ë“±ë¡ëœ í”„ë¡œì íŠ¸ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ì˜¤ë¥¸ìª½ -->
  <div style="flex: 1.5; padding-left: 20px;">
    <h3>í”„ë¡œì íŠ¸ ìƒì„¸</h3>
    <form id="projects-detail-form" enctype="multipart/form-data">
      <input id="projectid" name="projectid" type="text" hidden>
      <input id="tenantid" name="tenantid" type="text" hidden>
      
      <div class="form-group-left">
        <label>í”„ë¡œì íŠ¸ëª…:</label>
        <input id="projectnm" name="projectnm" type="text">
      </div>

      <div class="form-group-left">
        <label>ì„œë²„ ì •ë³´:</label>
        <select id="access_key_uid" name="access_key_uid">
          <option value="">ì„ íƒí•˜ì„¸ìš”</option>
          {% for key in azure_key_vault %}
            <option value="{{ key.access_key_uid }}">{{ key.accesskeynm }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group-left">
        <label>ì„¤ëª…:</label>
        <textarea class="form-control object_value" id="projectdesc" name="projectdesc" spellcheck="false" style="resize: none; height: 80%;"></textarea>
      </div>

      <div class="form-group-left"style = "display: block;">
        <label>ì‚¬ìš©:</label>
        <input id="useyn" name="useyn" type="checkbox" style="margin-left: 50px;">
      </div>

      <div class="form-group-left">
        <label>ìƒì„±ì:</label>
        <input id="creator" name="creator" type="text" disabled>
      </div>

      <div class="form-group-left">
        <label>ìƒì„±ì¼ì‹œ:</label>
        <input id="createdts" name="createdts" type="text" disabled>
      </div>

      <div class="button-group">
        <button id="reset-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/new.svg' %}" class="icon-img new-icon" title="ì‹ ê·œ">
            <span class="icon-label">ì‹ ê·œ</span>
          </div> 
        </button>

        <!-- ì €ì¥ ë²„íŠ¼ -->
        <button id="save-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/save.svg' %}" class="icon-img save-icon" title="ì €ì¥">
            <span class="icon-label">ì €ì¥</span>
          </div>  
        </button>

        <!-- ì‚­ì œ ë²„íŠ¼ -->
        <button id="delete-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/delete.svg' %}" class="icon-img del-icon" title="ì‚­ì œ">
            <span class="icon-label">ì‚­ì œ</span>
          </div>   
        </button>
      </div>
      
      <div id="nav-buttons" class="button-group"  style="display: none;">
        <button id="btn-project-users" type="button" class="btn btn-link">ì‚¬ìš©ì ì„¤ì • ì´ë™ &#x279C;</button>          
      </div>

    </form>
  </div>
</div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="formatLoading">
  <div class="loading-content">
    <div class="spinner"></div>
    <div id="loading-text" style="text-align: center;"></div>
    <div >ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>
  </div>
</div>

<script>
// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™” ì§„í–‰
window.addEventListener('load', function() {
  document.getElementById("projects-detail-form").reset();
    const params = new URLSearchParams(window.location.search);
    const tenantId = params.get('tenantid');
    
    document.getElementById("tenantid").value = tenantId;
});

// ì„ íƒ í´ë¦­ â†’ í–‰ í´ë¦­ìœ¼ë¡œ ë³€ê²½
document.querySelectorAll("tbody tr[data-projectid]").forEach(row => {
  row.addEventListener("click", function () {
    // ê¸°ì¡´ form ì±„ìš°ê¸° ë¡œì§
    const tenantId = document.getElementById("tenantid").value;
    document.getElementById("projectid").value = row.dataset.projectid;
    document.getElementById("tenantid").value = tenantId;
    document.getElementById("projectnm").value = row.dataset.projectnm;
    document.getElementById("projectdesc").value = row.dataset.projectdesc;
    document.getElementById("useyn").checked = row.dataset.useyn === "True";
    document.getElementById("creator").value = row.dataset.creatornm;
    document.getElementById("createdts").value = row.dataset.createdts;
    // ì„œë²„ ì—°ê²°ì •ë³´ select ê°’ ì„¸íŒ…
    const accessKeyUid = row.dataset.access_key_uid;  // data-access_key_uid í•„ìš”
    document.getElementById("access_key_uid").value = accessKeyUid;

    showActionButtons(row.dataset.projectid);

    // ì„ íƒëœ í–‰ ê°•ì¡°
    document.querySelectorAll("tbody tr").forEach(r => r.classList.remove('selected-row'));
    row.classList.add('selected-row');
  });
});

// ì´ˆê¸°í™” ë²„íŠ¼
document.getElementById("reset-btn").addEventListener("click", () => {
  document.getElementById("projects-detail-form").reset();
  document.getElementById("projectid").value = "";
  const navButtons = document.getElementById("nav-buttons");
  navButtons.hidden = true;
  navButtons.style.display = "none";
  if (selectedRow) selectedRow.classList.remove("selected-row");
  selectedRow = null;
});

// ì €ì¥ ë²„íŠ¼
document.getElementById("save-btn").addEventListener("click", () => {
  const form = document.getElementById("projects-detail-form");
  const formData = new FormData(form);

  // showLoading('save')

  fetch("{% url 'master_projects_save' %}", {
    method: "POST",
    credentials: "include",   // ğŸ‘ˆ ì—¬ê¸°
    body: formData,
    headers: {
      "X-CSRFToken": getCookie("csrftoken")
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === "success") {
      alert(data.message);
      // hideLoading('save')
      location.reload();
    } else {
      alert("ì €ì¥ ì‹¤íŒ¨: " + (data.message || "ì„œë²„ ì˜¤ë¥˜"));
      // hideLoading('save')
    }
  })
  .catch(err => {
    alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message);
    // hideLoading('save')
  });
});

// ì‚­ì œ ë²„íŠ¼
document.getElementById("delete-btn").addEventListener("click", () => {
  const projectid = document.getElementById("projectid").value;
  
  if (!projectid) {
    alert("ì‚­ì œí•  í”„ë¡œì íŠ¸ì„ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  if (!confirm("ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?")) return;

  // showLoading('delete')

  fetch("{% url 'master_projects_delete' %}", {
    method: "POST",
    credentials: "include",   // ğŸ‘ˆ ì—¬ê¸°
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify({ projectid })
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === "success") {
      alert(data.message);
      // hideLoading('delete')
      location.reload();
    } else {
      alert("ì‚­ì œ ì‹¤íŒ¨: " + (data.message || "ì„œë²„ ì˜¤ë¥˜"));
      // hideLoading('delete')
    }
  })
  .catch(error => {
    alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message)
    // hideLoading('delete')
  });
});

// í•˜ë‹¨ í•­ëª© í‘œì‹œ
function showActionButtons(chapteruid) {
  const navButtons = document.getElementById("nav-buttons");
  navButtons.style.display = "flex";

  const projectid = document.getElementById("projectid").value;
  
  document.getElementById("btn-project-users").onclick = () => {
    const url = "{% url 'master_project_users' %}?projects=" + encodeURIComponent(projectid);
    window.location.href = url; // í˜„ì¬ ì°½ ì´ë™
  };
}

// ì¿ í‚¤ ì •ë³´
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

document.getElementById("back-btn").addEventListener("click", () => {
  // í•­ìƒ object ê´€ë¦¬ í˜ì´ì§€ë¡œ ì´ë™
  const backUrl = `/master/tenants/`;
  window.location.href = backUrl; // ìƒˆë¡œê³ ì¹¨ í¬í•¨í•œ ì™„ì „í•œ ì´ë™

});

</script>

{% endblock %}
