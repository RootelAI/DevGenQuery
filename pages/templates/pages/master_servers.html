{% extends 'pages/base.html' %}
{% load static %}
{% block title %}ì„œë²„ ì—°ê²°ì •ë³´{% endblock %}
{% block content %}

<style>
.form-group {
  margin-bottom: 10px;
}
</style>

<div class="page-title">
  <div style="display: flex; align-items: center;">
    <div class="gradient-bar"></div>
    <div>ì„œë²„ ì—°ê²°ì •ë³´</div>
  </div>
</div>

<div style="background-color: #f9fbe7; padding: 5px; margin-bottom: 5px; border-radius: 6px; color: #6a7d3c;">
  <p style="margin: 5px">ï¼Š ì„œë²„ ì—°ê²°ì •ë³´ì— ë“±ë¡ë˜ëŠ” ì„œë²„ EndPoint ì™€ ë¹„ë°€ë²ˆí˜¸ëŠ” í•´ë‹¹ ì‹œìŠ¤í…œì— ì €ì¥ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</p>
  <p style="margin: 5px">ï¼Š EndPoint ì™€ ë¹„ë°€ë²ˆí˜¸ëŠ” Azure KeyVault ì— ì•”í˜¸í™” ë˜ì–´ ì €ì¥ ë° ê´€ë¦¬ë©ë‹ˆë‹¤..</p>
</div>

<div style="display: flex; gap: 30px; padding-right: 10px;">
  <div style="flex: 50%;">
    <h3>ì„œë²„ ëª©ë¡</h3>

    <div class="table-container">
      <table id="servers-table">
        <thead>
          <tr>
            <th style="width: 15%;">ê¸°ì—…ëª…</th>
            <th style="width:  8%;">DBMS</th>
            <th style="width: 24%;">ì—°ê²°ìëª…</th>     
            <th style="width: 12%;">ë“±ë¡ìœ„ì¹˜</th>
            <th style="width: 12%;">ë“±ë¡ì¼ì‹œ</th>
            <!-- <th style="width: 13%;"></th> -->
          </tr>
        </thead>
        <tbody>
          {% for server in connectors %}
            <tr 
              data-access_key_uid="{{ server.access_key_uid }}" 
              data-tenantid="{{ server.tenantid }}"
              data-tenantnm="{{ server.tenantnm }}"
              data-accesskeynm="{{ server.accesskeynm }}"
              data-serverendpoint_dec="{{ server.serverendpoint_dec}}"
              data-userid="{{ server.userid }}"
              data-key_vault_nm="{{ server.key_vault_nm}}"
              data-creatornm="{{ server.creatornm }}"
              data-dbms="{{ server.dbms }}"
            >
              <td>{{ server.tenantnm|default_if_none:'' }}</td>
              <td style="text-align: center;">{{ server.dbms|default_if_none:'' }}</td>
              <td>{{ server.accesskeynm|default_if_none:'' }}</td>
              <td>{{ server.key_vault_nm }}</td>
              <td style="text-align: center;">{{ server.createdts }}</td>
            </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ìƒì„¸ì •ë³´ í¼ -->
  <div style="flex:50%;">
    <h3>ì„œë²„ ìƒì„¸</h3>

    <form id="server-detail-form" enctype="multipart/form-data">
      <input type="hidden" name="access_key_uid" id="access_key_uid">

      <div class="form-group"> 
        <label for="dbms">DBMS:</label>
        <select id="dbms" name="dbms" required>
          <option value="" selected disabled>DBMS ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
          {% for dbtype in dbtypes %}
            <option value="{{ dbtype.dbms }}">{{ dbtype.dbms }}</option>
          {% endfor %}
        </select>        
      </div>

      <div class="form-group"> 
        <label for="tenantnm">ê¸°ì—…ëª…:</label>
        <input type="text" name="tenantnm" id="tenantnm" disabled>
      </div>

      <div class="form-group"> 
        <label for="accesskeynm">ì—°ê²°ìëª…:</label>
        <input type="text" name="accesskeynm" id="accesskeynm">
      </div>

      <div class="form-group"> 
        <label for="serverendpoint">EndPoint:</label>
        <input type="text" name="serverendpoint" id="serverendpoint">
      </div>

      <div class="form-group"> 
        <label for="userid">ì‚¬ìš©ê³„ì •:</label>
        <input type="text" name="userid" id="userid">
      </div>

      <div class="form-group"> 
        <label for="creatornm">ìƒì„±ì:</label>
        <input type="text" name="creatornm" id="creatornm" disabled>
      </div>
      
      <div class="form-group">
        <label for="secret">ë¹„ë°€ë²ˆí˜¸:</label>
        <input type="password" name="secret" id="secret" placeholder="ë³€ê²½ ì‹œì—ë§Œ ì…ë ¥" autocomplete="new-secret">
      </div>

      <div class="form-group">
        <label for="secret_confirm">ë¹„ë°€ë²ˆí˜¸ í™•ì¸:</label>
        <input type="password" name="secret_confirm" id="secret_confirm" placeholder="ë¹„ë°€ë²ˆí˜¸ë¥¼ ë‹¤ì‹œ ì…ë ¥" autocomplete="new-password">
        <small style="color: #888;">â€» ê¸°ì¡´ ë¹„ë°€ë²ˆí˜¸ëŠ” í‘œì‹œë˜ì§€ ì•ŠìŠµë‹ˆë‹¤.</small>
      </div>

    <div class="button-group">
      <button id="reset-btn" type="button" class="icon-btn">
        <div class="icon-wrapper">
          <img src="{% static 'icons/new.svg' %}" class="icon-img new-icon" title="ì‹ ê·œ">
          <span class="icon-label">ì‹ ê·œ</span>
        </div> 
      </button>

      <!-- ì €ì¥ ë²„íŠ¼ -->
      <button id="save-btn" type="button" class="icon-btn">
        <div class="icon-wrapper">
          <img src="{% static 'icons/save.svg' %}" class="icon-img save-icon" title="ì €ì¥">
          <span class="icon-label">ì €ì¥</span>
        </div>  
      </button>

      <!-- ì‚­ì œ ë²„íŠ¼ -->
      <button id="delete-btn" type="button" class="icon-btn">
        <div class="icon-wrapper">
          <img src="{% static 'icons/delete.svg' %}" class="icon-img del-icon" title="ì‚­ì œ">
          <span class="icon-label">ì‚­ì œ</span>
        </div>  
      </button>
    </div>
    </form>
  </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
  const table = document.getElementById('servers-table');
  const form = document.getElementById('server-detail-form');
  let selectedRow = null;

  // âœ… ì„ íƒ ì‹œ ë¹„ë°€ë²ˆí˜¸ëŠ” ì ˆëŒ€ í‘œì‹œí•˜ì§€ ì•ŠìŒ
    // ğŸ”¹ í–‰ í´ë¦­ ì‹œ ì„ íƒ ì²˜ë¦¬
  table.addEventListener('click', function (e) {
    const row = e.target.closest('tr');
    if (!row || row.parentNode.tagName !== 'TBODY') return;

    // ì´ì „ ì„ íƒëœ í–‰ì´ ìˆìœ¼ë©´ ì œê±°
    if (selectedRow) selectedRow.classList.remove('selected-row');

    // ì´ì „ ì„ íƒëœ í–‰ì˜ ìŠ¤íƒ€ì¼ ì œê±°
    if (selectedRow) selectedRow.classList.remove('selected');
    selectedRow = row;
    selectedRow.classList.add('selected-row');

    // í¼ ì±„ìš°ê¸°
    document.getElementById('access_key_uid').value = row.getAttribute('data-access_key_uid');
    document.getElementById('tenantnm').value = row.getAttribute('data-tenantnm');
    document.getElementById('accesskeynm').value = row.getAttribute('data-accesskeynm');
    document.getElementById('serverendpoint').value = row.getAttribute('data-serverendpoint_dec');
    document.getElementById('userid').value = row.getAttribute('data-userid');
    document.getElementById('creatornm').value = row.getAttribute('data-creatornm');
    document.getElementById('secret').value = '';
    document.getElementById('secret_confirm').value = '';
    document.getElementById('dbms').value = row.getAttribute('data-dbms');
  });

  // âœ… ì €ì¥ ë²„íŠ¼ í´ë¦­
  document.getElementById('save-btn').addEventListener('click', function () {
    const pw = document.getElementById('secret').value.trim();
    const pwConfirm = document.getElementById('secret_confirm').value.trim();

    // ë‘ ë¹„ë°€ë²ˆí˜¸ ëª¨ë‘ ì…ë ¥ëœ ê²½ìš° ë¹„êµ
    if (pw || pwConfirm) {
      if (pw !== pwConfirm) {
        alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ë‹¤ì‹œ ì…ë ¥í•´ì£¼ì„¸ìš”.');
        return;
      }
    }

    const accesskeynm = document.getElementById('accesskeynm').value;
    if (!accesskeynm) {
      alert('ì €ì¥í•  ì—°ê²°ì •ë³´ë¥¼ ì…ë ¥í•˜ì„¸ìš”.');
      return;
    }

    const dbms = document.getElementById('dbms').value;
    if (!dbms || dbms == "") {
      alert('DBMSë¥¼ ì„ íƒí•˜ì„¸ìš”.');
      return;
    }

    const data = {
      access_key_uid: document.getElementById('access_key_uid').value,
      accesskeynm: document.getElementById('accesskeynm').value,
      serverendpoint: document.getElementById('serverendpoint').value,
      userid: document.getElementById('userid').value,
      dbms: document.getElementById('dbms').value
    };

    // ìƒˆ ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ ì‹œë§Œ ì¶”ê°€
    if (pw) data.secret = pw;

    fetch('/master/servers_save/', {
      method: 'POST',
      credentials: "include",   // ğŸ‘ˆ ì—¬ê¸°
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify(data)
    })
    .then(response => {
      if (!response.ok) throw new Error('ì €ì¥ ì‹¤íŒ¨');
      return response.json();
    })
    .then(result => {
      alert(result.message || 'ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤.');
      location.reload();
    })
    .catch(error => {
      alert('ì €ì¥ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message);
    });
  });

  // âœ… ì‚­ì œ ë²„íŠ¼
  document.getElementById('delete-btn').addEventListener('click', function () {
    const access_key_uid = document.getElementById('access_key_uid').value;
    if (!access_key_uid) {
      alert('ì‚­ì œí•  ì„œë²„ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”.');
      return;
    }
    if (!confirm('ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) return;

    fetch('/master/servers_delete/', {
      method: 'POST',
      credentials: "include",   // ğŸ‘ˆ ì—¬ê¸°
      headers: {
        'Content-Type': 'application/json',
        'X-CSRFToken': getCookie('csrftoken')
      },
      body: JSON.stringify({ access_key_uid })
    })
    .then(response => response.json())
    .then(() => {
      alert('ì‚­ì œë˜ì—ˆìŠµë‹ˆë‹¤.');
      location.reload();
    })
    .catch(error => alert('ì‚­ì œ ì¤‘ ì˜¤ë¥˜: ' + error.message));
  });

  // âœ… ì´ˆê¸°í™” ë²„íŠ¼
  document.getElementById('reset-btn').addEventListener('click', function () {
    form.reset();
    document.getElementById('access_key_uid').value = '';
    document.getElementById('dbms').selectedIndex = 0;
    if (selectedRow) selectedRow.classList.remove('selected');
    if (selectedRow) selectedRow.classList.remove('selected-row');
    selectedRow = null;
  });

  // âœ… CSRF í† í° í•¨ìˆ˜
  function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
      const cookies = document.cookie.split(';');
      for (let i = 0; i < cookies.length; i++) {
        const cookie = cookies[i].trim();
        if (cookie.substring(0, name.length + 1) === (name + '=')) {
          cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
          break;
        }
      }
    }
    return cookieValue;
  }
});
</script>
{% endblock %}
