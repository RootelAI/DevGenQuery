{% extends 'pages/base.html' %}
{% load static %}
{% block title %}RAG íŒŒì¼ ë§ˆìŠ¤í„°{% endblock %}

{% block content %}

<!-- âœ… ì¶”ê°€ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/virtual-select-plugin@1.0.45/dist/virtual-select.min.css">
<script src="https://cdn.jsdelivr.net/npm/virtual-select-plugin@1.0.45/dist/virtual-select.min.js"></script>

<style>
  .tag {
    max-height: 70px !important;
    width: 100% !important;
    max-width: 100% !important;
    padding: 0px !important;
  }
  
  .vscomp-toggle-button {
    padding: 2px 35px 2px 2px !important;
    border: 1px solid !important;
    min-height: 31px !important;
  }
  
  /* ğŸ”¥ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œë  ë•Œ ìŠ¤íƒ€ì¼ */
  .vscomp-value {
    display: block !important;
    white-space: normal !important;
    word-wrap: break-word !important;
    line-height: 1.5 !important;
    padding: 0px 5px !important;
    max-height: none !important;
    color: #111 !important;
  }

  .vscomp-arrow::after{
    border: 2px solid rgba(0,0,0,0) !important;
    border-bottom-color: #111 !important;
    border-right-color: #111 !important;
    margin-right: 12% !important;
    margin-left: auto !important;
  }

  .table td, .table th {
    word-break: break-word !important;
    overflow-wrap: break-word !important;
    white-space: normal !important;
    vertical-align: middle !important;
    padding: 3px 8px !important;
  }
</style>

<div class="page-title">
  <div style="display: flex; align-items: center;">
    <div class="gradient-bar"></div>
    <div>RAG íŒŒì¼ ë§ˆìŠ¤í„°</div>
  </div>
</div>

<div style="display: flex; gap: 20px; min-height: 80%;">
  <!-- ì™¼ìª½ -->
  <div style="flex: 2;" >
    <h3>íŒŒì¼ ë§ˆìŠ¤í„° ëª©ë¡</h3>
    <div class="table-container">
      <table class="table table-bordered table-sm" style="table-layout: fixed; width: 100%;">
        <thead>
          <tr>
            <th style="width: 70px;">í”„ë¡œì íŠ¸ëª…</th>
            <th style="width: 70px;">íŒŒì¼<br>ë§ˆìŠ¤í„°CD</th>
            <th style="width: 70px;">íŒŒì¼<br>ë§ˆìŠ¤í„°ëª…</th>
            <th style="width: 90px;">Tag1</th>
            <th style="width: 90px;">Tag2</th>
            <th style="width: 90px;">Tag3</th>
            <th style="width: 90px;">Tag4</th>
            <th style="width: 90px;">Tag5</th>
            <th style="width: 65px;">ì£¼ê´€ë¶€ì„œ</th>
            <th style="width: 65px;">ì°¸ì¡°ë¶€ì„œ</th>
            <th style="width: 65px;">ìŠ¹ì¸ë¶€ì„œ</th>
            <th style="width: 60px;">ì²˜ë¦¬êµ¬ë¶„</th>
            <th style="width: 60px;">ì²˜ë¦¬ì¼ì‹œ</th>
          </tr>
        </thead>
        <tbody>
          {% for file in filemasters %}
          <tr data-projectid="{{ file.projectid }}"
              data-projectnm="{{ file.projectnm }}"
              data-filemastercd="{{ file.filemastercd }}"
              data-filemasternm="{{ file.filemasternm }}"
              data-tag1value="{{ file.tag1value }}"
              data-tag2value="{{ file.tag2value }}"
              data-tag3value="{{ file.tag3value }}"
              data-tag4value="{{ file.tag4value }}"
              data-tag5value="{{ file.tag5value }}"
              data-owner_dept="{{ file.owner_dept }}"
              data-owner_deptnm="{{ file.owner_deptnm }}"
              data-support_dept="{{ file.support_dept }}"
              data-support_deptnm="{{ file.support_deptnm }}"
              data-approver_dept="{{ file.approver_dept }}"
              data-approver_deptnm="{{ file.approver_deptnm }}"
              data-processcd="{{ file.processcd }}"
              data-processdts="{{ file.processdts }}"
              data-creator="{{ file.creator }}"
              data-creatornm="{{ file.creatornm }}"
              data-createdts="{{ file.createdts }}"
              >
              <td style="text-align: center;">{{file.projectnm}}</td>
              <td style="text-align: center;">{{file.filemastercd}}</td>
              <td style="text-align: center;">{{file.filemasternm}}</td>
              <td style="text-align: center;">{{file.tag1valuenm}}</td>
              <td style="text-align: center;">{{file.tag2valuenm}}</td>
              <td style="text-align: center;">{{file.tag3valuenm}}</td>
              <td style="text-align: center;">{{file.tag4valuenm}}</td>
              <td style="text-align: center;">{{file.tag5valuenm}}</td>
              <td style="text-align: center;">{{file.owner_deptnm}}</td>
              <td style="text-align: center;">{{file.support_deptnm}}</td>
              <td style="text-align: center;">{{file.approver_deptnm}}</td>
              <td style="text-align: center;">
                {% if file.processcd == 'Y' %}
                    ì²˜ë¦¬
                {% elif file.processcd == 'D' %}
                    ì‚­ì œ
                {% else %}
                    ë¯¸ì²˜ë¦¬
                {% endif %}
              </td>
              <td >{{file.processdts|default_if_none:''}}</td>
          </tr>
          {% empty %}
          <tr>
              <td colspan="13" class="text-center text-muted py-4">ë“±ë¡ëœ íŒŒì¼ ë§ˆìŠ¤í„°ê°€ ì—†ìŠµë‹ˆë‹¤.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ì˜¤ë¥¸ìª½ -->
  <div style="flex: 0.7; padding-left: 20px;">
    <h3>ë§ˆìŠ¤í„° ìƒì„¸</h3>
    <form id="filemasters-detail-form" enctype="multipart/form-data">
      <input id="projectid" name="projectid" type="text" hidden>
      
      <div class="form-group-left">
        <label>í”„ë¡œì íŠ¸ëª…</label>
        <select id="projectnm" name="projectnm" required>
          <option value="" selected disabled>í”„ë¡œì íŠ¸ ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
          {% for project in projects %}
            <option value="{{ project.projectid }}">{{ project.projectnm }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group-left">
        <label>ë§ˆìŠ¤í„°ì½”ë“œ</label>
        <input id="filemastercd" name="filemastercd" type="text">
      </div>

      <div class="form-group-left">
        <label>ë§ˆìŠ¤í„°ëª…</label>
        <input id="filemasternm" name="filemasternm" type="text">
      </div>

      <!-- ğŸ”¥ Tag1~5ë¥¼ ëª¨ë‘ VirtualSelectë¡œ ë³€ê²½ -->
      <div class="form-group-left">
        <label>Tag1</label>
        <div id="tag1" class="form-group-left-input tag"></div>
        <input type="hidden" name="tag1" id="tag1_hidden">
      </div>

      <div class="form-group-left">
        <label>Tag2</label>
        <div id="tag2" class="form-group-left-input tag"></div>
        <input type="hidden" name="tag2" id="tag2_hidden">
      </div>

      <div class="form-group-left">
        <label>Tag3</label>
        <div id="tag3" class="form-group-left-input tag"></div>
        <input type="hidden" name="tag3" id="tag3_hidden">
      </div>

      <div class="form-group-left">
        <label>Tag4</label>
        <div id="tag4" class="form-group-left-input tag"></div>
        <input type="hidden" name="tag4" id="tag4_hidden">
      </div>

      <div class="form-group-left">
        <label>Tag5</label>
        <div id="tag5" class="form-group-left-input tag"></div>
        <input type="hidden" name="tag5" id="tag5_hidden">
      </div>

      <div class="form-group-left">
        <label>ì£¼ê´€ë¶€ì„œ</label>
        <select id="owner_dept" name="owner_dept" required>
          <option value="" selected disabled>ì£¼ê´€ë¶€ì„œ ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
          {% for dept in departments %}
            <option value="{{ dept.valuecd }}">{{ dept.valuenm }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group-left">
        <label>ì°¸ì¡°ë¶€ì„œ</label>
        <select id="support_dept" name="support_dept" required>
          <option value="" selected disabled>ì°¸ì¡°ë¶€ì„œ ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
          {% for dept in departments %}
            <option value="{{ dept.valuecd }}">{{ dept.valuenm }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group-left">
        <label>ìŠ¹ì¸ë¶€ì„œ</label>
        <select id="approver_dept" name="approver_dept" required>
          <option value="" selected disabled>ìŠ¹ì¸ë¶€ì„œ ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
          {% for dept in departments %}
            <option value="{{ dept.valuecd }}">{{ dept.valuenm }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group-left">
        <label>ì‘ì„±ì</label>
        <input id="creatornm" name="creatornm" type="text" disabled>
      </div>

      <div class="button-group">
        <button id="reset-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/new.svg' %}" class="icon-img new-icon" title="ì‹ ê·œ">
            <span class="icon-label">ì‹ ê·œ
          </div> 
        </button>

        <button id="save-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/save.svg' %}" class="icon-img save-icon" title="ì €ì¥">
            <span class="icon-label">ì €ì¥
          </div>  
        </button>

        <button id="delete-btn" type="button" class="icon-btn" disabled>
          <div class="icon-wrapper">
            <img src="{% static 'icons/delete.svg' %}" class="icon-img del-icon" title="ì‚­ì œ">
            <span class="icon-label">ì‚­ì œ
          </div>   
        </button>
      </div>
      
    </form>
  </div>
</div>

<script>
// Djangoì—ì„œ ì „ë‹¬ëœ ë°ì´í„°ë¥¼ JavaScript ë³€ìˆ˜ë¡œ ì €ì¥
const projectTagValues = {{ projecttagvalues_json|safe }}

const projectTags = {{projecttags_json|safe }}

// ğŸ”¥ ì „ì—­ ë³€ìˆ˜ - ê° íƒœê·¸ì˜ VirtualSelect ì¸ìŠ¤í„´ìŠ¤ì™€ í•¸ë“¤ëŸ¬ ì €ì¥
const tagVirtualSelects = {
  tag1: null,
  tag2: null,
  tag3: null,
  tag4: null,
  tag5: null
};

const tagChangeHandlers = {
  tag1: null,
  tag2: null,
  tag3: null,
  tag4: null,
  tag5: null
};

/**
 * ğŸ”¥ ê³µí†µ í•¨ìˆ˜: VirtualSelect ì´ˆê¸°í™” ë° ê°’ ì„¤ì •
 * @param {string} tagName - 'tag1', 'tag2' ë“±
 * @param {string} projectId - í”„ë¡œì íŠ¸ ID (ì—†ìœ¼ë©´ ë¹ˆ VirtualSelect ìƒì„±)
 * @param {string|array} selectedValue - ì„ íƒëœ ê°’
 */
// projectTagsì—ì„œ íŠ¹ì • projectId + tagNameì˜ uicomponent ê°€ì ¸ì˜¤ê¸°
function getTagUiComponent(projectId, tagName) {
  if (!projectId) return 'DS'; // ê¸°ë³¸ê°’
  const tagInfo = projectTags.find(t => String(t.projectid) === String(projectId) && t.tagcd === tagName);
  return tagInfo ? tagInfo.uicomponent : 'DS';
}

/**
 * ğŸ”¥ uicomponentì— ë”°ë¼ íƒœê·¸ UIë¥¼ ë™ì ìœ¼ë¡œ ë Œë”ë§
 */
function initTagComponent(tagName, projectId, selectedValue = null) {
  const tagContainer = document.getElementById(tagName);
  const hiddenInput = document.getElementById(`${tagName}_hidden`);

  if (tagVirtualSelects[tagName]) {
    tagVirtualSelects[tagName].destroy();
    tagVirtualSelects[tagName] = null;
  }
  if (tagChangeHandlers[tagName]) {
    tagContainer.removeEventListener('change', tagChangeHandlers[tagName]);
    tagChangeHandlers[tagName] = null;
  }

  tagContainer.innerHTML = '';
  hiddenInput.value = '';

  let options = [];
  if (projectId) {
    const tagKey = `${projectId}_${tagName}`;
    if (projectTagValues[tagKey]) {
      options = projectTagValues[tagKey].map(item => ({
        label: String(item.valuenm || '').trim(),
        value: String(item.valuecd || '').trim()
      }));
    }
  }

  let selectedVals = [];
  if (selectedValue && options.length > 0) {
    let values = Array.isArray(selectedValue)
      ? selectedValue
      : String(selectedValue).includes('&&&')
        ? String(selectedValue).split('&&&').map(v => v.trim())
        : [String(selectedValue).trim()];
    const availableValues = [...options.map(opt => opt.value), 'All'];
    selectedVals = values.filter(v => v !== '' && availableValues.includes(v));
  }

  const uiComponent = getTagUiComponent(projectId, tagName);
  const tagNumber = tagName.replace('tag', '');
  const placeholder = `Tag${tagNumber} ì„/ë¥¼ ì„ íƒí•˜ì„¸ìš”`;

  switch (uiComponent) {

    // â”€â”€â”€ Radio â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    case 'R': {
      tagContainer.style.cssText = 'display:flex;flex-wrap:wrap;gap:6px;align-items:center;overflow-y:auto;height:70px;border:1px solid;padding:4px;';

      if (options.length === 0) {
        tagContainer.innerHTML = `<span style="color:#999;font-size:12px;">í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”`;
        break;
      }

      // âœ… ì „ì²´ ë¼ë””ì˜¤ ë¨¼ì € ì¶”ê°€
      const allOptions = [{ label: 'ì „ì²´', value: 'All' }, ...options];
      const isAllSelected = selectedVals.length === 0 || selectedVals.includes('All');

      allOptions.forEach(opt => {
        const lbl = document.createElement('label');
        lbl.style.cssText = 'display:flex;align-items:center;gap:3px;font-size:13px;cursor:pointer;min-width:auto;';

        const radio = document.createElement('input');
        radio.type = 'radio';
        radio.name = `${tagName}_radio`;
        radio.value = opt.value;
        radio.style.cssText = 'flex: 0 !important; margin: 3px 7px;'
        if (opt.value === 'All') {
          radio.checked = isAllSelected;
        } else {
          radio.checked = selectedVals.includes(opt.value);
        }

        radio.addEventListener('change', () => {
          hiddenInput.value = radio.value; // 'All' ì´ê±°ë‚˜ íŠ¹ì • ê°’
        });

        lbl.appendChild(radio);
        lbl.appendChild(document.createTextNode(opt.label));
        tagContainer.appendChild(lbl);
      });

      hiddenInput.value = isAllSelected ? 'All' : (selectedVals[0] || 'All');
      break;
    }

    // â”€â”€â”€ CheckBox â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    case 'C': {
      tagContainer.style.cssText = 'display:flex;flex-wrap:wrap;gap:6px;align-items:center;overflow-y:auto;height:70px;border:1px solid;padding:4px;';

      if (options.length === 0) {
        tagContainer.innerHTML = `<span style="color:#999;font-size:12px;">í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”`;
        break;
      }

      const isAllSelected = selectedVals.length === 0 || selectedVals.includes('All');

      // âœ… ì „ì²´ ì²´í¬ë°•ìŠ¤ ë¨¼ì € ìƒì„±
      const allLbl = document.createElement('label');
      allLbl.style.cssText = 'display:flex;align-items:center;gap:3px;font-size:13px;cursor:pointer;font-weight:bold;min-width:auto;';
      const allCb = document.createElement('input');
      allCb.type = 'checkbox';
      allCb.value = 'All';
      allCb.checked = isAllSelected;
      allCb.style.cssText = 'flex: 0 !important; margin: 3px 7px;'
      allLbl.appendChild(allCb);
      allLbl.appendChild(document.createTextNode('ì „ì²´'));
      tagContainer.appendChild(allLbl);

      // ì¼ë°˜ ì²´í¬ë°•ìŠ¤ ìƒì„±
      const itemCheckboxes = [];
      options.forEach(opt => {
        const lbl = document.createElement('label');
        lbl.style.cssText = 'display:flex;align-items:center;gap:3px;font-size:13px;cursor:pointer;';

        const cb = document.createElement('input');
        cb.type = 'checkbox';
        cb.value = opt.value;
        cb.checked = !isAllSelected && selectedVals.includes(opt.value);

        lbl.appendChild(cb);
        lbl.appendChild(document.createTextNode(opt.label));
        tagContainer.appendChild(lbl);
        itemCheckboxes.push(cb);
      });

      const updateHidden = () => {
        if (allCb.checked) {
          hiddenInput.value = 'All';
        } else {
          const checked = itemCheckboxes.filter(cb => cb.checked).map(cb => cb.value);
          hiddenInput.value = checked.join('&&&');
        }
      };

      // âœ… ì „ì²´ í´ë¦­ ì‹œ ë‚˜ë¨¸ì§€ í•´ì œ
      allCb.addEventListener('change', () => {
        if (allCb.checked) {
          itemCheckboxes.forEach(cb => cb.checked = false);
        }
        updateHidden();
      });

      // âœ… ì¼ë°˜ í•­ëª© í´ë¦­ ì‹œ ì „ì²´ í•´ì œ
      itemCheckboxes.forEach(cb => {
        cb.addEventListener('change', () => {
          if (cb.checked) allCb.checked = false;
          // ì•„ë¬´ê²ƒë„ ì„ íƒ ì•ˆ ë˜ë©´ ì „ì²´ë¡œ ë˜ëŒë¦¬ê¸°
          if (!itemCheckboxes.some(c => c.checked)) allCb.checked = true;
          updateHidden();
        });
      });

      hiddenInput.value = isAllSelected ? 'All' : selectedVals.join('&&&');
      break;
    }

    // â”€â”€â”€ Dropdown Single Select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    case 'DS': {
      tagContainer.style.cssText = 'overflow-y:;height:29px;border:none;';

      // âœ… ì „ì²´ ì˜µì…˜ ë§¨ ì•ì— ì¶”ê°€
      const dsOptions = [{ label: 'ì „ì²´', value: 'All' }, ...options];
      const dsSelected = selectedVals.includes('All') || selectedVals.length === 0 ? 'All' : selectedVals[0];

      const vsConfig = {
        ele: `#${tagName}`,
        options: dsOptions,
        placeholder,
        search: true,
        multiple: false,
        disableSelectAll: true,
        selectedValue: dsSelected,
        noOptionsText: 'í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”',
        noSearchResultsText: 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤'
      };

      tagVirtualSelects[tagName] = VirtualSelect.init(vsConfig);
      hiddenInput.value = dsSelected;

      // âœ… init í›„ ëª…ì‹œì  setValue
      document.getElementById(tagName).setValue(dsSelected);

      tagChangeHandlers[tagName] = function () {
        const val = tagVirtualSelects[tagName].getValue();
        hiddenInput.value = val || 'All';
      };
      tagContainer.addEventListener('change', tagChangeHandlers[tagName]);
      break;
    }

    // â”€â”€â”€ Dropdown Multi Select â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
    case 'DM':
    default: {
      tagContainer.style.cssText = 'overflow-y:;height:29px;border:none;';

      const dmOptions = [{ label: 'ì „ì²´', value: 'All' }, ...options];
      const isAllDm = selectedVals.length === 0 || selectedVals.includes('All');
      const dmSelected = isAllDm ? ['All'] : selectedVals;

      const vsConfig = {
        ele: `#${tagName}`,
        options: dmOptions,
        placeholder,
        search: true,
        multiple: true,
        showValueAsTags: false,
        disableSelectAll: true,
        maxValues: 0,
        selectedValue: dmSelected,
        noOptionsText: 'í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”',
        noSearchResultsText: 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤'
      };

      tagVirtualSelects[tagName] = VirtualSelect.init(vsConfig);

      // âœ… getValueëŠ” ì¸ìŠ¤í„´ìŠ¤ì—ì„œ, setValueëŠ” DOMì—ì„œ
      const afterInit = tagVirtualSelects[tagName].getValue();
      document.getElementById(tagName).setValue(dmSelected);

      const afterSetValue = tagVirtualSelects[tagName].getValue();
      hiddenInput.value = isAllDm ? 'All' : dmSelected.join('&&&');

      let prevVal = isAllDm ? ['All'] : [...dmSelected];

      tagChangeHandlers[tagName] = function () {
      let val = tagVirtualSelects[tagName].getValue();
      if (!Array.isArray(val)) val = val ? [val] : [];

      const prevHadAll = prevVal.includes('All');
      const currHasAll = val.includes('All');

      if (currHasAll && !prevHadAll) {
        tagContainer.removeEventListener('change', tagChangeHandlers[tagName]);
        const ele = document.getElementById(tagName);
        ele.close();
        ele.setValue(['All']);
        hiddenInput.value = 'All';
        prevVal = ['All'];
        setTimeout(() => {
          tagContainer.addEventListener('change', tagChangeHandlers[tagName]);
        }, 100);

      } else if (currHasAll && prevHadAll) {
        const newVal = val.filter(v => v !== 'All');
        tagContainer.removeEventListener('change', tagChangeHandlers[tagName]);
        const ele = document.getElementById(tagName);
        ele.setValue(newVal);
        hiddenInput.value = newVal.join('&&&');
        prevVal = newVal;
        setTimeout(() => {
          tagContainer.addEventListener('change', tagChangeHandlers[tagName]);
        }, 100);

      } else if (val.length === 0) {
        tagContainer.removeEventListener('change', tagChangeHandlers[tagName]);
        const ele = document.getElementById(tagName);
        ele.setValue(['All']);
        hiddenInput.value = 'All';
        prevVal = ['All'];
        setTimeout(() => {
          tagContainer.addEventListener('change', tagChangeHandlers[tagName]);
        }, 100);

      } else {
        hiddenInput.value = val.join('&&&');
        prevVal = [...val];
      }
    };

    // âœ… isAllDmì´ë©´ ë¦¬ìŠ¤ë„ˆ ì—†ì´ setValue í›„ ë“±ë¡
    if (isAllDm) {
      setTimeout(() => {
        document.getElementById(tagName).setValue(['All']); // ë¦¬ìŠ¤ë„ˆ ì—†ëŠ” ìƒíƒœì—ì„œ í˜¸ì¶œ
        tagContainer.addEventListener('change', tagChangeHandlers[tagName]); // ê·¸ ë‹¤ìŒ ë“±ë¡
      }, 0);
    } else {
      tagContainer.addEventListener('change', tagChangeHandlers[tagName]);
    }

      tagContainer.addEventListener('change', tagChangeHandlers[tagName]);
      break;
    }
  }
}

 

/**
 * ğŸ”¥ ëª¨ë“  íƒœê·¸ ì´ˆê¸°í™”
 */
function resetAllTags() {
  ['tag1', 'tag2', 'tag3', 'tag4', 'tag5'].forEach(tagName => {
    if (tagVirtualSelects[tagName]) {
      tagVirtualSelects[tagName].reset();
      document.getElementById(`${tagName}_hidden`).value = '';
    }
  });
}

// 7ì ì´ˆê³¼ ì‹œ ... ì²˜ë¦¬í•˜ëŠ” í—¬í¼ í•¨ìˆ˜
function truncateLabel(text, maxLength = 7) {
  return text.length > maxLength ? text.substring(0, maxLength) + '...' : text;
}

/**
 * ğŸ”¥ projectIdì— ë”°ë¼ tag ë¼ë²¨ëª… ë™ì  ë³€ê²½
 */
function updateTagLabels(projectId) {
  // form-group-left ì˜ labelë“¤ì„ ìˆœì„œëŒ€ë¡œ ê°€ì ¸ì˜¤ê¸° (tag1~5 ìˆœì„œ)
  const tagLabels = {
    tag1: document.querySelector('#tag1').closest('.form-group-left').querySelector('label'),
    tag2: document.querySelector('#tag2').closest('.form-group-left').querySelector('label'),
    tag3: document.querySelector('#tag3').closest('.form-group-left').querySelector('label'),
    tag4: document.querySelector('#tag4').closest('.form-group-left').querySelector('label'),
    tag5: document.querySelector('#tag5').closest('.form-group-left').querySelector('label'),
  };

  if (!projectId) {
    // projectId ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ë³µì›
    Object.keys(tagLabels).forEach((tagName, i) => {
      if (tagLabels[tagName]) tagLabels[tagName].textContent = `Tag${i + 1}:`;
    });
    return;
  }

  // projectTagsì—ì„œ í•´ë‹¹ projectIdì˜ íƒœê·¸ëª… ì°¾ê¸°
  const filtered = projectTags.filter(t => String(t.projectid) === String(projectId));

  ['tag1', 'tag2', 'tag3', 'tag4', 'tag5'].forEach((tagName, i) => {
    const tagInfo = filtered.find(t => t.tagcd === tagName);
    if (tagLabels[tagName]) {
      tagLabels[tagName].textContent = tagInfo ? `${truncateLabel(tagInfo.tagnm)}` : `Tag${i + 1}`;
      tagLabels[tagName].title = tagInfo ? tagInfo.tagnm : '';  // âœ… hover ì‹œ ì „ì²´ ì´ë¦„ í‘œì‹œ
    }
  });
}

/**
 * í”„ë¡œì íŠ¸ ì„ íƒ ì‹œ ëª¨ë“  íƒœê·¸ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
 */
function updateTagDropdowns(projectId, selectedValues = {}) {
  ['tag1', 'tag2', 'tag3', 'tag4', 'tag5'].forEach(tagName => {
    initTagComponent(tagName, projectId, selectedValues[tagName] || null);
  })
};

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
window.addEventListener('load', function() {
  document.getElementById("filemasters-detail-form").reset();
  
  // ğŸ”¥ ëª¨ë“  íƒœê·¸ì— ëŒ€í•´ ë¹ˆ VirtualSelect ìƒì„± (placeholderë§Œ í‘œì‹œ)
  updateTagDropdowns(null);
});

// í”„ë¡œì íŠ¸ ì„ íƒ ë³€ê²½ ì‹œ íƒœê·¸ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
document.getElementById('projectnm').addEventListener('change', function() {
  const projectId = this.value;
  document.getElementById('projectid').value = projectId;
  updateTagDropdowns(projectId);
  updateTagLabels(projectId);
});

// í…Œì´ë¸” í–‰ í´ë¦­ ì‹œ
document.querySelectorAll("tbody tr[data-projectid]").forEach(row => {
  row.addEventListener("click", function () {
    const projectId = row.dataset.projectid;
    
    // í¼ í•„ë“œ ì±„ìš°ê¸°
    document.getElementById("projectid").value = projectId;
    document.getElementById("projectnm").value = projectId;
    document.getElementById("filemastercd").value = row.dataset.filemastercd;
    document.getElementById("filemasternm").value = row.dataset.filemasternm;
    document.getElementById("creatornm").value = row.dataset.creatornm;
    document.getElementById("owner_dept").value = row.dataset.owner_dept;
    document.getElementById("support_dept").value = row.dataset.support_dept;
    document.getElementById("approver_dept").value = row.dataset.approver_dept;
    
    // íƒœê·¸ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ ë° ì„ íƒëœ ê°’ ì„¤ì •
    updateTagDropdowns(projectId, {
      tag1: row.dataset.tag1value,
      tag2: row.dataset.tag2value,
      tag3: row.dataset.tag3value,
      tag4: row.dataset.tag4value,
      tag5: row.dataset.tag5value
    });
    updateTagLabels(projectId);

    // ì„ íƒëœ í–‰ ê°•ì¡°
    document.querySelectorAll("tbody tr").forEach(r => r.classList.remove('selected-row'));
    row.classList.add('selected-row');
  });
});

// ì´ˆê¸°í™” ë²„íŠ¼
document.getElementById("reset-btn").addEventListener("click", () => {
  document.getElementById("filemasters-detail-form").reset();
  document.getElementById("projectid").value = "";
  document.getElementById("filemastercd").value = "";
  
  // ğŸ”¥ ëª¨ë“  íƒœê·¸ ì´ˆê¸°í™” (ë¹ˆ VirtualSelectë¡œ ì¬ìƒì„±í•˜ì—¬ placeholder í‘œì‹œ)
  updateTagDropdowns(null);
  updateTagLabels(null);
  
  const navButtons = document.getElementById("nav-buttons");
  if (navButtons) {
    navButtons.hidden = true;
    navButtons.style.display = "none";
  }
  
  document.querySelectorAll("tbody tr").forEach(r => r.classList.remove("selected-row"));
});

// ì €ì¥ ë²„íŠ¼
document.getElementById("save-btn").addEventListener("click", () => {
  const form = document.getElementById("filemasters-detail-form");
  const formData = new FormData(form);
  
  // ë¡œë”© í‘œì‹œ
  const saveBtn = document.getElementById("save-btn");
  const originalText = saveBtn.querySelector('.icon-label').textContent;
  saveBtn.querySelector('.icon-label').textContent = 'ì €ì¥ì¤‘...';
  saveBtn.disabled = true;

  fetch("{% url 'master_rag_filemasters_save' %}", {
    method: "POST",
    credentials: "include", 
    body: formData,
    headers: {
      "X-CSRFToken": getCookie("csrftoken")
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === "success") {
      alert(data.message);
      location.reload();
    } else {
      alert("ì €ì¥ ì‹¤íŒ¨: " + (data.message || "ì„œë²„ ì˜¤ë¥˜"));
      saveBtn.querySelector('.icon-label').textContent = originalText;
      saveBtn.disabled = false;
    }
  })
  .catch(err => {
    alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message);
    saveBtn.querySelector('.icon-label').textContent = originalText;
    saveBtn.disabled = false;
  });
});

// ì‚­ì œ ë²„íŠ¼
document.getElementById("delete-btn").addEventListener("click", () => {
  const filemastercd = document.getElementById("filemastercd").value;
  const filemasternm = document.getElementById("filemasternm").value;
  
  if (!filemastercd) {
    alert("ì‚­ì œí•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  if (!confirm(`"${filemasternm}" íŒŒì¼ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
    return;
  }

  // ë¡œë”© í‘œì‹œ
  const deleteBtn = document.getElementById("delete-btn");
  const originalText = deleteBtn.querySelector('.icon-label').textContent;
  deleteBtn.querySelector('.icon-label').textContent = 'ì‚­ì œì¤‘...';
  deleteBtn.disabled = true;

  fetch("{% url 'master_rag_filemasters_delete' %}", {
    method: "POST",
    credentials: "include", 
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify({ filemastercd: filemastercd })
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === "success") {
      alert(data.message);
      location.reload();
    } else {
      alert("ì‚­ì œ ì‹¤íŒ¨: " + (data.message || "ì„œë²„ ì˜¤ë¥˜"));
      deleteBtn.querySelector('.icon-label').textContent = originalText;
      deleteBtn.disabled = false;
    }
  })
  .catch(error => {
    alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message);
    deleteBtn.querySelector('.icon-label').textContent = originalText;
    deleteBtn.disabled = false;
  });
});

// ì¿ í‚¤ ì •ë³´
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

</script>

{% endblock %}