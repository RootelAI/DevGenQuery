{% extends 'pages/base.html' %}
{% load static %}
{% block title %}RAG íŒŒì¼ ë§ˆìŠ¤í„°{% endblock %}

{% block content %}

<!-- âœ… ì¶”ê°€ -->
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/virtual-select-plugin@1.0.45/dist/virtual-select.min.css">
<script src="https://cdn.jsdelivr.net/npm/virtual-select-plugin@1.0.45/dist/virtual-select.min.js"></script>

<style>
  .tag {
    max-height: 31px !important;
    width: 100% !important;
    max-width: 100% !important;
    padding: 0px !important;
  }
  
  .vscomp-toggle-button {
    padding: 2px 35px 2px 2px !important;
    border: 1px solid !important;
    min-height: 31px !important;
  }
  
  /* ğŸ”¥ í…ìŠ¤íŠ¸ë¡œ í‘œì‹œë  ë•Œ ìŠ¤íƒ€ì¼ */
  .vscomp-value {
    display: block !important;
    white-space: normal !important;
    word-wrap: break-word !important;
    line-height: 1.5 !important;
    padding: 0px 5px !important;
    max-height: none !important;
    color: #111 !important;
  }

  .vscomp-arrow::after{
    border: 2px solid rgba(0,0,0,0) !important;
    border-bottom-color: #111 !important;
    border-right-color: #111 !important;
    margin-right: 12% !important;
    margin-left: auto !important;
  }
</style>

<div class="page-title">
  <div style="display: flex; align-items: center;">
    <div class="gradient-bar"></div>
    <div>RAG íŒŒì¼ ë§ˆìŠ¤í„°</div>
  </div>
</div>

<div style="display: flex; gap: 20px; min-height: 80%;">
  <!-- ì™¼ìª½ -->
  <div style="flex: 2;" >
    <h3>íŒŒì¼ ë§ˆìŠ¤í„° ëª©ë¡</h3>
    <div class="table-container">
      <table class="table table-bordered table-sm">
        <thead>
          <tr>
            <th style="width: 77px;">í”„ë¡œì íŠ¸ëª…</th>
            <th style="width: 77px;">íŒŒì¼<br>ë§ˆìŠ¤í„°CD</th>
            <th style="width: 77px;">íŒŒì¼<br>ë§ˆìŠ¤í„°ëª…</th>
            <th class="info" style="width: 77px;">Tag1</th>
            <th class="info" style="width: 77px;">Tag2</th>
            <th class="info" style="width: 77px;">Tag3</th>
            <th class="info" style="width: 77px;">Tag4</th>
            <th class="info" style="width: 77px;">Tag5</th>
            <th class="info" style="width: 77px;">ì£¼ê´€ë¶€ì„œ</th>
            <th class="info" style="width: 77px;">ì°¸ì¡°ë¶€ì„œ</th>
            <th class="info" style="width: 77px;">ìŠ¹ì¸ë¶€ì„œ</th>
            <th class="info" style="width: 77px;">ì²˜ë¦¬êµ¬ë¶„</th>
            <th class="info" style="width: 77px;">ì²˜ë¦¬ì¼ì‹œ</th>
          </tr>
        </thead>
        <tbody>
          {% for file in filemasters %}
          <tr data-projectid="{{ file.projectid }}"
              data-projectnm="{{ file.projectnm }}"
              data-filemastercd="{{ file.filemastercd }}"
              data-filemasternm="{{ file.filemasternm }}"
              data-tag1value="{{ file.tag1value }}"
              data-tag2value="{{ file.tag2value }}"
              data-tag3value="{{ file.tag3value }}"
              data-tag4value="{{ file.tag4value }}"
              data-tag5value="{{ file.tag5value }}"
              data-owner_dept="{{ file.owner_dept }}"
              data-owner_deptnm="{{ file.owner_deptnm }}"
              data-support_dept="{{ file.support_dept }}"
              data-support_deptnm="{{ file.support_deptnm }}"
              data-approver_dept="{{ file.approver_dept }}"
              data-approver_deptnm="{{ file.approver_deptnm }}"
              data-processcd="{{ file.processcd }}"
              data-processdts="{{ file.processdts }}"
              data-creator="{{ file.creator }}"
              data-creatornm="{{ file.creatornm }}"
              data-createdts="{{ file.createdts }}"
              >
              <td class="info" style="text-align: center;"><span>{{file.projectnm}}</span></td>
              <td class="info" style="text-align: center;"><span>{{file.filemastercd}}</span></td>
              <td class="info" style="text-align: center;"><span>{{file.filemasternm}}</span></td>
              <td class="info" style="text-align: center;"><span>{{file.tag1valuenm}}</span></td>
              <td class="info" style="text-align: center;"><span>{{file.tag2valuenm}}</span></td>
              <td class="info" style="text-align: center;"><span>{{file.tag3valuenm}}</span></td>
              <td class="info" style="text-align: center;"><span>{{file.tag4valuenm}}</span></td>
              <td class="info" style="text-align: center;"><span>{{file.tag5valuenm}}</span></td>
              <td class="info" style="text-align: center;"><span>{{file.owner_deptnm}}</span></td>
              <td class="info" style="text-align: center;"><span>{{file.support_deptnm}}</span></td>
              <td class="info" style="text-align: center;"><span>{{file.approver_deptnm}}</span></td>
              <td class="info" style="text-align: center;"><span>
                {% if file.processcd == 'Y' %}
                    ì²˜ë¦¬
                {% elif file.processcd == 'D' %}
                    ì‚­ì œ
                {% else %}
                    ë¯¸ì²˜ë¦¬
                {% endif %}
              </span></td>
              <td class="info"><span>{{file.processdts|default_if_none:''}}</span></td>
          </tr>
          {% empty %}
          <tr>
              <td colspan="10" class="text-center text-muted py-4">ë“±ë¡ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤.</td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- ì˜¤ë¥¸ìª½ -->
  <div style="flex: 0.5; padding-left: 20px;">
    <h3>ë§ˆìŠ¤í„° ìƒì„¸</h3>
    <form id="filemasters-detail-form" enctype="multipart/form-data">
      <input id="projectid" name="projectid" type="text" hidden>
      
      <div class="form-group-left">
        <label>í”„ë¡œì íŠ¸ëª…:</label>
        <select id="projectnm" name="projectnm" required>
          <option value="" selected disabled>í”„ë¡œì íŠ¸ ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
          {% for project in projects %}
            <option value="{{ project.projectid }}">{{ project.projectnm }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group-left">
        <label>ë§ˆìŠ¤í„°ì½”ë“œ:</label>
        <input id="filemastercd" name="filemastercd" type="text">
      </div>

      <div class="form-group-left">
        <label>ë§ˆìŠ¤í„°ëª…:</label>
        <input id="filemasternm" name="filemasternm" type="text">
      </div>

      <!-- ğŸ”¥ Tag1~5ë¥¼ ëª¨ë‘ VirtualSelectë¡œ ë³€ê²½ -->
      <div class="form-group-left">
        <label>Tag1:</label>
        <div id="tag1" class="form-group-left-input tag"></div>
        <input type="hidden" name="tag1" id="tag1_hidden">
      </div>

      <div class="form-group-left">
        <label>Tag2:</label>
        <div id="tag2" class="form-group-left-input tag"></div>
        <input type="hidden" name="tag2" id="tag2_hidden">
      </div>

      <div class="form-group-left">
        <label>Tag3:</label>
        <div id="tag3" class="form-group-left-input tag"></div>
        <input type="hidden" name="tag3" id="tag3_hidden">
      </div>

      <div class="form-group-left">
        <label>Tag4:</label>
        <div id="tag4" class="form-group-left-input tag"></div>
        <input type="hidden" name="tag4" id="tag4_hidden">
      </div>

      <div class="form-group-left">
        <label>Tag5:</label>
        <div id="tag5" class="form-group-left-input tag"></div>
        <input type="hidden" name="tag5" id="tag5_hidden">
      </div>

      <div class="form-group-left">
        <label>ì£¼ê´€ë¶€ì„œ:</label>
        <select id="owner_dept" name="owner_dept" required>
          <option value="" selected disabled>ì£¼ê´€ë¶€ì„œ ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
          {% for dept in departments %}
            <option value="{{ dept.valuecd }}">{{ dept.valuenm }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group-left">
        <label>ì°¸ì¡°ë¶€ì„œ:</label>
        <select id="support_dept" name="support_dept" required>
          <option value="" selected disabled>ì°¸ì¡°ë¶€ì„œ ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
          {% for dept in departments %}
            <option value="{{ dept.valuecd }}">{{ dept.valuenm }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group-left">
        <label>ìŠ¹ì¸ë¶€ì„œ:</label>
        <select id="approver_dept" name="approver_dept" required>
          <option value="" selected disabled>ì£¼ê´€ë¶€ì„œ ë¥¼ ì„ íƒí•˜ì„¸ìš”</option>
          {% for dept in departments %}
            <option value="{{ dept.valuecd }}">{{ dept.valuenm }}</option>
          {% endfor %}
        </select>
      </div>

      <div class="form-group-left">
        <label>ì‘ì„±ì:</label>
        <input id="creatornm" name="creatornm" type="text" disabled>
      </div>

      <div class="button-group">
        <button id="reset-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/new.svg' %}" class="icon-img new-icon" title="ì‹ ê·œ">
            <span class="icon-label">ì‹ ê·œ</span>
          </div> 
        </button>

        <button id="save-btn" type="button" class="icon-btn">
          <div class="icon-wrapper">
            <img src="{% static 'icons/save.svg' %}" class="icon-img save-icon" title="ì €ì¥">
            <span class="icon-label">ì €ì¥</span>
          </div>  
        </button>

        <button id="delete-btn" type="button" class="icon-btn" disabled>
          <div class="icon-wrapper">
            <img src="{% static 'icons/delete.svg' %}" class="icon-img del-icon" title="ì‚­ì œ">
            <span class="icon-label">ì‚­ì œ</span>
          </div>   
        </button>
      </div>
      
    </form>
  </div>
</div>

<script>
// Djangoì—ì„œ ì „ë‹¬ëœ ë°ì´í„°ë¥¼ JavaScript ë³€ìˆ˜ë¡œ ì €ì¥
const projectTagValues = {{ projecttagvalues_json|safe }};

// ğŸ”¥ ì „ì—­ ë³€ìˆ˜ - ê° íƒœê·¸ì˜ VirtualSelect ì¸ìŠ¤í„´ìŠ¤ì™€ í•¸ë“¤ëŸ¬ ì €ì¥
const tagVirtualSelects = {
  tag1: null,
  tag2: null,
  tag3: null,
  tag4: null,
  tag5: null
};

const tagChangeHandlers = {
  tag1: null,
  tag2: null,
  tag3: null,
  tag4: null,
  tag5: null
};

/**
 * ğŸ”¥ ê³µí†µ í•¨ìˆ˜: VirtualSelect ì´ˆê¸°í™” ë° ê°’ ì„¤ì •
 * @param {string} tagName - 'tag1', 'tag2' ë“±
 * @param {string} projectId - í”„ë¡œì íŠ¸ ID (ì—†ìœ¼ë©´ ë¹ˆ VirtualSelect ìƒì„±)
 * @param {string|array} selectedValue - ì„ íƒëœ ê°’
 */
function initTagVirtualSelect(tagName, projectId, selectedValue = null) {
  const tagContainer = document.getElementById(tagName);
  const hiddenInput = document.getElementById(`${tagName}_hidden`);
  
  // 1. ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ ì œê±°
  if (tagVirtualSelects[tagName]) {
    tagVirtualSelects[tagName].destroy();
    tagVirtualSelects[tagName] = null;
  }
  
  // 2. ì´ì „ ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ì œê±°
  if (tagChangeHandlers[tagName]) {
    tagContainer.removeEventListener('change', tagChangeHandlers[tagName]);
    tagChangeHandlers[tagName] = null;
  }

  // 3. ì»¨í…Œì´ë„ˆ ì´ˆê¸°í™”
  tagContainer.innerHTML = "";
  hiddenInput.value = '';
  
  // ğŸ”¥ 4. options ê°€ì ¸ì˜¤ê¸° (projectIdê°€ ì—†ìœ¼ë©´ ë¹ˆ ë°°ì—´)
  let options = [];
  if (projectId) {
    const tagKey = `${projectId}_${tagName}`;
    if (projectTagValues[tagKey]) {
      options = projectTagValues[tagKey].map(item => ({
        label: String(item.valuenm || '').trim(),
        value: String(item.valuecd || '').trim()
      }));
    }
  }

  // 5. ì„ íƒí•  ê°’ ë¯¸ë¦¬ ì²˜ë¦¬
  let selectedVals = [];
  if (selectedValue && options.length > 0) {
    let values = selectedValue;
    
    if (!Array.isArray(values)) {
      values = String(values).includes('&&&')
        ? String(values).split('&&&').map(v => v.trim())
        : [String(values).trim()];
    }
    
    values = values.map(v => String(v).trim()).filter(v => v !== '');
    const availableValues = options.map(opt => opt.value);
    selectedVals = values.filter(v => availableValues.includes(v));
  }

  // ğŸ”¥ 6. placeholder í…ìŠ¤íŠ¸ ìƒì„±
  const tagNumber = tagName.replace('tag', '');
  const placeholder = `Tag${tagNumber} ì„/ë¥¼ ì„ íƒí•˜ì„¸ìš”`;

  // 7. VirtualSelect ì´ˆê¸°í™” (ì˜µì…˜ì´ ì—†ì–´ë„ ìƒì„±)
  const vsConfig = {
    ele: `#${tagName}`,
    options: options,
    placeholder: placeholder,
    search: true,
    multiple: true,
    showValueAsTags: false,
    disableSelectAll: true,
    maxValues: 0,
    // ğŸ”¥ ì˜µì…˜ì´ ì—†ì„ ë•Œ ë©”ì‹œì§€
    noOptionsText: 'í”„ë¡œì íŠ¸ë¥¼ ë¨¼ì € ì„ íƒí•˜ì„¸ìš”',
    noSearchResultsText: 'ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤'
  };

  // ì´ˆê¸°ê°’ì´ ìˆìœ¼ë©´ ì„¤ì •
  if (selectedVals.length > 0) {
    vsConfig.selectedValue = selectedVals;
  }

  tagVirtualSelects[tagName] = VirtualSelect.init(vsConfig);

  // 8. hidden input ì—…ë°ì´íŠ¸
  hiddenInput.value = selectedVals.join('&&&');

  // 9. change ì´ë²¤íŠ¸ í•¸ë“¤ëŸ¬ ë“±ë¡
  tagChangeHandlers[tagName] = function() {
    const val = tagVirtualSelects[tagName].getValue();
    const valueStr = Array.isArray(val) ? val.join('&&&') : (val || '');
    hiddenInput.value = valueStr;
    console.log(`${tagName} changed:`, valueStr);
  };
  
  tagContainer.addEventListener('change', tagChangeHandlers[tagName]);
}


/**
 * ğŸ”¥ ëª¨ë“  íƒœê·¸ ì´ˆê¸°í™”
 */
function resetAllTags() {
  ['tag1', 'tag2', 'tag3', 'tag4', 'tag5'].forEach(tagName => {
    if (tagVirtualSelects[tagName]) {
      tagVirtualSelects[tagName].reset();
      document.getElementById(`${tagName}_hidden`).value = '';
    }
  });
}

/**
 * í”„ë¡œì íŠ¸ ì„ íƒ ì‹œ ëª¨ë“  íƒœê·¸ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
 */
function updateTagDropdowns(projectId, selectedValues = {}) {
  // ğŸ”¥ projectIdê°€ ì—†ì–´ë„ placeholderë¥¼ ë³´ì—¬ì£¼ê¸° ìœ„í•´ VirtualSelect ìƒì„±
  initTagVirtualSelect('tag1', projectId, selectedValues.tag1);
  initTagVirtualSelect('tag2', projectId, selectedValues.tag2);
  initTagVirtualSelect('tag3', projectId, selectedValues.tag3);
  initTagVirtualSelect('tag4', projectId, selectedValues.tag4);
  initTagVirtualSelect('tag5', projectId, selectedValues.tag5);
}

// í˜ì´ì§€ ë¡œë“œ ì‹œ ì´ˆê¸°í™”
window.addEventListener('load', function() {
  document.getElementById("filemasters-detail-form").reset();
  
  // ğŸ”¥ ëª¨ë“  íƒœê·¸ì— ëŒ€í•´ ë¹ˆ VirtualSelect ìƒì„± (placeholderë§Œ í‘œì‹œ)
  updateTagDropdowns(null);
});

// í”„ë¡œì íŠ¸ ì„ íƒ ë³€ê²½ ì‹œ íƒœê·¸ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸
document.getElementById('projectnm').addEventListener('change', function() {
  const projectId = this.value;
  document.getElementById('projectid').value = projectId;
  updateTagDropdowns(projectId);
});

// í…Œì´ë¸” í–‰ í´ë¦­ ì‹œ
document.querySelectorAll("tbody tr[data-projectid]").forEach(row => {
  row.addEventListener("click", function () {
    const projectId = row.dataset.projectid;
    
    // í¼ í•„ë“œ ì±„ìš°ê¸°
    document.getElementById("projectid").value = projectId;
    document.getElementById("projectnm").value = projectId;
    document.getElementById("filemastercd").value = row.dataset.filemastercd;
    document.getElementById("filemasternm").value = row.dataset.filemasternm;
    document.getElementById("creatornm").value = row.dataset.creatornm;
    document.getElementById("owner_dept").value = row.dataset.owner_dept;
    document.getElementById("support_dept").value = row.dataset.support_dept;
    document.getElementById("approver_dept").value = row.dataset.approver_dept;
    
    // íƒœê·¸ ë“œë¡­ë‹¤ìš´ ì—…ë°ì´íŠ¸ ë° ì„ íƒëœ ê°’ ì„¤ì •
    updateTagDropdowns(projectId, {
      tag1: row.dataset.tag1value,
      tag2: row.dataset.tag2value,
      tag3: row.dataset.tag3value,
      tag4: row.dataset.tag4value,
      tag5: row.dataset.tag5value
    });

    // ì„ íƒëœ í–‰ ê°•ì¡°
    document.querySelectorAll("tbody tr").forEach(r => r.classList.remove('selected-row'));
    row.classList.add('selected-row');
  });
});

// ì´ˆê¸°í™” ë²„íŠ¼
document.getElementById("reset-btn").addEventListener("click", () => {
  document.getElementById("filemasters-detail-form").reset();
  document.getElementById("projectid").value = "";
  document.getElementById("filemastercd").value = "";
  
  // ğŸ”¥ ëª¨ë“  íƒœê·¸ ì´ˆê¸°í™” (ë¹ˆ VirtualSelectë¡œ ì¬ìƒì„±í•˜ì—¬ placeholder í‘œì‹œ)
  updateTagDropdowns(null);
  
  const navButtons = document.getElementById("nav-buttons");
  if (navButtons) {
    navButtons.hidden = true;
    navButtons.style.display = "none";
  }
  
  document.querySelectorAll("tbody tr").forEach(r => r.classList.remove("selected-row"));
});

// ì €ì¥ ë²„íŠ¼
document.getElementById("save-btn").addEventListener("click", () => {
  const form = document.getElementById("filemasters-detail-form");
  const formData = new FormData(form);
  
  // ë¡œë”© í‘œì‹œ
  const saveBtn = document.getElementById("save-btn");
  const originalText = saveBtn.querySelector('.icon-label').textContent;
  saveBtn.querySelector('.icon-label').textContent = 'ì €ì¥ì¤‘...';
  saveBtn.disabled = true;

  fetch("{% url 'master_rag_filemasters_save' %}", {
    method: "POST",
    credentials: "include", 
    body: formData,
    headers: {
      "X-CSRFToken": getCookie("csrftoken")
    }
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === "success") {
      alert(data.message);
      location.reload();
    } else {
      alert("ì €ì¥ ì‹¤íŒ¨: " + (data.message || "ì„œë²„ ì˜¤ë¥˜"));
      saveBtn.querySelector('.icon-label').textContent = originalText;
      saveBtn.disabled = false;
    }
  })
  .catch(err => {
    alert("ì˜¤ë¥˜ ë°œìƒ: " + err.message);
    saveBtn.querySelector('.icon-label').textContent = originalText;
    saveBtn.disabled = false;
  });
});

// ì‚­ì œ ë²„íŠ¼
document.getElementById("delete-btn").addEventListener("click", () => {
  const filemastercd = document.getElementById("filemastercd").value;
  const filemasternm = document.getElementById("filemasternm").value;
  
  if (!filemastercd) {
    alert("ì‚­ì œí•  íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”.");
    return;
  }

  if (!confirm(`"${filemasternm}" íŒŒì¼ì„ ì •ë§ ì‚­ì œí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n(Azure Blob Storageì˜ íŒŒì¼ë„ í•¨ê»˜ ì‚­ì œë©ë‹ˆë‹¤)`)) {
    return;
  }

  // ë¡œë”© í‘œì‹œ
  const deleteBtn = document.getElementById("delete-btn");
  const originalText = deleteBtn.querySelector('.icon-label').textContent;
  deleteBtn.querySelector('.icon-label').textContent = 'ì‚­ì œì¤‘...';
  deleteBtn.disabled = true;

  fetch("{% url 'master_rag_filemasters_delete' %}", {
    method: "POST",
    credentials: "include", 
    headers: {
      "Content-Type": "application/json",
      "X-CSRFToken": getCookie("csrftoken")
    },
    body: JSON.stringify({ filemastercd: filemastercd })
  })
  .then(res => res.json())
  .then(data => {
    if (data.result === "success") {
      alert(data.message);
      location.reload();
    } else {
      alert("ì‚­ì œ ì‹¤íŒ¨: " + (data.message || "ì„œë²„ ì˜¤ë¥˜"));
      deleteBtn.querySelector('.icon-label').textContent = originalText;
      deleteBtn.disabled = false;
    }
  })
  .catch(error => {
    alert("ì˜¤ë¥˜ ë°œìƒ: " + error.message);
    deleteBtn.querySelector('.icon-label').textContent = originalText;
    deleteBtn.disabled = false;
  });
});

// ì¿ í‚¤ ì •ë³´
function getCookie(name) {
  let cookieValue = null;
  if (document.cookie && document.cookie !== '') {
    const cookies = document.cookie.split(';');
    for (let cookie of cookies) {
      cookie = cookie.trim();
      if (cookie.startsWith(name + '=')) {
        cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
        break;
      }
    }
  }
  return cookieValue;
}

</script>

{% endblock %}