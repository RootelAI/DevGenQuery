<!-- âœ… Tom Select ë¼ì´ë¸ŒëŸ¬ë¦¬ ì¶”ê°€ -->
<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

<style>
@keyframes spin {
  0% { transform: rotate(0deg); }
  100% { transform: rotate(360deg); }
}  
/* ì¡°íšŒ ì†ë„ ëŠë¦´ë•Œ í™”ë©´ overlay ë¡œ ì¡°íšŒì¤‘ì´ë€ ë©”ì‹œì§€ ë¿Œë¦´ë•Œ ì‚¬ìš© ì‹œì‘ */
#signup_formatLoading {
  position: fixed;
  top: 0;
  left: 0;
  width: 100vw;
  height: 100vh;
  background: var(--white-shadow); /* ë°˜íˆ¬ëª… í°ìƒ‰ */
  display: none;
  align-items: center;
  justify-content: center;
  z-index: 9999; /* ì œì¼ ìœ„ë¡œ */
}

#signup_formatLoading .signup_loading-content {
  background: var(--loadingback-color);
  padding: 15px 25px;
  border-radius: 8px;
  color: var(--gray-600);
  font-size: 16px;
  font-weight: bold;
  box-shadow: 0 2px 6px var(--black-shadow);
}

/* íšŒì› ê°€ì… */
.signup_base_modal_content {
    background: var(--white);
    padding: 30px 25px;
    border-radius: 12px;
    width: 360px;
    height: 615px;
    box-shadow: 0 8px 24px var(--black-shadow);
    text-align: center;
}
</style>

<meta name="csrf-token" content="{{ csrf_token }}">

<!-- íšŒì›ê°€ì… -->
<div id="signup_base_modal" class="base_modal_overlay" style="display: none;">
    <div class="signup_base_modal_content" style="position: relative">
        <!-- âœ… ë‹«ê¸° ë²„íŠ¼ -->
        <button id="signup_base_modal_close" style="
            position: absolute;
            top: 10px;
            right: 10px;
            background: transparent;
            border: none;
            font-size: 20px;
            cursor: pointer;
        ">&times;</button>

        <h2 style="font-weight: bold;">GenQuery íšŒì›ê°€ì…</h2>

        <!-- âœ… ë“œë¡­ë°•ìŠ¤ ìë¦¬ -->
        <label class="modal_label">
          <span class="modal_span">ì‚¬ìš© ëª¨ë¸</span>
          <div class="base_modal_input" style="width: 70%;" id="billingmodelcd" >
            <label class="radio-inline">
              <input type="radio" name="billingmodelcd" value="single" checked>
              ê°œì¸
            </label>
            <label class="radio-inline" style="margin-left: 10%;">
              <input type="radio" name="billingmodelcd" value="multi">
              ë‹¨ì²´
            </label>
          </div>
        </label>

        <!-- âœ… ê°œì¸ ì„ íƒ ì‹œ Free ì™€ Pro ë‚˜ì˜´ -->
        <label id="single_selector" class="modal_label">
          <span class="modal_span">ìš”ê¸ˆì œ</span>
          <select id="signup_single" class="base_modal_input" style="width: 77%; height: 42px;"> <!--required> -->
            <option value="Fr" selected>Free ì‚¬ìš©ì</option>
            <option value="Pr">Pro ì‚¬ìš©ì</option>
          </select>
        </label>

        <!-- âœ… ë‹¨ì²´ ì„ íƒ ì‹œ Tenant ì •ë³´ ë‚˜ì˜´ -->
        <label id="tenant_selector" class="modal_label" style="display: none;">
          <span class="modal_span">ê¸°ì—…</span>
          <select id="signup_tenant" class="base_modal_input" style="width: 71%;"> <!--required> -->
            <option value="">ê¸°ì—…ì„ ì„ íƒí•˜ì„¸ìš”</option>
          </select>
        </label>

        <label class="modal_label">
            <span class="modal_span">ì‚¬ìš©ìëª…</span>
            <input type="text" id="signup_usernm" placeholder="ì‚¬ìš©ìëª…" class="base_modal_input" style="width: 70%;" required/>
        </label>

        <label class="modal_label">
            <span class="modal_span">ì´ë©”ì¼</span>
            <input type="email" id="signup_email" placeholder="ì´ë©”ì¼" class="base_modal_input" style="width: 70%;" required/>
        </label>

        <label class="modal_label">
            <span class="modal_span">ë¹„ë°€ë²ˆí˜¸</span>
            <input type="password" id="signup_password" placeholder="ë¹„ë°€ë²ˆí˜¸" class="base_modal_input" style="width: 70%;" required/>
        </label>

        <!-- ì•ˆ ë³´ì´ëŠ” ë”ë¯¸ í•„ë“œ -->
        <input type="text" style="position: absolute; left: -9999px; top: -9999px;" autocomplete="off">
        
        <label class="modal_label">
            <span class="modal_span">ë¹„ë°€ë²ˆí˜¸ í™•ì¸</span>
            <input type="password" id="signup_password_confirm" placeholder="ë¹„ë°€ë²ˆí˜¸ í™•ì¸" class="base_modal_input" style="width: 70%;" required/>
        </label>

        <label class="modal_label">
          <input type="checkbox" id="agree_all" />
          <span style="font-size: 14px; margin-left: 1%;">ì „ì²´ ë™ì˜í•©ë‹ˆë‹¤. </span>
        </label>
        <label class="modal_label" style="display: block; margin-top: 10px; text-align: left;">
          <input type="checkbox" id="userinfoyn" />
          <span style="font-size: 14px; margin-left: 1%;">
            <a href="{% url 'terms_conditions' %}?terms=collection" target="_blank" style="color: #0f6efd; text-decoration: underline;">ê°œì¸ì •ë³´ìˆ˜ì§‘ë™ì˜ì—¬ë¶€</a> (í•„ìˆ˜)
          </span>
        </label>
        <label class="modal_label" style="display: block; margin-top: 10px; text-align: left;">
            <input type="checkbox" id="termsofuseyn" />
            <span style="font-size: 14px; margin-left: 1%;">
              <a href="{% url 'terms_conditions' %}?terms=service" target="_blank" style="color: #0f6efd; text-decoration: underline;">GenQuery ì´ìš©ì•½ê´€</a>
              ì— ë™ì˜í•©ë‹ˆë‹¤. (í•„ìˆ˜)
            </span>
        </label>
        <label class="modal_label" style="display: block; margin-top: 10px; text-align: left;">
          <input type="checkbox" id="marketingyn" />
          <span style="font-size: 14px; margin-left: 1%;">
            <a href="{% url 'terms_conditions' %}?terms=marketing" target="_blank" style="color: #0f6efd; text-decoration: underline;">ë§ˆì¼€íŒ…ë™ì˜ì—¬ë¶€</a>
            (ì„ íƒ)</span>
        </label>

        <button id="signup_submit" class="btn btn-save" style="margin-top: 8%" disabled>íšŒì›ê°€ì…</button>
    </div>
</div>

<!-- ë¡œë”© ì˜¤ë²„ë ˆì´ -->
<div id="signup_formatLoading">
  <div class="signup_loading-content">
    <div class="signup_spinner"></div>
    <div id="signup_loading-text" style="text-align: left; white-space: pre-line;"></div>
    <div style="text-align: left;">ì ì‹œë§Œ ê¸°ë‹¤ë ¤ ì£¼ì„¸ìš”.</div>
  </div>
</div>


<script>
// ë¡œë”© ìƒíƒœ ê´€ë¦¬ í•¨ìˆ˜ë“¤
  function signup_showLoading() {
    const overlay = document.getElementById('signup_formatLoading');
    const text = document.getElementById('signup_loading-text');
    
    // ì˜¤ë²„ë ˆì´ í‘œì‹œ
    overlay.style.display = 'flex';
  }

  function signup_hideLoading() {
    const overlay = document.getElementById('signup_formatLoading');
    const text = document.getElementById('signup_loading-text');
    
    // ì˜¤ë²„ë ˆì´ ìˆ¨ê¸°ê¸°
    overlay.style.display = 'none';
    text.textContent = '';
  }


// âœ… CSRF ì¿ í‚¤ì—ì„œ êº¼ë‚´ê¸°
function getCookie(name) {
    let cookieValue = null;
    if (document.cookie && document.cookie !== '') {
        const cookies = document.cookie.split(';');
        for (let cookie of cookies) {
            cookie = cookie.trim();
            if (cookie.startsWith(name + '=')) {
                cookieValue = decodeURIComponent(cookie.slice(name.length + 1));
                break;
            }
        }
    }
    return cookieValue;
}
// const csrftoken = getCookie('csrftoken');


// âœ… íšŒì›ê°€ì… ëª¨ë‹¬ í‘œì‹œ
async function show_signup_base_modal(plan = null){
  signup_showLoading()


  // --------------------------
  // ğŸ”¥ â‘  planì´ ìˆì„ ë•Œë§Œ ê¸°ë³¸ ì„¤ì • ì ìš© 
  //    (ê¸°ì¡´ í˜¸ì¶œì€ plan=null â†’ ì•„ë¬´ê²ƒë„ ë³€í™” ì—†ìŒ)
  // --------------------------
  if (plan !== null) {

      // ê¸°ë³¸ê°’ ì´ˆê¸°í™”
      document.querySelector("input[name='billingmodelcd'][value='single']").checked = true;
      document.getElementById("single_selector").style.display = "flex";
      document.getElementById("tenant_selector").style.display = "none";
      document.getElementById("signup_single").value = "Fr"; // ê¸°ë³¸ Free
      document.getElementById("signup_tenant").value = "";

      // í”Œëœë³„ ì˜¤í†  ì„¤ì •
      if (plan === "free") {
          // ê°œì¸ Free
          document.querySelector("input[name='billingmodelcd'][value='single']").checked = true;
          document.getElementById("signup_single").value = "Fr";

      } else if (plan === "pro") {
          // ê°œì¸ Pro
          document.querySelector("input[name='billingmodelcd'][value='single']").checked = true;
          document.getElementById("signup_single").value = "Pr";

      } else if (plan === "teams") {
          // ë‹¨ì²´ Teams
          document.querySelector("input[name='billingmodelcd'][value='multi']").checked = true;
          document.getElementById("single_selector").style.display = "none";
          document.getElementById("tenant_selector").style.display = "flex";

      } else if (plan === "enterprise") {
          // ë‹¨ì²´ Enterprise
          document.querySelector("input[name='billingmodelcd'][value='multi']").checked = true;
          document.getElementById("single_selector").style.display = "none";
          document.getElementById("tenant_selector").style.display = "flex";
      }
  }

  try {
    const res = await fetch("{% url 'get_tenants' %}", {
      method: "POST",
      credentials: "include",   // ğŸ‘ˆ ì—¬ê¸°
      headers: { "X-CSRFToken": getCookie("csrftoken") }
    });
    const data = await res.json();

    if (data.result === "success") {
      const tenantSelect = document.getElementById("signup_tenant");
      const multitenantyn = data.multitenantyn

      if (multitenantyn == true) {
        tenantSelect.innerHTML = '<option value="">ê¸°ì—…ì„ ì„ íƒí•˜ì„¸ìš”</option>';
      }
      

      // âœ… ì„œë²„ì—ì„œ ê°€ì ¸ì˜¨ ì˜µì…˜ ì±„ìš°ê¸°
      data.tenants.forEach(tenant => {
        const opt = document.createElement("option");
        opt.value = tenant.tenantid;
        opt.textContent = tenant.tenantnm;
        tenantSelect.appendChild(opt);
      });

      // âœ… TomSelect ì¬ì´ˆê¸°í™” (ê¸°ì¡´ ì¸ìŠ¤í„´ìŠ¤ ì œê±° í›„ ìƒˆë¡œ)
      if (window.signupTenantSelect) {
        window.signupTenantSelect.destroy();
      }

      window.signupTenantSelect = new TomSelect("#signup_tenant", {
        placeholder: "ê¸°ì—…ì„ ê²€ìƒ‰í•˜ê±°ë‚˜ ì„ íƒí•˜ì„¸ìš”",
        create: false,
        openOnFocus: true,
        maxOptions: 500,
        allowEmptyOption: true,
        sortField: { field: "text", direction: "asc" },
        render: {
          option: (data, escape) => `<div>${escape(data.text)}</div>`,
          item: (data, escape) => `<div>${escape(data.text)}</div>`
        },
        onInitialize: function() {
          this.on('focus', () => this.open());
        }
      });

      // multitenantyn ì´ false ì¸ ê²½ìš° ì™¸ë¶€ ì„œë²„ ë°°í¬ ëœ ìƒíƒœ ì´ë¯€ë¡œ í•˜ë‚˜ì˜ í…Œë„Œë“œ ë°–ì— ì—†ìŒ
      if (multitenantyn == false && data.tenants.length > 0) {
        window.signupTenantSelect.setValue(data.tenants[0].tenantid);
      }

      document.getElementById("signup_base_modal").style.display = "flex";
      signup_hideLoading()
    } else {
      signup_hideLoading()
      alert("í…Œë„ŒíŠ¸ ì¡°íšŒ ì‹¤íŒ¨: " + (data.message || "ì„œë²„ ì˜¤ë¥˜"));
    }
  } catch (err) {
    signup_hideLoading()
    alert("í…Œë„ŒíŠ¸ ì¡°íšŒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message);
  }
}

// íšŒì›ê°€ì… ì €ì¥ ë²„íŠ¼ í´ë¦­ ì‹œ
document.getElementById('signup_submit').addEventListener('click', async () => {
    const usernm = document.getElementById("signup_usernm").value.trim();
    const email = document.getElementById('signup_email').value.trim();
    const password = document.getElementById('signup_password').value;
    const password_confirm = document.getElementById("signup_password_confirm").value;
    const tenant = document.getElementById('signup_tenant').value;
    const single = document.getElementById('signup_single').value;
    // const billingmodelcd = document.getElementByName('billingmodelcd').value;
    const billingmodelcd = document.querySelector("input[name='billingmodelcd']:checked")?.value || "";
    const termsofuseyn = document.getElementById("termsofuseyn").checked;
    const userinfoyn = document.getElementById("userinfoyn").checked;
    const marketingyn = document.getElementById("marketingyn").checked;

    if (!termsofuseyn || !userinfoyn){
      alert("í•„ìˆ˜ ì•½ê´€ì— ë™ì˜ í•˜ì…”ì•¼ í•©ë‹ˆë‹¤.");
      return;
    }

    if ((billingmodelcd == "single") && !single){
      alert('ë‹¨ì²´ëŠ” ê¸°ì—… ì„ íƒì´ í•„ìˆ˜ì…ë‹ˆë‹¤.');
      return;
    }

    if ((billingmodelcd == "multi") && !tenant){
      alert('ë‹¨ì²´ëŠ” ê¸°ì—… ì„ íƒì´ í•„ìˆ˜ì…ë‹ˆë‹¤.');
      return;
    }

    if (!usernm){
      alert("ì´ë¦„ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.");
      return;
    }
    
    if (!email) {
      alert('ì´ë©”ì¼ì„ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    if (!password) {
      alert('ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•´ì£¼ì„¸ìš”.');
      return;
    }
    if (password !== password_confirm) {
      alert('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.');
      return;
    }
    if (password.length < 8) {
      alert('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 8ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤.');
      return;
    }

    const formData = new FormData();
    formData.append('email', email);
    formData.append('password', password);
    formData.append('password_confirm', password_confirm);
    formData.append('single', single);
    formData.append('tenant', tenant);
    formData.append('billingmodelcd', billingmodelcd);
    formData.append('usernm', usernm);
    formData.append('userinfoyn', userinfoyn);
    formData.append('termsofuseyn', termsofuseyn);
    formData.append('marketingyn', marketingyn);

    document.getElementById("signup_usernm").value = "";
    document.getElementById("signup_email").value = "";
    document.getElementById("signup_password").value = "";
    document.getElementById("signup_password_confirm").value = "";
    document.getElementById("signup_usernm").disabled = true;
    document.getElementById("signup_email").disabled = true;
    document.getElementById("signup_password").disabled = true;
    document.getElementById("signup_password_confirm").disabled = true;
    document.getElementById('signup_tenant').value = "";
    document.getElementById('signup_single').value = "";
    document.getElementById('agree_all').checked = false;
    document.getElementById('userinfoyn').checked = false;
    document.getElementById('termsofuseyn').checked = false;
    document.getElementById('marketingyn').checked = false;

    const btn = document.getElementById('signup_submit');
    btn.disabled = true;
    btn.textContent = 'ê°€ì… ì¤‘...';

    try {
      const response = await fetch('/register/', {
        method: 'POST',
        credentials: "include",   // ğŸ‘ˆ ì—¬ê¸°
        headers: { 'X-CSRFToken': csrftoken },
        body: formData
      });
      const data = await response.json();

      if (data.result === 'success') {
        alert(data.message || 'íšŒì›ê°€ì…ì´ ì™„ë£Œë˜ì—ˆìŠµë‹ˆë‹¤.');
        window.location.href = '/';
        // window.location.href = '/login/';
      } else {
        alert(data.message || 'íšŒì›ê°€ì… ì‹¤íŒ¨');
      }
    } catch (error) {
      alert('ì„œë²„ì™€ í†µì‹  ì¤‘ ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤.');
      // console.log(error)
    } finally {
      btn.disabled = false;
      btn.textContent = 'ê°€ì…í•˜ê¸°';
    }
  });

// ëª¨ë‹¬ ê´€ë ¨ ì´ë²¤íŠ¸
document.addEventListener("DOMContentLoaded", function () {
  ////////// Singup ì˜ì—­ ì‹œì‘
  // íšŒì›ê°€ì… ì˜ì—­
  const signup_base_closeBtn = document.getElementById("signup_base_modal_close");
  const signup_base_modal = document.getElementById("signup_base_modal");
  signup_base_closeBtn.addEventListener("click", function () {
      signup_base_modal.style.display = "none";
      document.getElementById("signup_email").value = '';
      document.getElementById("signup_password").value = '';
      document.getElementById("signup_password_confirm").value = '';
      document.getElementById("signup_submit").disabled = true;
      document.getElementById("signup_tenant").value = '';
      document.getElementById("signup_single").value = 'Fr';
      document.getElementById('agree_all').checked = false;
      document.getElementById('userinfoyn').checked = false;
      document.getElementById('termsofuseyn').checked = false;
      document.getElementById('marketingyn').checked = false;
  });

  const registerBtn = document.getElementById('register_submit');

  // ì•½ê´€ ê´€ë ¨ ì²´í¬
  const agreeAll = document.getElementById("agree_all");
  const userinfoyn = document.getElementById("userinfoyn");       // ê°œì¸ì •ë³´ìˆ˜ì§‘ë™ì˜ì—¬ë¶€ (í•„ìˆ˜)
  const termsofuseyn = document.getElementById("termsofuseyn");   // ì´ìš©ì•½ê´€ (í•„ìˆ˜)
  const marketingyn = document.getElementById("marketingyn");     // ë§ˆì¼€íŒ…ë™ì˜ì—¬ë¶€ (ì„ íƒ)

  agreeAll.addEventListener("change", function() {
    const checked = agreeAll.checked;
    userinfoyn.checked = checked;
    termsofuseyn.checked = checked;
    marketingyn.checked = checked;
  });

  // í•˜ìœ„ í•­ëª© í•´ì œë  ì‹œ ì „ì²´ë™ì˜ë„ í•´ì œ
  [userinfoyn, termsofuseyn, marketingyn].forEach(el => {
    el.addEventListener("change", function () {
      if (!userinfoyn.checked || !termsofuseyn.checked || !marketingyn.checked) {
        agreeAll.checked = false;
      } else if (userinfoyn.checked && termsofuseyn.checked && marketingyn.checked) {
        agreeAll.checked = true;
      }
    })
  })

  // íšŒì›ê°€ì… ë²„íŠ¼ í™œì„±í™”
  const signup_submitBtn = document.getElementById("signup_submit");
  const signup_usernm = document.getElementById("signup_usernm");
  const signup_email = document.getElementById("signup_email");
  const signup_password = document.getElementById("signup_password");
  const signup_password_confirm = document.getElementById("signup_password_confirm");

  function signup_validateForm() {
    const usernm_fill = signup_usernm.value.trim().length > 0;
    const email_fill = signup_email.value.trim().length > 0;
    const password_fill = signup_password.value.trim().length > 0;
    const password_confirm_fill = signup_password_confirm.value.trim().length > 0;
    const userinfoyn_fill = userinfoyn.checked;
    const termsofuseyn_fill = termsofuseyn.checked;

    const allValid = usernm_fill && email_fill && password_fill && password_confirm_fill && userinfoyn_fill && termsofuseyn_fill;

    signup_submitBtn.disabled = !allValid;
  }
  // íšŒì›ê°€ì… ì´ë²¤íŠ¸ ì—°ê²°
  signup_usernm.addEventListener("input", signup_validateForm);
  signup_email.addEventListener("input", signup_validateForm);
  signup_password.addEventListener("input", signup_validateForm);
  signup_password_confirm.addEventListener("input", signup_validateForm);
  userinfoyn.addEventListener("change", signup_validateForm);
  termsofuseyn.addEventListener("change", signup_validateForm);
  agreeAll.addEventListener("change", signup_validateForm);

  // íšŒì›ê°€ì… ì˜ì—­ -> ì´ë©”ì¼ ì…ë ¥ í›„ ì—”í„° â†’ ë¹„ë°€ë²ˆí˜¸ë¡œ í¬ì»¤ìŠ¤ ì´ë™
  signup_email.addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      signup_password.focus();
    }
  });

  // íšŒì›ê°€ì… ì˜ì—­ -> ë¹„ë°€ë²ˆí˜¸ ì…ë ¥ í›„ ì—”í„° â†’ ë¹„ë°€ë²ˆí˜¸_í™•ì¸ ìœ¼ë¡œ í¬ì»¤ìŠ¤ ì´ë™
  signup_password.addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      signup_password_confirm.focus();
    }
  });

  // íšŒì›ê°€ì… ì˜ì—­ -> ë¹„ë°€ë²ˆí˜¸_í™•ì¸ ì…ë ¥ í›„ ì—”í„° â†’ ë¡œê·¸ì¸ ë²„íŠ¼ í´ë¦­
  signup_password_confirm.addEventListener('keydown', function (e) {
    if (e.key === 'Enter') {
      e.preventDefault();
      if (!registerBtn.disabled) {
        registerBtn.click();
        }
    }
  });

  const radios = document.getElementsByName("billingmodelcd");

  radios.forEach(radio => {
    radio.addEventListener("change", () => {
      const tenant_selector = document.getElementById("tenant_selector")
      const single_selector = document.getElementById("single_selector")

      if (radio.value == "multi"){
        single_selector.style.display = 'none';
        tenant_selector.style.display = 'flex';
        document.getElementById('signup_tenant').value = "";
        document.getElementById('signup_single').value = "";
      } else {
        single_selector.style.display = 'flex';
        tenant_selector.style.display = 'none';
        document.getElementById('signup_tenant').value = "";
        document.getElementById('signup_single').value = "Fr";
      }
    })
  });


  ////////// Singup ì˜ì—­ ì¢…ë£Œ
});
</script>